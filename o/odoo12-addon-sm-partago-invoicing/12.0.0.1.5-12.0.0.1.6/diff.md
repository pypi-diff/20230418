# Comparing `tmp/odoo12_addon_sm_partago_invoicing-12.0.0.1.5-py2.py3-none-any.whl.zip` & `tmp/odoo12_addon_sm_partago_invoicing-12.0.0.1.6-py2.py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,48 +1,48 @@
-Zip file size: 48897 bytes, number of entries: 46
+Zip file size: 49200 bytes, number of entries: 46
 -rw-r--r--  2.0 unx       69 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_invoicing/__init__.py
--rw-r--r--  2.0 unx     1548 b- defN 23-Feb-22 09:27 odoo/addons/sm_partago_invoicing/__manifest__.py
+-rw-r--r--  2.0 unx     1548 b- defN 23-Apr-18 10:22 odoo/addons/sm_partago_invoicing/__manifest__.py
 -rw-r--r--  2.0 unx     1901 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_invoicing/email_tmpl/invoice_email.xml
 -rw-r--r--  2.0 unx     3331 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_invoicing/email_tmpl/invoice_report.xml
 -rw-r--r--  2.0 unx     2052 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_invoicing/email_tmpl/sale_order.xml
 -rw-r--r--  2.0 unx      524 b- defN 23-Feb-15 12:30 odoo/addons/sm_partago_invoicing/models/__init__.py
--rw-r--r--  2.0 unx       92 b- defN 23-Feb-15 15:43 odoo/addons/sm_partago_invoicing/models/batch_type_enum.py
--rw-r--r--  2.0 unx     2606 b- defN 23-Feb-15 15:43 odoo/addons/sm_partago_invoicing/models/models_reservation_calculator.py
--rw-r--r--  2.0 unx     1890 b- defN 23-Feb-15 15:43 odoo/addons/sm_partago_invoicing/models/models_sm_company.py
--rw-r--r--  2.0 unx     4035 b- defN 23-Feb-15 15:43 odoo/addons/sm_partago_invoicing/models/models_sm_invoice.py
--rw-r--r--  2.0 unx     1566 b- defN 23-Feb-15 15:43 odoo/addons/sm_partago_invoicing/models/models_sm_invoice_line.py
--rw-r--r--  2.0 unx    25326 b- defN 23-Feb-15 15:43 odoo/addons/sm_partago_invoicing/models/models_sm_invoice_report.py
--rw-r--r--  2.0 unx      949 b- defN 23-Feb-15 15:43 odoo/addons/sm_partago_invoicing/models/models_sm_invoice_report_wizard.py
--rw-r--r--  2.0 unx      290 b- defN 23-Feb-15 15:43 odoo/addons/sm_partago_invoicing/models/models_sm_member.py
--rw-r--r--  2.0 unx     2821 b- defN 23-Feb-15 15:43 odoo/addons/sm_partago_invoicing/models/models_sm_res_config_settings.py
--rw-r--r--  2.0 unx    13761 b- defN 23-Feb-15 15:43 odoo/addons/sm_partago_invoicing/models/models_smp_batch_reservation_compute.py
--rw-r--r--  2.0 unx     8784 b- defN 23-Feb-15 15:43 odoo/addons/sm_partago_invoicing/models/models_smp_batch_reservation_compute_wizard.py
--rw-r--r--  2.0 unx     3491 b- defN 23-Feb-15 15:43 odoo/addons/sm_partago_invoicing/models/models_smp_report_reservation_compute.py
--rw-r--r--  2.0 unx    22954 b- defN 23-Feb-15 15:43 odoo/addons/sm_partago_invoicing/models/models_smp_reservation_compute.py
--rw-r--r--  2.0 unx      754 b- defN 23-Feb-15 15:43 odoo/addons/sm_partago_invoicing/models/models_smp_teletac.py
+-rw-r--r--  2.0 unx       92 b- defN 23-Mar-17 16:31 odoo/addons/sm_partago_invoicing/models/batch_type_enum.py
+-rw-r--r--  2.0 unx     2606 b- defN 23-Mar-17 16:31 odoo/addons/sm_partago_invoicing/models/models_reservation_calculator.py
+-rw-r--r--  2.0 unx     1890 b- defN 23-Mar-17 16:31 odoo/addons/sm_partago_invoicing/models/models_sm_company.py
+-rw-r--r--  2.0 unx     4035 b- defN 23-Mar-17 16:31 odoo/addons/sm_partago_invoicing/models/models_sm_invoice.py
+-rw-r--r--  2.0 unx     2069 b- defN 23-Apr-18 10:04 odoo/addons/sm_partago_invoicing/models/models_sm_invoice_line.py
+-rw-r--r--  2.0 unx    26368 b- defN 23-Apr-18 10:04 odoo/addons/sm_partago_invoicing/models/models_sm_invoice_report.py
+-rw-r--r--  2.0 unx      949 b- defN 23-Mar-17 16:31 odoo/addons/sm_partago_invoicing/models/models_sm_invoice_report_wizard.py
+-rw-r--r--  2.0 unx      290 b- defN 23-Mar-17 16:31 odoo/addons/sm_partago_invoicing/models/models_sm_member.py
+-rw-r--r--  2.0 unx     2821 b- defN 23-Mar-17 16:31 odoo/addons/sm_partago_invoicing/models/models_sm_res_config_settings.py
+-rw-r--r--  2.0 unx    13107 b- defN 23-Apr-18 10:04 odoo/addons/sm_partago_invoicing/models/models_smp_batch_reservation_compute.py
+-rw-r--r--  2.0 unx     8784 b- defN 23-Mar-17 16:31 odoo/addons/sm_partago_invoicing/models/models_smp_batch_reservation_compute_wizard.py
+-rw-r--r--  2.0 unx     3491 b- defN 23-Mar-17 16:31 odoo/addons/sm_partago_invoicing/models/models_smp_report_reservation_compute.py
+-rw-r--r--  2.0 unx    24096 b- defN 23-Apr-18 10:04 odoo/addons/sm_partago_invoicing/models/models_smp_reservation_compute.py
+-rw-r--r--  2.0 unx      754 b- defN 23-Mar-17 16:31 odoo/addons/sm_partago_invoicing/models/models_smp_teletac.py
 -rw-r--r--  2.0 unx     1360 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_invoicing/report/contact.xml
 -rw-r--r--  2.0 unx    16634 b- defN 23-Feb-06 17:17 odoo/addons/sm_partago_invoicing/report/invoice_report.xml
--rw-r--r--  2.0 unx    20122 b- defN 23-Feb-15 15:08 odoo/addons/sm_partago_invoicing/report/sm_invoice_report.xml
+-rw-r--r--  2.0 unx    20123 b- defN 23-Apr-18 10:04 odoo/addons/sm_partago_invoicing/report/sm_invoice_report.xml
 -rw-r--r--  2.0 unx      633 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_invoicing/security/ir.model.access.csv
 -rw-r--r--  2.0 unx       65 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_invoicing/services/__init__.py
 -rw-r--r--  2.0 unx     4004 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_invoicing/services/invoice_services.py
 -rw-r--r--  2.0 unx     3527 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_invoicing/services/report_services.py
 -rw-r--r--  2.0 unx      927 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_invoicing/static/src/js/base.js
 -rw-r--r--  2.0 unx      615 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_invoicing/static/src/xml/base.xml
 -rw-r--r--  2.0 unx      403 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_invoicing/views/views.xml
--rw-r--r--  2.0 unx     5548 b- defN 23-Feb-15 15:08 odoo/addons/sm_partago_invoicing/views/views_batch_reservation_compute.xml
+-rw-r--r--  2.0 unx     5830 b- defN 23-Apr-18 10:04 odoo/addons/sm_partago_invoicing/views/views_batch_reservation_compute.xml
 -rw-r--r--  2.0 unx     1539 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_invoicing/views/views_batch_reservation_compute_wizard.xml
 -rw-r--r--  2.0 unx     1023 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_invoicing/views/views_extra_expense.xml
--rw-r--r--  2.0 unx     2832 b- defN 23-Feb-15 15:08 odoo/addons/sm_partago_invoicing/views/views_invoice_line.xml
--rw-r--r--  2.0 unx     5267 b- defN 23-Feb-15 15:08 odoo/addons/sm_partago_invoicing/views/views_invoice_report.xml
+-rw-r--r--  2.0 unx     2948 b- defN 23-Apr-18 10:04 odoo/addons/sm_partago_invoicing/views/views_invoice_line.xml
+-rw-r--r--  2.0 unx     5608 b- defN 23-Apr-18 10:04 odoo/addons/sm_partago_invoicing/views/views_invoice_report.xml
 -rw-r--r--  2.0 unx     1246 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_invoicing/views/views_invoice_report_wizard.xml
 -rw-r--r--  2.0 unx     1612 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_invoicing/views/views_invoices.xml
 -rw-r--r--  2.0 unx      602 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_invoicing/views/views_members.xml
 -rw-r--r--  2.0 unx     1350 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_invoicing/views/views_report_reservation_compute.xml
 -rw-r--r--  2.0 unx     2123 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_invoicing/views/views_res_config_settings.xml
--rw-r--r--  2.0 unx     5062 b- defN 23-Feb-22 09:21 odoo/addons/sm_partago_invoicing/views/views_reservation_compute.xml
+-rw-r--r--  2.0 unx     5062 b- defN 23-Mar-17 16:31 odoo/addons/sm_partago_invoicing/views/views_reservation_compute.xml
 -rw-r--r--  2.0 unx      965 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_invoicing/views/views_teletacs.xml
--rw-r--r--  2.0 unx      725 b- defN 23-Feb-22 09:34 odoo12_addon_sm_partago_invoicing-12.0.0.1.5.dist-info/METADATA
--rw-r--r--  2.0 unx      110 b- defN 23-Feb-22 09:34 odoo12_addon_sm_partago_invoicing-12.0.0.1.5.dist-info/WHEEL
--rw-r--r--  2.0 unx        5 b- defN 23-Feb-22 09:34 odoo12_addon_sm_partago_invoicing-12.0.0.1.5.dist-info/top_level.txt
-?rw-rw-r--  2.0 unx     5449 b- defN 23-Feb-22 09:34 odoo12_addon_sm_partago_invoicing-12.0.0.1.5.dist-info/RECORD
-46 files, 182492 bytes uncompressed, 39585 bytes compressed:  78.3%
+-rw-r--r--  2.0 unx      681 b- defN 23-Apr-18 10:25 odoo12_addon_sm_partago_invoicing-12.0.0.1.6.dist-info/METADATA
+-rw-r--r--  2.0 unx      110 b- defN 23-Apr-18 10:25 odoo12_addon_sm_partago_invoicing-12.0.0.1.6.dist-info/WHEEL
+-rw-r--r--  2.0 unx        5 b- defN 23-Apr-18 10:25 odoo12_addon_sm_partago_invoicing-12.0.0.1.6.dist-info/top_level.txt
+?rw-rw-r--  2.0 unx     5449 b- defN 23-Apr-18 10:25 odoo12_addon_sm_partago_invoicing-12.0.0.1.6.dist-info/RECORD
+46 files, 185221 bytes uncompressed, 39888 bytes compressed:  78.5%
```

## zipnote {}

```diff
@@ -120,20 +120,20 @@
 
 Filename: odoo/addons/sm_partago_invoicing/views/views_reservation_compute.xml
 Comment: 
 
 Filename: odoo/addons/sm_partago_invoicing/views/views_teletacs.xml
 Comment: 
 
-Filename: odoo12_addon_sm_partago_invoicing-12.0.0.1.5.dist-info/METADATA
+Filename: odoo12_addon_sm_partago_invoicing-12.0.0.1.6.dist-info/METADATA
 Comment: 
 
-Filename: odoo12_addon_sm_partago_invoicing-12.0.0.1.5.dist-info/WHEEL
+Filename: odoo12_addon_sm_partago_invoicing-12.0.0.1.6.dist-info/WHEEL
 Comment: 
 
-Filename: odoo12_addon_sm_partago_invoicing-12.0.0.1.5.dist-info/top_level.txt
+Filename: odoo12_addon_sm_partago_invoicing-12.0.0.1.6.dist-info/top_level.txt
 Comment: 
 
-Filename: odoo12_addon_sm_partago_invoicing-12.0.0.1.5.dist-info/RECORD
+Filename: odoo12_addon_sm_partago_invoicing-12.0.0.1.6.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## odoo/addons/sm_partago_invoicing/__manifest__.py

```diff
@@ -5,15 +5,15 @@
     'summary': """
     Module to modify invoices and cs reports for the user""",
 
     'author': "Som Mobilitat",
     'website': "http://www.sommobilitat.coop",
 
     'category': 'vertical-carsharing',
-    'version': '12.0.0.1.5',
+    'version': '12.0.0.1.6',
 
     # any module necessary for this one to work correctly
     'depends': [
         'base',
         'mail',
         'web',
         'account',
```

## odoo/addons/sm_partago_invoicing/models/models_sm_invoice_line.py

```diff
@@ -10,40 +10,58 @@
 
     related_tariff_id = fields.Many2one(
         'smp.sm_carsharing_tariff',
         string=_("Related tariff")
     )
     related_reservation_compute_id = fields.Many2one(
         'smp.sm_reservation_compute',
-        string=_("Related reservaion compute")
+        string=_("Related reservation compute")
     )
     invoice_report_id = fields.Many2one(
         'sm.invoice_report',
         string=_("Related invoice report")
     )
     partner_id = fields.Many2one(
         'res.partner',
-        string=_("Partner")
+        string=_("Related partner (inv_report)")
     )
     initial_price_computed = fields.Float(
         string=_("Initial price"),
         compute="_get_line_initial_price",
         store=False
     )
     line_type = fields.Selection([
         ('default', 'Default'),
         ('cs_default', 'Carsharing default'),
         ('cs_extra', 'Carsharing extra time'),
         ('cs_teletac', 'Teletac'),
-        ('cs_discount', 'Discount')
-    ], string=_("Line type"), default="default")
+        ('cs_discount', 'Discount'),
+        ('cs_penalty', 'Penalty')],
+        string=_("Line type"),
+        default="default"
+    )
+    penalty_type = fields.Selection([
+        ('none', 'None'),
+        ('general', 'General'),
+        ('unused', 'Unused'),
+        ('cancelled', 'Cancelled')],
+        string=_("Penalty type"),
+        default="none"
+    )
+    parent_invoice_line_id = fields.Many2one(
+        'account.invoice.line',
+        string=_("Parent invoice line (penalties)")
+    )
 
     @api.depends('related_reservation_compute_id')
     def _get_line_initial_price(self):
         for record in self:
             record.initial_price_computed = 0
-            if record.related_reservation_compute_id.id != False:
-                if record.related_reservation_compute_id.carconfig_id.id != False:
+            if record.related_reservation_compute_id.id is not False:
+                if (
+                    record.related_reservation_compute_id.carconfig_id.id is not
+                    False
+                ):
                     record.initial_price_computed = record.related_reservation_compute_id.cs_carconfig_id.initial_price
 
 
 smp_invoice_line()
```

## odoo/addons/sm_partago_invoicing/models/models_sm_invoice_report.py

```diff
@@ -28,22 +28,24 @@
         string=_("Pocketbook state final (taxed)"))
     total_amount_lines_untaxed = fields.Float(
         string=_("Total in lines (untaxed)"),
         compute="_get_total_amount_lines_untaxed"
     )
     discount_amount_subtotal = fields.Float(
         string=_("Discount amount (untaxed)"),
-        compute="_get_discount_amount_subtotal")
+        compute="_get_discount_amount_subtotal"
+    )
     total_mileage = fields.Float(
         string=_("Total mileage"),
         compute="_get_total_mileage"
     )
     ir_total_amount_signed = fields.Float(
         string=_("Amount to pay (untaxed)(signed)"),
-        compute="_get_total_amount_signed")
+        compute="_get_total_amount_signed"
+    )
     invoice_id = fields.Many2one(
         'account.invoice',
         string=_("Related Invoice")
     )
     date = fields.Date(string=_("Date"))
     company_id = fields.Many2one('res.company', string=_('Company'))
     grouped_report = fields.Boolean(string=_("Is a grouped report?"))
@@ -62,14 +64,20 @@
         string=_("Related batch reservation (grouped)")
     )
     related_report_reservation_ids = fields.One2many(
         comodel_name='smp.sm_report_reservation_compute',
         inverse_name='invoice_report_id',
         string=_("Related report reservation (single)")
     )
+    batch_reservation_id = fields.Many2one(
+        comodel_name='smp.sm_batch_reservation_compute',
+        string=_("Related batch reservation"),
+        compute="_get_batch_reservation_id",
+        store=False
+    )
     total_amount_in_invoice = fields.Float(
         string=_('Total amount on invoice'),
         compute="_get_total_amount_in_invoice"
     )
     total_taxes_in_invoice = fields.Float(
         string=_('Total taxes on invoice'),
         compute="_get_total_taxes_in_invoice"
@@ -88,17 +96,15 @@
         store=False
     )
     show_payment_info = fields.Boolean(
         string=_("Show payment info?"),
         compute="_show_payment_info",
         store=False
     )
-    initial_price = fields.Float(
-        string=_("Initial price (deprecated)")
-    )
+    initial_price = fields.Float(string=_("Initial price (deprecated)"))
     total_amount_lines_taxed_no_initial = fields.Float(
         string=_("Total in lines (taxed) sense preu inicial (deprecated)"))
     total_amount_lines_taxed = fields.Float(
         string=_("Total in lines (taxed) (deprecated)"))
     fixed_amount_topay = fields.Float(
         string=_("Minimum fixed amount to pay (deprecated)"))
     afterfee_pocketbook = fields.Float(
@@ -107,14 +113,26 @@
         string=_("Pocketbook discount (deprecated)"))
     total_amount = fields.Float(string=_("Amount to pay (deprecated)"))
     total_amount_signed = fields.Float(
         string=_("Amount to pay (signed) (deprecated)"))
 
     _order = "create_date desc"
 
+    @api.depends('related_batch_reservation_ids', 'related_report_reservation_ids')
+    def _get_batch_reservation_id(self):
+        for record in self:
+            if record.related_batch_reservation_ids:
+                record.batch_reservation_id = \
+                    record.related_batch_reservation_ids[0].id
+            elif record.related_report_reservation_ids:
+                record.batch_reservation_id = \
+                    record.related_report_reservation_ids[
+                        0
+                    ].batch_reservation_compute_id.id
+
     @api.depends('invoice_id')
     def _get_total_amount_in_invoice(self):
         for record in self:
             if record.invoice_id:
                 record.total_amount_in_invoice = record.invoice_id.amount_total
 
     @api.depends('invoice_id')
@@ -125,15 +143,23 @@
 
     @api.depends('cs_line_ids')
     def _get_total_amount_lines_untaxed(self):
         for record in self:
             amount = 0
             if record.cs_line_ids.exists():
                 for line in record.cs_line_ids:
-                    if line.line_type == 'cs_default' or line.line_type == 'cs_extra' or line.line_type == 'cs_teletac':
+                    if (
+                            line.line_type in
+                            [
+                                'cs_default',
+                                'cs_extra',
+                                'cs_teletac',
+                                'cs_penalty'
+                            ]
+                    ):
                         amount += line.price_subtotal_signed
             record.total_amount_lines_untaxed = amount
 
     @api.depends('cs_line_ids')
     def _get_discount_amount_subtotal(self):
         for record in self:
             discount = 0
@@ -145,16 +171,20 @@
 
     @api.depends('cs_line_ids')
     def _get_total_mileage(self):
         for record in self:
             mileage = 0
             if record.cs_line_ids.exists():
                 for line in record.cs_line_ids:
-                    if line.line_type == 'cs_default' and line.related_reservation_compute_id.id != False:
-                        mileage += line.related_reservation_compute_id.used_mileage
+                    if (
+                            line.line_type == 'cs_default' and
+                            line.related_reservation_compute_id.id is not False
+                    ):
+                        mileage += \
+                            line.related_reservation_compute_id.used_mileage
             record.total_mileage = mileage
 
     @api.depends('cs_line_ids')
     def _get_total_amount_signed(self):
         for record in self:
             amount = 0
             if record.cs_line_ids.exists():
@@ -164,15 +194,18 @@
 
     @api.depends('cs_line_ids')
     def _has_cs_usage(self):
         for record in self:
             has_cs_usage = False
             if record.cs_line_ids.exists():
                 for line in record.cs_line_ids:
-                    if line.line_type == 'cs_default' or line.line_type == 'cs_extra':
+                    if (
+                        line.line_type == 'cs_default' or
+                        line.line_type == 'cs_extra'
+                    ):
                         has_cs_usage = True
             record.has_cs_usage = has_cs_usage
 
     @api.depends('cs_line_ids')
     def _has_teletac_lines(self):
         for record in self:
             has_teletacs = False
@@ -181,74 +214,88 @@
                     if line.line_type == 'cs_teletac':
                         has_teletacs = True
             record.has_teletacs = has_teletacs
 
     def assign_previous_pocketbook(self):
         self.write({
             'previous_pocketbook': self.partner_id.pocketbook_records_total,
-            'previous_pocketbook_taxed': self.partner_id.pocketbook_records_total_taxed
+            'previous_pocketbook_taxed':
+                self.partner_id.pocketbook_records_total_taxed
         })
 
     @api.model
     def prepapre_predetermined_tariff(self):
         company = self.env.user.company_id
         self.predetermined_tariff = company.default_tariff_model_id.name
-        self.predetermined_tariff_description = company.default_tariff_model_id.description
+        self.predetermined_tariff_description = \
+            company.default_tariff_model_id.description
 
     @api.model
     def _show_payment_info(self):
         self.show_payment_info = False
-        batch_reservation = self.env['smp.sm_batch_reservation_compute'].search(
-            [('invoice_report_id', '=', self.id)])
+        batch_reservation = self.env[
+            'smp.sm_batch_reservation_compute'
+        ].search([
+            ('invoice_report_id', '=', self.id)
+        ])
         if batch_reservation.exists():
             self.show_payment_info = True
         else:
-            report_reservation_computes = self.env['smp.sm_report_reservation_compute'].search(
-                [('invoice_report_id', '=', self.id)])
+            report_reservation_computes = self.env[
+                'smp.sm_report_reservation_compute'
+            ].search([
+                ('invoice_report_id', '=', self.id)
+            ])
             if report_reservation_computes.exists():
-                if not report_reservation_computes[0].batch_reservation_compute_id.invoice_report_id.id:
+                if (
+                    not report_reservation_computes[0].batch_reservation_compute_id.invoice_report_id.id
+                ):
                     self.show_payment_info = True
 
     def create_discount_lines(self):
         company = self.env.user.company_id
         discount_product = company.cs_discount_product_id
         default_line_account = discount_product.property_account_income_id
         taxes_l = []
         # total_amount_taxed = self.total_amount_lines_taxed
         total_amount_untaxed = self.total_amount_lines_untaxed
 
         if discount_product.taxes_id.exists():
             for tax in discount_product.taxes_id:
                 taxes_l.append((4, tax.id))
 
-        pb_records = self.env['pocketbook.pocketbook_record'].search(
-            [('amount', '>', '0'), ('related_member_id', '=', self.partner_id.id)])
+        pb_records = self.env['pocketbook.pocketbook_record'].search([
+            ('amount', '>', '0'),
+            ('related_member_id', '=', self.partner_id.id)
+        ])
         if pb_records.exists():
             for pb_record in pb_records:
                 invoice_line_name = _("Descompte: ") + pb_record.name
-                if pb_record.related_account_id.id != False:
+                if pb_record.related_account_id.id is not False:
                     line_account = pb_record.related_account_id
                 else:
                     line_account = default_line_account
                 if pb_record.amount >= total_amount_untaxed:
-                    # create discount amount for total_amount_lines_untaxed and break
+                    # create discount amount for total_amount_lines_untaxed
                     descompte_line = self.env['account.invoice.line'].create({
                         'name': invoice_line_name,
                         'invoice_report_id': self.id,
                         'product_id': discount_product.id,
                         'price_unit': -1 * total_amount_untaxed,
                         'quantity': 1,
                         'discount': 0,
                         'account_id': line_account.id,
                         'account_analytic_id': pb_record.related_analytic_account_id.id,
                         'line_type': 'cs_discount',
                         'partner_id': self.partner_id.id
                     })
                     descompte_line.invoice_line_tax_ids = taxes_l
-                    pb_record_history = self.env['pocketbook.pocketbook_record_history'].create({
+                    self.env[
+                        'pocketbook.pocketbook_record_history'
+                    ].create({
                         'name': 'Report: '+self.name,
                         'date': datetime.now(),
                         'amount': -1 * total_amount_untaxed,
                         'related_invoice_line_id': descompte_line.id,
                         'related_pb_record_id': pb_record.id
                     })
                     break
@@ -265,59 +312,55 @@
                         'account_analytic_id': pb_record.related_analytic_account_id.id,
                         'line_type': 'cs_discount',
                         'partner_id': self.partner_id.id
                     })
                     descompte_line.invoice_line_tax_ids = taxes_l
                     total_amount_untaxed = total_amount_untaxed + \
                         descompte_line.price_subtotal_signed
-                    # total_amount_taxed = total_amount_taxed - descompte_line.price_unit - descompte_line.tax_par_line
-                    pb_record_history = self.env['pocketbook.pocketbook_record_history'].create({
+                    self.env[
+                        'pocketbook.pocketbook_record_history'
+                    ].create({
                         'name': 'Report: ' + self.name,
                         'date': datetime.now(),
                         'amount': -1 * pb_record.amount,
                         'related_invoice_line_id': descompte_line.id,
                         'related_pb_record_id': pb_record.id
                     })
 
     def create_related_invoice(self, batch_type=False):
         company = self.env.user.company_id
-
-        # TODO: This could be done better? a map somewhere
-        # setup invoice template based on batch_type
         invoice_template = 'default'
         if batch_type:
             if batch_type == 'usage':
                 invoice_template = 'cs_default'
             if batch_type == 'teletac':
                 invoice_template = 'cs_teletac'
-
         invoice_vals = {
             'partner_id': self.partner_id.id,
             'amount_tax': 5,
             'company_id': 1,
             'state': 'draft',
             'type': 'out_invoice',
             'journal_id': company.cs_invoice_journal_id.id,
             'invoice_email_sent': False,
             'invoice_report_id': self.id,
             'invoice_template': invoice_template
-            # 'is_sm_invoice': True
         }
-        # Assign payment mode only if the partner has at least one valid mandate #
+        # Assign payment mode only
+        # if the partner has at least one valid mandate
         mandates = self.env['account.banking.mandate'].search(
             [('partner_id', '=', self.partner_id.id), ('state', '=', 'valid')])
         if mandates.exists():
-            invoice_vals['payment_mode_id'] = company.cs_invoice_payment_mode_id.id
+            invoice_vals['payment_mode_id'] = \
+                company.cs_invoice_payment_mode_id.id
 
         invoice = self.env['account.invoice'].create(invoice_vals)
 
         if self.cs_line_ids.exists():
             for rep_line in self.cs_line_ids:
-                inv_line = rep_line.copy(
-                    {'invoice_report_id': False, 'invoice_id': invoice.id})
                 if rep_line.line_type == 'cs_teletac':
                     if rep_line.related_reservation_compute_id.id:
                         query = [
                             ('reservation_compute_id', '=',
                              rep_line.related_reservation_compute_id.id)
                         ]
                         teletacs = self.env['smp.sm_teletac'].search(query)
@@ -328,21 +371,22 @@
         invoice.compute_taxes()
         self.update_pocketbook_finals()
         self.write({
             'invoice_id': invoice.id
         })
 
     def validate_related_invoice(self):
-        if self.invoice_id.id != False:
+        if self.invoice_id.id is not False:
             self.invoice_id.action_invoice_open()
 
     def update_pocketbook_finals(self):
         self.write({
             'final_pocketbook': self.partner_id.pocketbook_records_total,
-            'final_pocketbook_taxed': self.partner_id.pocketbook_records_total_taxed
+            'final_pocketbook_taxed':
+                self.partner_id.pocketbook_records_total_taxed
         })
 
     @api.multi
     def action_report_sent(self):
         self.ensure_one()
         self.send_carsharing_report_email()
 
@@ -354,53 +398,66 @@
         email_template = company.invoice_report_mail_template_id
 
         if email_template.id:
             email_values = {'send_from_code': True}
             email_template.with_context(
                 email_values).send_mail(record.id, True)
 
-    def compute_report_lines(self, compute_pb, type_of_batch_to_compute):
-        batch_reservation = self.env['smp.sm_batch_reservation_compute'].search(
-            [('invoice_report_id', '=', self.id)])
+    def account_report_lines(self):
+        for inv_report_line in self.cs_line_ids:
+            self.partner_id.update_member_tariff_by_invoice_line(
+                inv_report_line)
+
+    def set_to_zero_cancelled_unused_inv_lines(self):
+        for inv_report_line in self.cs_line_ids:
+            if inv_report_line.penalty_type in ['unused', 'cancelled']:
+                inv_report_line.parent_invoice_line_id.write({
+                    'price_unit': 0
+                })
 
+    def compute_report_lines(self, type_of_batch_to_compute):
+        batch_reservation = self.env[
+            'smp.sm_batch_reservation_compute'
+        ].search(
+            [('invoice_report_id', '=', self.id)]
+        )
         if BatchType.USAGES.value in type_of_batch_to_compute:
             if batch_reservation:
                 if batch_reservation.reports_id.exists():
                     for report in batch_reservation.reports_id:
                         for compute in report.reservation_computes_id:
-                            self.generate_invoice_report_line(
-                                compute, compute_pb)
+                            self.generate_invoice_report_line(compute)
             else:
-                report_reservation_compute = self.env['smp.sm_report_reservation_compute'].search([
+                report_reservation_compute = self.env[
+                    'smp.sm_report_reservation_compute'
+                ].search([
                     ('invoice_report_id', '=', self.id)
                 ])
-
                 if report_reservation_compute:
                     for compute in report_reservation_compute:
                         for x in compute.reservation_computes_id:
-                            self.generate_invoice_report_line(x, compute_pb)
-
+                            self.generate_invoice_report_line(x)
         if BatchType.TELETAC.value in type_of_batch_to_compute:
-            # Don't update pocketbook tariff when applies to teletac
-            compute_teletacs_pb = False
             if batch_reservation:
                 if batch_reservation.reports_id.exists():
                     for report in batch_reservation.reports_id:
                         self.generate_teletac_lines(
-                            compute_pb=compute_teletacs_pb, rel_teletacs=report.teletacs_compute_id)
+                            rel_teletacs=report.teletacs_compute_id)
             else:
-                report_reservation_compute = self.env['smp.sm_report_reservation_compute'].search(
-                    [('invoice_report_id', '=', self.id)])
-
+                report_reservation_compute = self.env[
+                    'smp.sm_report_reservation_compute'
+                ].search([
+                    ('invoice_report_id', '=', self.id)
+                ])
                 if report_reservation_compute:
                     for compute in report_reservation_compute:
                         self.generate_teletac_lines(
-                            compute_pb=compute_teletacs_pb, rel_teletacs=compute.teletacs_compute_id)
+                            rel_teletacs=compute.teletacs_compute_id)
 
-    def generate_invoice_report_line(self, compute, compute_pb):
+    def generate_invoice_report_line(self, compute):
         company = self.env.user.company_id
         invoice_report = self
         cs_product = company.cs_carsharing_product_id
 
         if cs_product.id:
             line_member = compute.member_id
             member = invoice_report.partner_id
@@ -414,26 +471,33 @@
 
             tariff = member.get_current_tariff(compute.carconfig_id)
 
             # computing invoice vals for compute
             compute.compute_report_invoice_vals(tariff)
 
             if tariff['tariff_aval']:
-                quantity_time = compute.compute_invoice_report_tariff_time_quantities(
-                    tariff['tariff_model_id'])
-                quantity_tariff_extra = compute.compute_invoice_report_nontariff_time_quantities(
-                    tariff['extra_tariff_model_id'])
+                quantity_time = \
+                    compute.compute_invoice_report_tariff_time_quantities(
+                        tariff['tariff_model_id']
+                    )
+                quantity_tariff_extra = \
+                    compute.compute_invoice_report_nontariff_time_quantities(
+                        tariff['extra_tariff_model_id']
+                    )
             else:
-                quantity_time = compute.compute_invoice_report_nontariff_time_quantities(
-                    tariff['tariff_model_id'])
+                quantity_time = \
+                    compute.compute_invoice_report_nontariff_time_quantities(
+                        tariff['tariff_model_id']
+                    )
                 quantity_tariff_extra = 0
 
             line_quantity = quantity_time + \
                 compute.compute_invoice_report_km_quantities(
-                    tariff['tariff_model_id'])
+                    tariff['tariff_model_id']
+                )
 
             # calculate invoice line name
             invoice_line_name = ''
             if compute:
                 invoice_line_name = compute.name_nice
 
             query = [
@@ -453,28 +517,26 @@
                 'account_analytic_id': line_analytic_account.id,
                 'related_reservation_compute_id': compute.id,
                 'line_type': 'cs_default'
                 # 'line_tariff_type': tariff['tariff_model_type']
             }
 
             if compute.cs_carconfig_id:
-                line_quantity = line_quantity + compute.cs_carconfig_id.initial_price
+                line_quantity = \
+                    line_quantity + compute.cs_carconfig_id.initial_price
 
             invoice_line = sm_utils.get_create_existing_model(
                 self.env['account.invoice.line'], query, creation_data)
 
             invoice_line.write({
                 'partner_id': line_member.id,
                 'related_tariff_id': tariff['tariff_id'],
                 'price_unit': line_quantity
             })
 
-            member.update_member_tariff_by_invoice_line(
-                invoice_line, compute_pb)
-
             # adding taxes that apply
             invoice_line.invoice_line_tax_ids = taxes_l
 
             if quantity_tariff_extra != 0:
                 invoice_line_name = "Temps extra: " + invoice_line_name
 
                 query = [
@@ -492,39 +554,38 @@
                     'discount': 0,
                     'account_id': line_account.id,
                     'account_analytic_id': line_analytic_account.id,
                     'related_reservation_compute_id': compute.id,
                     'line_type': 'cs_extra',
                     # 'line_tariff_type': tariff['tariff_model_type']
                 }
-                invoice_line_extra = sm_utils.get_create_existing_model(self.env['account.invoice.line'], query,
-                                                                        creation_data)
-
+                invoice_line_extra = sm_utils.get_create_existing_model(
+                    self.env['account.invoice.line'],
+                    query,
+                    creation_data
+                )
                 invoice_line_extra.write({
                     'partner_id': line_member.id,
                     'related_tariff_id': tariff['tariff_id'],
                     'price_unit': quantity_tariff_extra
                 })
-                member.update_member_tariff_by_invoice_line(
-                    invoice_line_extra, compute_pb)
-
                 # adding taxes that apply
                 invoice_line_extra.invoice_line_tax_ids = taxes_l
 
             return invoice_line
         return False
 
-    def generate_teletac_lines(self, compute_pb, rel_teletacs):
+    def generate_teletac_lines(self, rel_teletacs):
         # check if there is viat related products
         company = self.env.user.company_id
         teletac_p = company.cs_teletac_product_id
-
-        # rel_teletacs = self.env['smp.sm_teletac'].search([('reservation_compute_id', '=', compute.id)])
-
-        if teletac_p.id != False and rel_teletacs.exists():
+        if (
+            teletac_p.id is not False and
+            rel_teletacs.exists()
+        ):
             taxes_l = []
             if teletac_p.taxes_id.exists():
                 for tax in teletac_p.taxes_id:
                     taxes_l.append((4, tax.id))
             for rel_teletac in rel_teletacs:
                 if rel_teletac.id:
                     line_analytic_account = rel_teletac.get_analytic_account()
@@ -550,23 +611,23 @@
                             'account_id': teletac_p.property_account_income_id.id,
                             'account_analytic_id': line_analytic_account.id,
                             'related_reservation_compute_id': rel_teletac.reservation_compute_id.id,
                             'partner_id': rel_teletac.related_member_id.id,
                             'line_type': 'cs_teletac'
                         }
 
-                        teletac_line = sm_utils.get_create_existing_model(model_env=self.env['account.invoice.line'],
-                                                                          query=query,
-                                                                          creation_data=creation_data)
+                        teletac_line = sm_utils.get_create_existing_model(
+                            model_env=self.env['account.invoice.line'],
+                            query=query,
+                            creation_data=creation_data
+                        )
 
-                        # TO-DO: need to investigate why can't we pass this on line creation (previous function)
+                        # TODO: need to investigate why can't we pass this on line creation
                         teletac_line.write({
                             'partner_id': rel_teletac.related_member_id.id
                         })
 
                         teletac_line.invoice_line_tax_ids = taxes_l
 
                         rel_teletac.sudo().write({
                             'invoice_report_id': self.id
                         })
-                        # we don't update member tariff for teletacs lines
-                        # self.partner_id.update_member_tariff_by_invoice_line(teletac_line, compute_pb)
```

## odoo/addons/sm_partago_invoicing/models/models_smp_batch_reservation_compute.py

```diff
@@ -9,40 +9,42 @@
 from odoo.addons.sm_maintenance.models.models_sm_utils import sm_utils
 from odoo.addons.sm_partago_invoicing.models.batch_type_enum import BatchType
 
 
 class smp_batch_reservation_compute(models.Model):
     _name = 'smp.sm_batch_reservation_compute'
 
-    # batch_type = fields.Char(string=_("Batch type"))
     batch_type = fields.Selection([
         ('usage', 'Usage'),
-        ('teletac', 'Teletac')
-    ], string=_("Batch type"), default="usage")
+        ('teletac', 'Teletac')],
+        string=_("Batch type"),
+        default="usage"
+    )
     name = fields.Char(string=_("Name"), required=True)
     description = fields.Char(string=_("Description"))
     reports_id = fields.One2many(
         comodel_name='smp.sm_report_reservation_compute',
         inverse_name='batch_reservation_compute_id',
         string=_("Reports")
     )
     state = fields.Selection([
         ('invoice_report', 'Inv report'),
-        # ('test_cepa', 'test SEPA'),
+        ('modify_penalty_ratings', 'Modify penalty ratings'),
         ('account_invoices_report', 'Account invoice report'),
         ('apply_discounts', 'Apply discounts'),
         ('generate_invoices', 'Generate invoices'),
         ('validate_invoices', 'Validate invoices'),
-        # ('update_totals', 'Update totals'),
-        # ('create_cepa', 'create SEPA'),
         ('closed', 'Closed'),
-        ('closed_sent', 'SEPA sent'),
-    ], default='invoice_report')
+        ('closed_sent', 'SEPA sent')],
+        default='invoice_report'
+    )
     invoice_report_id = fields.Many2one(
-        'sm.invoice_report', string=_("Invoice Report"))
+        'sm.invoice_report',
+        string=_("Invoice Report")
+    )
     invoice_id = fields.Many2one(
         'account.invoice',
         string=_("Related Invoice"),
         compute="_get_related_invoice"
     )
     total_invoiced_amount_no_discount = fields.Float(
         string=_("Total income base (before discounts)"),
@@ -50,284 +52,284 @@
     )
     total_discount = fields.Float(
         string=_("Total discount base"),
         compute="_get_total_discount"
     )
     total_invoiced_amount = fields.Float(
         string=_("Total income base (after discounts)"),
-        compute="_get_inv_report_total")
+        compute="_get_inv_report_total"
+    )
     invoice_total = fields.Float(
-        string=_("Invoiced total"), compute="_get_invoice_total")
+        string=_("Invoiced total"),
+        compute="_get_invoice_total"
+    )
     invoice_taxes = fields.Float(
-        string=_("Invoiced taxes"), compute="_get_invoice_taxes")
+        string=_("Invoiced taxes"),
+        compute="_get_invoice_taxes"
+    )
     is_grouped_report = fields.Boolean(
         string=_("is_grouped_report"),
         compute="check_is_grouped_report",
         store=False
     )
 
     _order = "name desc"
 
+    ######################################
+    # COMPUTED FIELDS
+    ######################################
     @api.depends('invoice_report_id', 'reports_id')
     def check_is_grouped_report(self):
         for record in self:
             record.is_grouped_report = False
-            if record.invoice_report_id.id != False:
+            if record.invoice_report_id.id is not False:
                 if record.invoice_report_id.grouped_report:
                     record.is_grouped_report = True
 
     @api.depends('invoice_report_id')
     def _get_related_invoice(self):
         for record in self:
             if record.is_grouped_report:
-                if record.invoice_report_id.id != False:
+                if record.invoice_report_id.id is not False:
                     record.invoice_id = record.invoice_report_id.invoice_id
 
     @api.depends('invoice_report_id', 'reports_id')
     def _get_inv_report_total_no_discount(self):
         for record in self:
             if record.is_grouped_report:
-                if record.invoice_report_id.id != False:
-                    record.total_invoiced_amount_no_discount = record.invoice_report_id.total_amount_lines_untaxed
+                if record.invoice_report_id.id is not False:
+                    record.total_invoiced_amount_no_discount = \
+                        record.invoice_report_id.total_amount_lines_untaxed
             else:
                 total = 0
                 for report in record.reports_id:
-                    if report.invoice_report_id.id != False:
+                    if report.invoice_report_id.id is not False:
                         total += report.report_total_no_discounts
                 record.total_invoiced_amount_no_discount = total
 
     @api.depends('invoice_report_id', 'reports_id', 'name')
     def _get_total_discount(self):
         for record in self:
             if record.is_grouped_report:
-                if record.invoice_report_id.id != False:
-                    record.total_discount = record.invoice_report_id.discount_amount_subtotal
+                if record.invoice_report_id.id is not False:
+                    record.total_discount = \
+                        record.invoice_report_id.discount_amount_subtotal
             else:
                 total = 0
                 for report in record.reports_id:
-                    if report.invoice_report_id.id != False:
+                    if report.invoice_report_id.id is not False:
                         total += report.report_discount
                 record.total_discount = total
 
     @api.depends('invoice_report_id', 'reports_id')
     def _get_inv_report_total(self):
         for record in self:
             if record.is_grouped_report:
-                if record.invoice_report_id.id != False:
-                    record.total_invoiced_amount = record.invoice_report_id.ir_total_amount_signed
+                if record.invoice_report_id.id is not False:
+                    record.total_invoiced_amount = \
+                        record.invoice_report_id.ir_total_amount_signed
             else:
                 total = 0
                 for report in record.reports_id:
-                    if report.invoice_report_id.id != False:
+                    if report.invoice_report_id.id is not False:
                         total += report.report_total
                 record.total_invoiced_amount = total
 
     @api.depends('invoice_report_id', 'reports_id')
     def _get_invoice_total(self):
         for record in self:
             if record.is_grouped_report:
-                if record.invoice_report_id.id != False:
-                    record.invoice_total = record.invoice_report_id.total_amount_in_invoice
+                if record.invoice_report_id.id is not False:
+                    record.invoice_total = \
+                        record.invoice_report_id.total_amount_in_invoice
             else:
                 total = 0
                 for report in record.reports_id:
-                    if report.invoice_report_id.id != False:
+                    if report.invoice_report_id.id is not False:
                         total += report.invoice_total
                 record.invoice_total = total
 
     @api.depends('invoice_report_id', 'reports_id')
     def _get_invoice_taxes(self):
         for record in self:
             if record.is_grouped_report:
-                if record.invoice_report_id.id != False:
-                    record.invoice_taxes = record.invoice_report_id.total_taxes_in_invoice
+                if record.invoice_report_id.id is not False:
+                    record.invoice_taxes = \
+                        record.invoice_report_id.total_taxes_in_invoice
             else:
                 total = 0
                 for report in record.reports_id:
-                    if report.invoice_report_id.id != False:
+                    if report.invoice_report_id.id is not False:
                         total += report.invoice_taxes
                 record.invoice_taxes = total
 
+    ######################################
+    # ACTIONS
+    ######################################
     @api.multi
-    def reset_state(self):
+    def reset_state_action(self):
         if self.env.context:
             if 'active_ids' in self.env.context:
-                active_record = self.env['smp.sm_batch_reservation_compute'].browse(
-                    self.env.context['active_ids'])
+                active_record = self.env[
+                    'smp.sm_batch_reservation_compute'
+                ].browse(
+                    self.env.context['active_ids']
+                )
                 if active_record.exists():
-                    for rec in active_record:
-                        rec.state = "invoice_report"
+                    for brc in active_record:
+                        brc.state = "invoice_report"
 
+    ######################################
+    # WORKFLOW ACTIONS
+    ######################################
     @api.multi
-    def create_invoice_report(self):
-        self.set_status_bar('account_invoices_report')
+    def create_invoice_report_action(self):
         return {
             "context": self.env.context,
             "view_type": "form",
             "view_mode": "form",
             "res_model": "sm_partago_invoicing.sm_invoice_report_wizard",
             "type": "ir.actions.act_window",
             "name": "Create collected invoice report",
             "target": "new",
         }
 
     @api.multi
-    def sanitize_members_tariffs(self):
+    def modify_penalty_ratings_action(self):
         self.ensure_one()
+        if self.batch_type == 'usage':
+            if not self.invoice_report_id.id:
+                for report in self.reports_id:
+                    report.invoice_report_id.set_to_zero_cancelled_unused_inv_lines()
+            else:
+                self.invoice_report_id.set_to_zero_cancelled_unused_inv_lines()
+        self._set_status_bar('account_invoices_report')
+
+    @api.multi
+    def account_invoice_reports_action(self):
+        self.ensure_one()
+        if self.batch_type == 'usage':
+            if not self.invoice_report_id.id:
+                self._sanitize_all_report_members_tariffs()
+                for report in self.reports_id:
+                    report.invoice_report_id.account_report_lines()
+            else:
+                invoice_report = self.invoice_report_id
+                invoice_report.member_id.sanitize_tariffs()
+                invoice_report.account_report_lines()
+        self._set_status_bar('apply_discounts')
+
+    @api.multi
+    def apply_discounts_action(self):
+        self.ensure_one()
+        if not self.invoice_report_id.id:
+            for report in self.reports_id:
+                report.invoice_report_id.create_discount_lines()
+        else:
+            self.invoice_report_id.create_discount_lines()
+        self._set_status_bar('generate_invoices')
+
+    @api.multi
+    def generate_invoices_action(self):
+        self.ensure_one()
+        if not self.invoice_report_id.id:
+            for report in self.reports_id:
+                report.invoice_report_id.create_related_invoice(
+                    self.batch_type)
+        else:
+            self.invoice_report_id.create_related_invoice(self.batch_type)
+        self._set_status_bar('validate_invoices')
+
+    @api.multi
+    def validate_invoices_action(self):
+        self.ensure_one()
+        if not self.invoice_report_id.id:
+            for report in self.reports_id:
+                report.invoice_report_id.validate_related_invoice()
+        else:
+            self.invoice_report_id.validate_related_invoice()
+        self._set_status_bar('closed')
+
+    @api.multi
+    def email_send_invoices_action(self):
+        self.ensure_one()
+        company = self.env.user.company_id
+        email_template = company.invoice_mail_template_id
+        email_values = {'send_from_code': True}
+        if email_template.id:
+            if self.invoice_id.id:
+                invoice = self.invoice_id
+                if not invoice.invoice_email_sent:
+                    email_template.with_context(
+                        email_values
+                    ).send_mail(invoice.id, True)
+                    invoice.write({'invoice_email_sent': True})
+            else:
+                for report in self.reports_id:
+                    if report.invoice_id.exists():
+                        invoice = report.invoice_id
+                        if invoice.exists():
+                            if not invoice.invoice_email_sent:
+                                email_template.with_context(
+                                    email_values
+                                ).send_mail(invoice.id, True)
+                                invoice.write({'invoice_email_sent': True})
+
+    def set_closed_sent_action(self):
+        self.set_status_bar("closed_sent")
+        return True
+
+    ######################################
+    # MODEL METHODS
+    ######################################
+    def _sanitize_all_report_members_tariffs(self):
         if self.reports_id.exists():
             for report in self.reports_id:
                 if report.report_type != BatchType.TELETAC.value:
                     report.member_id.sanitize_tariffs()
         return True
 
-    def prepare_report_invoices(self, collected_member=False, timeframe_desc=''):
+    def prepare_report_invoices(self, collected_member, timeframe_desc=''):
         batch_to_compute = [self.batch_type]
         if collected_member.id:
             collected_member.sanitize_tariffs()
             report_invoice_report = self.env['sm.invoice_report'].create({
                 'name': self.name + '-' + collected_member.name,
                 'partner_id': collected_member.id,
                 'company_id': 1,
                 'date': str(time.strftime("%Y-%m-%d")),
                 'timeframe_desc': timeframe_desc,
                 'grouped_report': True
             })
             self.write({
                 'invoice_report_id': report_invoice_report.id
             })
-            report_invoice_report.compute_report_lines(False, batch_to_compute)
+            report_invoice_report.compute_report_lines(batch_to_compute)
             report_invoice_report.assign_previous_pocketbook()
         else:
             if self.reports_id.exists():
                 for report in self.reports_id:
                     if report.member_id.id:
                         report.member_id.sanitize_tariffs()
-                        report_invoice_report = self.env['sm.invoice_report'].create({
+                        report_invoice_report = self.env[
+                            'sm.invoice_report'
+                        ].create({
                             'name': self.name + '-' + report.member_id.name,
                             'partner_id': report.member_id.id,
                             'company_id': 1,
                             'date': str(time.strftime("%Y-%m-%d")),
                             'timeframe_desc': timeframe_desc,
                             'grouped_report': False
                         })
                         report.write({
                             'invoice_report_id': report_invoice_report.id
                         })
                         report_invoice_report.compute_report_lines(
-                            False, batch_to_compute)
+                            batch_to_compute)
                         report_invoice_report.assign_previous_pocketbook()
+        self._set_status_bar('modify_penalty_ratings')
         return True
 
-    @api.multi
-    def account_invoice_reports(self):
-        self.ensure_one()
-        self.sanitize_members_tariffs()
-        total = 0
-        batch_to_compute = [self.batch_type]
-        if not self.invoice_report_id.id:
-            if self.reports_id.exists():
-                for report in self.reports_id:
-                    if report.invoice_report_id.id:
-                        invoice_report = report.invoice_report_id
-                        invoice_report.compute_report_lines(
-                            True, batch_to_compute)
-        else:
-            if self.invoice_report_id.id:
-                invoice_report = self.invoice_report_id
-                invoice_report.compute_report_lines(True, batch_to_compute)
-        self.set_status_bar('apply_discounts')
-
-    @api.multi
-    def apply_discounts(self):
-        self.ensure_one()
-        if not self.invoice_report_id.id:
-            if self.reports_id.exists():
-                for report in self.reports_id:
-                    if report.invoice_report_id.id:
-                        invoice_report = report.invoice_report_id
-                        invoice_report.create_discount_lines()
-        else:
-            if self.invoice_report_id.id:
-                invoice_report = self.invoice_report_id
-                invoice_report.create_discount_lines()
-        self.set_status_bar('generate_invoices')
-
-    @api.multi
-    def generate_invoices(self):
-        self.ensure_one()
-        if not self.invoice_report_id.id:
-            if self.reports_id.exists():
-                for report in self.reports_id:
-                    if report.invoice_report_id.id:
-                        invoice_report = report.invoice_report_id
-                        invoice_report.create_related_invoice(self.batch_type)
-        else:
-            invoice_report = self.invoice_report_id
-            invoice_report.create_related_invoice(self.batch_type)
-        self.set_status_bar('validate_invoices')
-
-    @api.multi
-    def validate_invoices(self):
-        self.ensure_one()
-        if not self.invoice_report_id.id:
-            if self.reports_id.exists():
-                for report in self.reports_id:
-                    if report.invoice_report_id.id:
-                        report.invoice_report_id.validate_related_invoice()
-        else:
-            self.invoice_report_id.validate_related_invoice()
-        self.set_status_bar('closed')
-
-    @api.one
-    def email_send_invoices(self):
-        company = self.env.user.company_id
-        email_template = company.invoice_mail_template_id
-        email_values = {'send_from_code': True}
-        if email_template.id:
-            if self.invoice_id.id:
-                invoice = self.invoice_id
-                if not invoice.invoice_email_sent:
-                    email_template.with_context(
-                        email_values).send_mail(invoice.id, True)
-                    invoice.write({'invoice_email_sent': True})
-            else:
-                if self.reports_id.exists():
-                    for report in self.reports_id:
-                        if report.invoice_id.exists():
-                            invoice = report.invoice_id
-                            if invoice.exists():
-                                if not invoice.invoice_email_sent:
-                                    email_template.with_context(
-                                        email_values).send_mail(invoice.id, True)
-                                    invoice.write({'invoice_email_sent': True})
-
-    def set_closed_sent(self):
-        self.set_status_bar("closed_sent")
-        return True
-
-    def set_status_bar(self, state):
+    def _set_status_bar(self, state):
         self.write({
             'state': state,
         })
-
-# @api.one
-# def email_send_invoice_reports(self):
-#   company = self.env.user.company_id
-#   email_values = {'send_from_code': True}
-#   if self.batch_type == BatchType.USAGES.value:
-#     email_template = company.invoice_report_mail_template_id
-#   if self.batch_type == BatchType.TELETAC.value:
-#     email_template = company.invoice_report_teletac_mail_template_id
-#   if email_template.id:
-#     if self.invoice_report_id.id:
-#       invoice_report = self.invoice_report_id
-#       if not invoice_report.email_sent:
-#         email_template.with_context(email_values).send_mail(invoice_report.id, True)
-#         invoice_report.write({'email_sent': True})
-#     else:
-#       if self.reports_id.exists():
-#         for report in self.reports_id:
-#           invoice_report = report.invoice_report_id
-#           if invoice_report.id:
-#             if not invoice_report.email_sent:
-#               email_template.with_context(email_values).send_mail(invoice_report.id, True)
-#               invoice_report.write({'email_sent': True})
```

## odoo/addons/sm_partago_invoicing/models/models_smp_reservation_compute.py

```diff
@@ -40,78 +40,96 @@
     # Unused now
     fuel_consume_invoiced = fields.Float(string=_("Fuel consume (invoice)"))
 
     related_invoice_lines = fields.One2many(
         comodel_name='account.invoice.line',
         inverse_name='related_reservation_compute_id',
         string=_("Related invoice lines"),
-        domain=[('invoice_report_id', '=', False)])
+        domain=[('invoice_report_id', '=', False)]
+    )
 
     related_invoice_lines_amount_total_cs = fields.Float(
         string=_("Related invoice lines amount total (Carsharing)"),
         compute="_get_related_invoice_lines_amount_total_cs",
-        store=False)
+        store=False
+    )
     related_invoice_lines_amount_total_teletacs = fields.Float(
         string=_("Related invoice lines amount total (Teletacs)"),
-        compute="_get_related_invoice_lines_amount_total_teletacs", store=False
+        compute="_get_related_invoice_lines_amount_total_teletacs",
+        store=False
     )
     reporting_rating_minutes = fields.Float(
         string=_("Reporting rating minutes"),
-        compute="_get_reporting_rating_minutes", store=True
+        compute="_get_reporting_rating_minutes",
+        store=True
+    )
+    reporting_rating_hours = fields.Float(
+        string=_("Reporting rating hours"),
+        compute="_get_reporting_rating_hours",
+        store=True
     )
     reporting_rating_hours = fields.Float(
         string=_("Reporting rating hours"),
         compute="_get_reporting_rating_hours",
         store=True)
 
     ######################################################
     # GETTERS AND COMPUTATION
     ######################################################
     @api.depends('related_invoice_lines')
     def _get_related_invoice_lines_amount_total_cs(self):
         for record in self:
             amount_total = 0
             for line in record.related_invoice_lines:
-                if line.line_type in ['cs_default', 'cs_extra']:
+                if line.line_type in ['cs_default', 'cs_extra', 'cs_penalty']:
                     amount_total += line.price_subtotal_signed
             record.related_invoice_lines_amount_total_cs = amount_total
 
     @api.depends('related_invoice_lines')
     def _get_related_invoice_lines_amount_total_teletacs(self):
         amount_total = 0
         for record in self:
             for line in record.related_invoice_lines:
                 if line.line_type in ['cs_teletac']:
                     amount_total += line.price_subtotal_signed
             record.related_invoice_lines_amount_total_teletacs = amount_total
 
-    @api.depends('total_usage_mins_invoiced', 'total_usage_days_invoiced', 'total_usage_days_tariff', 'total_usage_mins_tariff')
+    @api.depends(
+        'total_usage_mins_invoiced',
+        'total_usage_days_invoiced',
+        'total_usage_days_tariff',
+        'total_usage_mins_tariff'
+    )
     def _get_reporting_rating_minutes(self):
         for record in self:
             add_times = False
             # we have time tariffs
-            if record.total_usage_days_tariff > 0 or record.total_usage_mins_tariff > 0:
+            if (
+                record.total_usage_days_tariff > 0 or
+                record.total_usage_mins_tariff > 0
+            ):
                 add_times = True
             else:
                 # No time tariffs and money for the non-tariff values
                 if record.related_invoice_lines_amount_total_cs > 0:
                     add_times = True
             if add_times:
-                record.reporting_rating_minutes = record.total_usage_mins_invoiced + \
+                record.reporting_rating_minutes = \
+                    record.total_usage_mins_invoiced + \
                     record.total_usage_days_invoiced * 600
 
     @api.depends('reporting_rating_minutes')
     def _get_reporting_rating_hours(self):
         for record in self:
-            record.reporting_rating_hours = record.reporting_rating_minutes / 60
+            record.reporting_rating_hours = \
+                record.reporting_rating_minutes / 60
 
     def get_analytic_account(self):
         company = self.env.user.company_id
         analytic_account = company.notfound_car_analytic_account_id
-
         # find a better analytic account for line
         cs_carconfig = self.get_cs_carconfig_obj()
         if cs_carconfig:
             analytic_account = cs_carconfig.analytic_account_id
 
         return analytic_account
 
@@ -161,36 +179,41 @@
             _('Mark as toInvoice done successfully'),
             self._name
         )
 
     def autoforgive_action(self):
         if self.env.context:
             if 'active_ids' in self.env.context:
-                selected_reservations = self.env['smp.sm_reservation_compute'].browse(
-                    self.env.context['active_ids'])
+                selected_reservations = self.env[
+                    'smp.sm_reservation_compute'
+                ].browse(
+                    self.env.context['active_ids']
+                )
                 if selected_reservations.exists():
                     for reserv in selected_reservations:
                         if reserv.cs_user_type in ['promo', 'maintenance']:
                             reserv.write({'compute_forgiven': True})
 
     ######################################################
     # RATING SECTION. Pricing based on rating vals
     ######################################################
 
     def compute_invoice_report_tariff_time_quantities(self, tariff_model):
         prices = tariff_model.get_prices(self.cs_carconfig_id)
         tariff_day_price = prices['day_price'].product_tmpl_id.list_price
         tariff_min_price = prices['min_price'].product_tmpl_id.list_price
-        return self.total_usage_mins_tariff * tariff_min_price + self.total_usage_days_tariff * tariff_day_price
+        return self.total_usage_mins_tariff * tariff_min_price + \
+            self.total_usage_days_tariff * tariff_day_price
 
     def compute_invoice_report_nontariff_time_quantities(self, tariff_model):
         prices = tariff_model.get_prices(self.cs_carconfig_id)
         tariff_day_price = prices['day_price'].product_tmpl_id.list_price
         tariff_min_price = prices['min_price'].product_tmpl_id.list_price
-        return self.total_usage_mins_invoiced * tariff_min_price + self.total_usage_days_invoiced * tariff_day_price
+        return self.total_usage_mins_invoiced * tariff_min_price + \
+            self.total_usage_days_invoiced * tariff_day_price
 
     def compute_invoice_report_km_quantities(self, tariff_model):
         prices = tariff_model.get_prices(self.cs_carconfig_id)
         tariff_km_price = prices['kms_price'].product_tmpl_id.list_price
         return self.used_mileage_invoiced * tariff_km_price
 
     ######################################################
@@ -208,15 +231,16 @@
 
         # TARIFF APPLIED ####
         res_params = {
             'applied_tariff_id': tariff['tariff_id']
         }
 
         # "REAL VALUES" ####
-        # Consider the min between [start] and [effectiveStart] and min between [end] and [effectiveEnd]
+        # Consider min between ([start] and [effectiveStart]) and
+        # min between ([end] and [effectiveEnd])
 
         # Calculate real start for computation
         if effectiveStartTime < startTime:
             real_start = effectiveStartTime
         else:
             real_start = startTime
 
@@ -243,28 +267,30 @@
             decoupled_mins = self.decouple_mins_between_tariff_and_non(
                 self.non_usage_mins_invoiced,
                 tariff['tariff_aval'],
                 effectiveEndTime,
                 endTime
             )
             res_params['non_usage_mins_tariff'] = decoupled_mins['tariff']
-            res_params['non_usage_mins_nontariff'] = decoupled_mins['nontariff']
+            res_params['non_usage_mins_nontariff'] = \
+                decoupled_mins['nontariff']
             res_params['extra_usage_mins_tariff'] = 0
             res_params['extra_usage_mins_nontariff'] = 0
 
         # for extra used mins
         else:
             decoupled_mins = self.decouple_mins_between_tariff_and_non(
                 self.extra_usage_mins_invoiced,
                 tariff['tariff_aval'],
                 endTime,
                 effectiveEndTime
             )
             res_params['extra_usage_mins_tariff'] = decoupled_mins['tariff']
-            res_params['extra_usage_mins_nontariff'] = decoupled_mins['nontariff']
+            res_params['extra_usage_mins_nontariff'] = \
+                decoupled_mins['nontariff']
             res_params['non_usage_mins_tariff'] = 0
             res_params['non_usage_mins_nontariff'] = 0
 
         # BASED ON PREVIOUS MINS. CALCULATE DAYS AND MINS ####
 
         # fallback values / initial data
         company = self.env.user.company_id
@@ -304,28 +330,32 @@
         total_invoice_days = res_params['invoice_days_tariff'] + \
             res_params['invoice_days_nontariff']
         total_invoice_mins = res_params['invoice_mins_tariff'] + \
             res_params['invoice_mins_nontariff']
 
         # MILAGE INVOICED ####
         # TODO: make time included tariff dependant
-        used_mileage_invoiced = self.used_mileage - (kms_included_day * total_invoice_days) - (
-            kms_included_hour * reservation_calculator.get_hours_from_minutes(total_invoice_mins))
+        used_mileage_invoiced = \
+            self.used_mileage - (kms_included_day * total_invoice_days) - \
+            (kms_included_hour * reservation_calculator.get_hours_from_minutes(
+                total_invoice_mins
+            ))
         if used_mileage_invoiced < 0:
             used_mileage_invoiced = 0
         res_params['used_mileage_invoiced'] = used_mileage_invoiced
 
         self.update_reservation_compute(res_params)
         self.apply_min_reservation_time_restriction()
 
     ######################################################
     # RATING SECTION. Mins decouple based on tariff avals
     ######################################################
 
-    # Very important: for the rating we're going to work with dictionary data structures like this:
+    # Very important: for the rating:
+    # We're going to work with dictionary data structures like this:
     # {
     #   "day": 0 to 6
     #   "hour": %H:%M:%S
     # }
 
     # RATING VALUES UPDATE
     def update_reservation_compute(self, res_params):
@@ -345,20 +375,32 @@
         }
         self.write(udata)
 
     # TIME RESTRICTION
     # any invoicing value should be less than 60 mins
     def apply_min_reservation_time_restriction(self):
         min_reservation_time = 60
-        if self.total_usage_mins_tariff == 0 and self.total_usage_days_tariff == 0:
-            if self.total_usage_days_invoiced == 0 and self.total_usage_mins_invoiced < min_reservation_time:
+        if (
+            self.total_usage_mins_tariff == 0 and
+            self.total_usage_days_tariff == 0
+        ):
+            if (
+                self.total_usage_days_invoiced == 0 and
+                self.total_usage_mins_invoiced < min_reservation_time
+            ):
                 self.write({'total_usage_mins_invoiced': min_reservation_time})
 
     # DECOUPLING MINS DEPENDING ON TARIFF AVAILS
-    def decouple_mins_between_tariff_and_non(self, total_mins, tariff_avals, start_datetime, end_datetime):
+    def decouple_mins_between_tariff_and_non(
+        self,
+        total_mins,
+        tariff_avals,
+        start_datetime,
+        end_datetime
+    ):
         decoupled = {}
         # if avails: check mins in tariff
         if tariff_avals:
             tariff_avals_mins = self.check_mins_in_tariff(
                 tariff_avals, start_datetime, end_datetime)
             decoupled['tariff'] = tariff_avals_mins
             decoupled['nontariff'] = total_mins - tariff_avals_mins
@@ -387,15 +429,16 @@
         num_weeks = 0
         #  check initials week difference
         if start_datetime.isocalendar()[1] != end_datetime.isocalendar()[1]:
             num_weeks = end_datetime.isocalendar(
             )[1] - start_datetime.isocalendar()[1]
 
         # TODO: control different years
-        # if diff > 1 week need to control weekly mins in tariff for num of weeks
+        # if diff > 1
+        # week need to control weekly mins in tariff for num of weeks
         if num_weeks > 0:
             start = start_initial
             start_week = {
                 'day': 0,
                 'hour': '00:00:00'
             }
             end_week = {
@@ -409,15 +452,16 @@
                 mins = mins + \
                     self.check_mins_in_tariff_in_week(
                         avals, start_week, end_week)
                 i = i + 1
             mins = mins + \
                 self.check_mins_in_tariff_in_week(
                     avals, start_week, end_initial)
-        # control weekly mins in tariff for initial dates as they're on same week
+        # control weekly mins in tariff for initial dates
+        # as they're on same week
         else:
             mins = self.check_mins_in_tariff_in_week(
                 avals, start_initial, end_initial)
 
         return mins
 
     #  CHECK MINS IN TARIFF (WEEKLY)
@@ -431,45 +475,55 @@
             }
             interval_end = {
                 'day': avals[aval_key]['end_day'],
                 'hour': avals[aval_key]['end_hour']
             }
             # for each interval check how many minutes are inside.
             # need to see where start and end are placed on the interval
-            if(
+            if (
                 self.week_time_compare(start, '>', interval_start) and
                 self.week_time_compare(start, '<', interval_end) and
                 self.week_time_compare(end, '>', interval_start) and
                 self.week_time_compare(end, '<', interval_end)
             ):
                 # start and end on the interval
                 mins = mins + self.week_time_diff(start, end)
             else:
-                if(
+                if (
                     self.week_time_compare(start, '>', interval_start) and
                     self.week_time_compare(start, '<', interval_end)
                 ):
                     # start on the interval
                     mins = mins + self.week_time_diff(start, interval_end)
                 else:
-                    if(
+                    if (
                         self.week_time_compare(end, '>', interval_start) and
                         self.week_time_compare(end, '<', interval_end)
                     ):
                         # end on the interval
                         mins = mins + self.week_time_diff(interval_start, end)
                     else:
-                        if(
-                            self.week_time_compare(start, '<', interval_start) and
-                            self.week_time_compare(end, '>', interval_end)
+                        if (
+                            self.week_time_compare(
+                                start,
+                                '<',
+                                interval_start
+                            ) and
+                            self.week_time_compare(
+                                end,
+                                '>',
+                                interval_end
+                            )
                         ):
                             # start and end not in the internal
-                            mins = mins + \
-                                self.week_time_diff(
-                                    interval_start, interval_end)
+                            mins = \
+                                mins + self.week_time_diff(
+                                    interval_start,
+                                    interval_end
+                                )
         return mins
 
     # CONVERT STRING INTO AVAL DICT
     def prepare_tariff_avals(self, avals_txt):
         # build dict with different avals intervals
         aval_dict = {}
         i = 0
@@ -489,22 +543,28 @@
 
     # COMPARE 2 DATES
     # with our data sctructure
     def week_time_compare(self, time1, case, time2):
         if case == '<':
             if time1['day'] <= time2['day']:
                 if time1['day'] == time2['day']:
-                    if datetime.strptime(str(time1['hour']), '%H:%M:%S') <= datetime.strptime(str(time2['hour']), '%H:%M:%S'):
+                    if (
+                        datetime.strptime(str(time1['hour']), '%H:%M:%S') <=
+                        datetime.strptime(str(time2['hour']), '%H:%M:%S')
+                    ):
                         return True
                 else:
                     return True
         if case == '>':
             if time1['day'] >= time2['day']:
                 if time1['day'] == time2['day']:
-                    if datetime.strptime(str(time1['hour']), '%H:%M:%S') >= datetime.strptime(str(time2['hour']), '%H:%M:%S'):
+                    if (
+                        datetime.strptime(str(time1['hour']), '%H:%M:%S') >=
+                        datetime.strptime(str(time2['hour']), '%H:%M:%S')
+                    ):
                         return True
                 else:
                     return True
 
         return False
 
     # TIME DIFFRENCE IN MINS
@@ -516,18 +576,19 @@
         if i <= end['day']:
             while compute:
                 # not in same day. add one day in mins
                 if i != end['day']:
                     mins = mins + 24 * 60
                     i = i + 1
                 else:
-                    #  we're on same day. get minutes diference between 2 hours datetimes
+                    #  we're on same day.
+                    #  get minutes diference between 2 hours datetimes
                     rest = (
-                        datetime.strptime(
-                            str(end['hour']), '%H:%M:%S') - datetime.strptime(str(start['hour']), '%H:%M:%S')
+                        datetime.strptime(str(end['hour']), '%H:%M:%S') -
+                        datetime.strptime(str(start['hour']), '%H:%M:%S')
                     ).total_seconds() / 60.00
                     mins = mins + rest
                     compute = False
         return mins
 
     # ISO weekday from string
     def get_weekday(self, day_str):
```

## odoo/addons/sm_partago_invoicing/report/sm_invoice_report.xml

 * *Format-specific differences are supported for XML files but no file-specific differences were detected; falling back to a binary diff. file(1) reports: XML 1.0 document, Unicode text, UTF-8 text*

```diff
@@ -1251,8 +1251,8 @@
 00004e20: 6f72 745f 7669 6577 220a 2020 2020 2020  ort_view".      
 00004e30: 2020 6669 6c65 3d22 736d 5f70 6172 7461    file="sm_parta
 00004e40: 676f 5f69 6e76 6f69 6369 6e67 2e73 6d5f  go_invoicing.sm_
 00004e50: 696e 766f 6963 655f 7265 706f 7274 5f72  invoice_report_r
 00004e60: 6570 6f72 7422 0a20 2020 2020 2020 2072  eport".        r
 00004e70: 6570 6f72 745f 7479 7065 3d22 7177 6562  eport_type="qweb
 00004e80: 2d70 6466 222f 3e0a 0a20 203c 2f64 6174  -pdf"/>..  </dat
-00004e90: 613e 0a3c 2f6f 646f 6f3e                 a>.</odoo>
+00004e90: 613e 0a3c 2f6f 646f 6f3e 0a              a>.</odoo>.
```

## odoo/addons/sm_partago_invoicing/views/views_batch_reservation_compute.xml

### odoo/addons/sm_partago_invoicing/views/views_batch_reservation_compute.xml

```diff
@@ -44,21 +44,22 @@
     <record id="view_batch_reservation_compute_form" model="ir.ui.view">
       <field name="name">smp.batch_reservation_compute.form</field>
       <field name="model">smp.sm_batch_reservation_compute</field>
       <field name="type">form</field>
       <field name="arch" type="xml">
         <form string="Edit place" version="7.0" create="false" edit="true" delete="false">
           <header>
-            <button name="create_invoice_report" type="object" string="Create inv report" attrs="{'invisible': [('state','!=','invoice_report')]}"/>
-            <button name="account_invoice_reports" string="Account invoice reports" confirm="Are you sure?" type="object" attrs="{'invisible': [('state','!=','account_invoices_report')]}"/>
-            <button name="apply_discounts" string="Apply discounts" confirm="Are you sure?" type="object" attrs="{'invisible': [('state','!=','apply_discounts')]}"/>
-            <button name="generate_invoices" string="Generate invoices" confirm="Are you sure?" type="object" attrs="{'invisible': [('state','!=','generate_invoices')]}"/>
-            <button name="validate_invoices" string="Validate invoices" confirm="Are you sure?" type="object" attrs="{'invisible': [('state','!=','validate_invoices')]}"/>
-            <button name="email_send_invoices" string="Send inv emails" confirm="Are you sure?" type="object" attrs="{'invisible': [('state','!=','closed'),('state','!=','closed_sent')]}"/>
-            <button name="set_closed_sent" string="Set closed sent" confirm="Are you sure?" type="object" attrs="{'invisible': [('state','!=','closed')]}"/>
+            <button name="create_invoice_report_action" type="object" string="Create inv report" attrs="{'invisible': [('state','!=','invoice_report')]}"/>
+            <button name="modify_penalty_ratings_action" string="Modify original penalty ratings" confirm="Are you sure?" type="object" attrs="{'invisible': [('state','!=','modify_penalty_ratings')]}"/>
+            <button name="account_invoice_reports_action" string="Account invoice reports" confirm="Are you sure?" type="object" attrs="{'invisible': [('state','!=','account_invoices_report')]}"/>
+            <button name="apply_discounts_action" string="Apply discounts" confirm="Are you sure?" type="object" attrs="{'invisible': [('state','!=','apply_discounts')]}"/>
+            <button name="generate_invoices_action" string="Generate invoices" confirm="Are you sure?" type="object" attrs="{'invisible': [('state','!=','generate_invoices')]}"/>
+            <button name="validate_invoices_action" string="Validate invoices" confirm="Are you sure?" type="object" attrs="{'invisible': [('state','!=','validate_invoices')]}"/>
+            <button name="email_send_invoices_action" string="Send inv emails" confirm="Are you sure?" type="object" attrs="{'invisible': [('state','!=','closed'),('state','!=','closed_sent')]}"/>
+            <button name="set_closed_sent_action" string="Set closed sent" confirm="Are you sure?" type="object" attrs="{'invisible': [('state','!=','closed')]}"/>
             <field name="state" widget="statusbar"/>
           </header>
           <sheet>
             <notebook>
               <page string="General">
                 <group>
                   <field name="name"/>
```

## odoo/addons/sm_partago_invoicing/views/views_invoice_line.xml

### odoo/addons/sm_partago_invoicing/views/views_invoice_line.xml

```diff
@@ -11,14 +11,15 @@
           <field name="partner_id"/>
           <field name="invoice_id"/>
           <filter string="Default" name="type_default" domain="[('line_type', '=', 'default')]"/>
           <filter string="Carsharing default" name="type_cs_default" domain="[('line_type', '=', 'cs_default')]"/>
           <filter string="Carsharing extra" name="type_cs_extra" domain="[('line_type', '=', 'cs_extra')]"/>
           <filter string="Carsharing teletac" name="type_cs_teletac" domain="[('line_type', '=', 'cs_teletac')]"/>
           <filter string="Carsharing discount" name="type_cs_discount" domain="[('line_type', '=', 'cs_discount')]"/>
+          <filter string="Carsharing penalty" name="type_cs_discount" domain="[('line_type', '=', 'cs_penalty')]"/>
         </search>
       </field>
     </record>
     <record id="view_invoice_line_window" model="ir.actions.act_window">
       <field name="name">Invoice lines</field>
       <field name="res_model">account.invoice.line</field>
       <field name="view_mode">tree,form</field>
```

## odoo/addons/sm_partago_invoicing/views/views_invoice_report.xml

### odoo/addons/sm_partago_invoicing/views/views_invoice_report.xml

```diff
@@ -80,32 +80,38 @@
                   <field name="total_taxes_in_invoice"/>
                 </group>
                 <group col="4">
                   <field name="predetermined_tariff" invisible="True"/>
                   <field name="predetermined_tariff_description" widget="html" invisible="True"/>
                 </group>
                 <group>
-                  <field name="related_batch_reservation_ids"/>
-                  <field name="related_report_reservation_ids"/>
+                  <field name="batch_reservation_id"/>
                 </group>
                 <group>
                   <field name="cs_line_ids" widget="one2many_list">
                     <tree string="Lines" create="true" edit="true" delete="true" open="true">
                       <field name="sequence" widget="handle"/>
                       <field name="name"/>
+                      <field name="line_type"/>
+                      <field name="penalty_type"/>
+                      <field name="parent_invoice_line_id"/>
+                      <field name="related_reservation_compute_id"/>
                       <field name="related_tariff_id"/>
                       <field name="price_subtotal_signed"/>
                       <field name="price_total"/>
                       <field name="partner_id"/>
                     </tree>
                     <form>
                       <group>
                         <field name="name"/>
                         <field name="line_type"/>
+                        <field name="penalty_type"/>
+                        <field name="parent_invoice_line_id"/>
                         <field name="product_id"/>
+                        <field name="related_reservation_compute_id"/>
                         <field name="account_id"/>
                         <field name="invoice_line_tax_ids"/>
                         <field name="account_analytic_id"/>
                         <field name="related_tariff_id"/>
                         <field name="partner_id"/>
                         <field name="quantity"/>
                         <field name="price_unit"/>
```

## Comparing `odoo12_addon_sm_partago_invoicing-12.0.0.1.5.dist-info/METADATA` & `odoo12_addon_sm_partago_invoicing-12.0.0.1.6.dist-info/METADATA`

 * *Files 13% similar despite different names*

```diff
@@ -1,23 +1,19 @@
 Metadata-Version: 2.1
 Name: odoo12-addon-sm-partago-invoicing
-Version: 12.0.0.1.5
+Version: 12.0.0.1.6
 Summary: Module to modify invoices and cs reports for the user
 Home-page: http://www.sommobilitat.coop
 Author: Som Mobilitat
-License: UNKNOWN
-Platform: UNKNOWN
 Classifier: Programming Language :: Python
 Classifier: Framework :: Odoo
 Classifier: Framework :: Odoo :: 12.0
 Requires-Python: >=3.5
 Requires-Dist: odoo12-addon-sm-connect
 Requires-Dist: odoo12-addon-sm-partago-db
 Requires-Dist: odoo12-addon-sm-partago-tariffs
 Requires-Dist: odoo12-addon-sm-partago-usage
 Requires-Dist: odoo12-addon-sm-rewards
 Requires-Dist: odoo12-addon-sm-teletacs
 Requires-Dist: odoo12-addon-vertical-carsharing
 Requires-Dist: odoo (<12.1dev,>=12.0a)
 
-UNKNOWN
-
```

## Comparing `odoo12_addon_sm_partago_invoicing-12.0.0.1.5.dist-info/RECORD` & `odoo12_addon_sm_partago_invoicing-12.0.0.1.6.dist-info/RECORD`

 * *Files 5% similar despite different names*

```diff
@@ -1,46 +1,46 @@
 odoo/addons/sm_partago_invoicing/__init__.py,sha256=zBYEicgQNk_0EbWt3pqccxtNBQkD-UGExKtLccP64Ik,69
-odoo/addons/sm_partago_invoicing/__manifest__.py,sha256=ztblQqKxg9vKRlo5QhQViqUG1l35nRRgbKQzN1jnnqI,1548
+odoo/addons/sm_partago_invoicing/__manifest__.py,sha256=EhdMmNWHPRFRTlIofAaUZHnZk4umdz3W6Gtu7mH_aJM,1548
 odoo/addons/sm_partago_invoicing/email_tmpl/invoice_email.xml,sha256=WrLV4HYpTiW1LaiYI_cSMjRxoTbD-l4sgp6DqOwFWfQ,1901
 odoo/addons/sm_partago_invoicing/email_tmpl/invoice_report.xml,sha256=p1Yb1rwzEu-uS25VtHsG8ihWvwOf2QLSlVEzhpgMVx0,3331
 odoo/addons/sm_partago_invoicing/email_tmpl/sale_order.xml,sha256=aGY1K5pRMGPBYeoqvI7PjD--lQMZcY8maGQV8GhVlnM,2052
 odoo/addons/sm_partago_invoicing/models/__init__.py,sha256=19RULir2YlGI4oKanZKBfPx-kEaKMXMnWia7zIvzWuU,524
 odoo/addons/sm_partago_invoicing/models/batch_type_enum.py,sha256=RE1JC_QL3415nqlTQFxTM4jTOaXBCjtQlYSo_tfsATE,92
 odoo/addons/sm_partago_invoicing/models/models_reservation_calculator.py,sha256=TTjqBDdJK03W2p16hhsjUPijpN2lHYV82-lk-Z_aLcA,2606
 odoo/addons/sm_partago_invoicing/models/models_sm_company.py,sha256=CPXutPEjwxLiKADaDGSeMptIkLbwUvEs5_u4gw3_xLQ,1890
 odoo/addons/sm_partago_invoicing/models/models_sm_invoice.py,sha256=gbMrvQHfGi3P83aF7tuvace-bxyNQgeZlXqvTctfyD8,4035
-odoo/addons/sm_partago_invoicing/models/models_sm_invoice_line.py,sha256=Y27gxWOW57wCGI-sfvdEE52MqbSLnfEPOazbiIwcZJY,1566
-odoo/addons/sm_partago_invoicing/models/models_sm_invoice_report.py,sha256=8bqh1lMpRj13XyC7RmN5VhvezyCZ9Y-pppKhwihXB_M,25326
+odoo/addons/sm_partago_invoicing/models/models_sm_invoice_line.py,sha256=iIx5jzDBzYrbYfIgH2Xp2pA2FKafflr88DxVF24aSJE,2069
+odoo/addons/sm_partago_invoicing/models/models_sm_invoice_report.py,sha256=WK8cFrXmOfnq8wYRpsHIwdLh-RLCo6zFNIhqug7caaY,26368
 odoo/addons/sm_partago_invoicing/models/models_sm_invoice_report_wizard.py,sha256=MrQOJmm6bdqKZPk52NQzQ8PKclgA8flD3_ESygusN1g,949
 odoo/addons/sm_partago_invoicing/models/models_sm_member.py,sha256=HAL7KNHmyXlknlrqnCQiqozg1EoS2OKrXqHNhEcKgGY,290
 odoo/addons/sm_partago_invoicing/models/models_sm_res_config_settings.py,sha256=znq01bzqvKKpN_C0POIWE1pELbmuQuhVxN4JQX5b0QI,2821
-odoo/addons/sm_partago_invoicing/models/models_smp_batch_reservation_compute.py,sha256=U5emBH3syPtPS4paq1u8kBlyU9iA1QnP6n6y8xNLG4M,13761
+odoo/addons/sm_partago_invoicing/models/models_smp_batch_reservation_compute.py,sha256=w5sqrHIvwLe_q2GekkwTEs8YD0Rn7SgbR39g1Zr3UkI,13107
 odoo/addons/sm_partago_invoicing/models/models_smp_batch_reservation_compute_wizard.py,sha256=Fssx7CVHupV-gwVd94HluHi48nRm0l6f-3idpDV3ZgA,8784
 odoo/addons/sm_partago_invoicing/models/models_smp_report_reservation_compute.py,sha256=-SYwH2ujFN6rw4RYMFKQHQwGLECUI3sm_YsNsKMZdHo,3491
-odoo/addons/sm_partago_invoicing/models/models_smp_reservation_compute.py,sha256=IfziiFo8AHXDsy68imhya2FXzyqYnTAXbd1_6MyC8oQ,22954
+odoo/addons/sm_partago_invoicing/models/models_smp_reservation_compute.py,sha256=AYvcYodWn6-5g2OEJjI8pfcC3TYgen3wNVIG754tRxU,24096
 odoo/addons/sm_partago_invoicing/models/models_smp_teletac.py,sha256=Vq3aiR93LMhlTjte6lcAysvzCmzt6OUmTR_5gQ1oOwg,754
 odoo/addons/sm_partago_invoicing/report/contact.xml,sha256=8nOJ3A9j1NTZ7BVwMbX1_fleGpCd_wVEW6fylfLrCHg,1360
 odoo/addons/sm_partago_invoicing/report/invoice_report.xml,sha256=T_wQJl2JVIpJb3XY6SnaB_2mtbCqCdL08TF81DRQwyQ,16634
-odoo/addons/sm_partago_invoicing/report/sm_invoice_report.xml,sha256=MsfsTDF4S_u1A1cAxQKm54QktYHqDo2hDe8diQT0uf8,20122
+odoo/addons/sm_partago_invoicing/report/sm_invoice_report.xml,sha256=KEBK28aN6aAe7f1MK47rCue9Nvj6r0P8HzD8bGKjVsI,20123
 odoo/addons/sm_partago_invoicing/security/ir.model.access.csv,sha256=j1FLYdAj0ez7I4Qu-HWzvGjfj0nMxrBp7fvkLBGJMKc,633
 odoo/addons/sm_partago_invoicing/services/__init__.py,sha256=PNUom0sUvT-CxRq6GaTkorgfU_9RGIt8XIS-WhEczPA,65
 odoo/addons/sm_partago_invoicing/services/invoice_services.py,sha256=XdlmdSdyyFoX2Y4QrYKFgAqRlyEkCYDGFNeA7XAlYf0,4004
 odoo/addons/sm_partago_invoicing/services/report_services.py,sha256=ZoIprLxc8DYyi483GvfZm_z7Dw00w62FI8BgSlV9r2I,3527
 odoo/addons/sm_partago_invoicing/static/src/js/base.js,sha256=i55ds7vqqBFCaurl8a-nwBR65TcmVubS6exqikXun4s,927
 odoo/addons/sm_partago_invoicing/static/src/xml/base.xml,sha256=lqkj4ulPKsA57fD2XIjQAFeEFHw1zmE0qsZCfveK6hY,615
 odoo/addons/sm_partago_invoicing/views/views.xml,sha256=xg7qLbdN9_k5kNhfpKeNiFKKFWAwzc23s7P7D0SR7MA,403
-odoo/addons/sm_partago_invoicing/views/views_batch_reservation_compute.xml,sha256=HTN14cF-d_S5Qfp-TybJn0QteW4PqdkDptv2nKkhYK4,5548
+odoo/addons/sm_partago_invoicing/views/views_batch_reservation_compute.xml,sha256=Gb18ZBbaQYqjvTjYLIIi9YldPLj-UAG-fIrbotIFMmc,5830
 odoo/addons/sm_partago_invoicing/views/views_batch_reservation_compute_wizard.xml,sha256=y69dbmDhC-g6FdvpxW1X7Tx0HuDn7toPgFO8ODTuBBo,1539
 odoo/addons/sm_partago_invoicing/views/views_extra_expense.xml,sha256=0YQNmXO050VQ1tXaxlm_XUxlbQai4tX9T6o4NKyFlVs,1023
-odoo/addons/sm_partago_invoicing/views/views_invoice_line.xml,sha256=uyYtuj3JvSz7PTTScsct1GElstcE5WfWLv3_eGzHsHw,2832
-odoo/addons/sm_partago_invoicing/views/views_invoice_report.xml,sha256=2BqnZL0phWW56j6fTzWhsPSV5rzIUJ5Vt268hhDpJFc,5267
+odoo/addons/sm_partago_invoicing/views/views_invoice_line.xml,sha256=6Ge7vfs5wp_3Ebj_lKGVtEpUVJEkWZmSaU_GT_10QuU,2948
+odoo/addons/sm_partago_invoicing/views/views_invoice_report.xml,sha256=ee_a_Pu19KZSrhvbFpRWXBebNmlH5Y2EJC3UEO8MbCU,5608
 odoo/addons/sm_partago_invoicing/views/views_invoice_report_wizard.xml,sha256=CEjC4H65cuAuddMui3kNznrAlKvwizTj8-NfITWQsNg,1246
 odoo/addons/sm_partago_invoicing/views/views_invoices.xml,sha256=zGnZ3rWAnrpdKxjkqYvNGpveMFWHa4Oi_G-ssQL7iWc,1612
 odoo/addons/sm_partago_invoicing/views/views_members.xml,sha256=FFkVoWO1Lrrv69scW4tdWeiG08b6Oo48XoOUTLlqYYE,602
 odoo/addons/sm_partago_invoicing/views/views_report_reservation_compute.xml,sha256=3JEd98aNWOSqazVZGEtwsbzA432-Ee86i8LhGwjKugY,1350
 odoo/addons/sm_partago_invoicing/views/views_res_config_settings.xml,sha256=XIqjRzIQvtxHslw_8vg6BruY0_KPo_oxn-w3GrAXebI,2123
 odoo/addons/sm_partago_invoicing/views/views_reservation_compute.xml,sha256=6Un4ceLaVDhVs5BVxDF5XIyXNECCnu155bCwhlpL1S4,5062
 odoo/addons/sm_partago_invoicing/views/views_teletacs.xml,sha256=YxchVFBA9chZCY626-fcyvyyhjWc9Yk6fXJEhUMMRmM,965
-odoo12_addon_sm_partago_invoicing-12.0.0.1.5.dist-info/METADATA,sha256=WXaxax7Lo9XfcKcQUONSsdLplrWhekAuWj85NkVZzSg,725
-odoo12_addon_sm_partago_invoicing-12.0.0.1.5.dist-info/WHEEL,sha256=z9j0xAa_JmUKMpmz72K0ZGALSM_n-wQVmGbleXx2VHg,110
-odoo12_addon_sm_partago_invoicing-12.0.0.1.5.dist-info/top_level.txt,sha256=qBj40grFkGOfDZ2WDSw3y1RnDlgG0u8rP8pvGNdbz4w,5
-odoo12_addon_sm_partago_invoicing-12.0.0.1.5.dist-info/RECORD,,
+odoo12_addon_sm_partago_invoicing-12.0.0.1.6.dist-info/METADATA,sha256=A8UpM9vWEVJaO_3zk79-0IWG61uQWNfcpnJ0CjD6r9w,681
+odoo12_addon_sm_partago_invoicing-12.0.0.1.6.dist-info/WHEEL,sha256=z9j0xAa_JmUKMpmz72K0ZGALSM_n-wQVmGbleXx2VHg,110
+odoo12_addon_sm_partago_invoicing-12.0.0.1.6.dist-info/top_level.txt,sha256=qBj40grFkGOfDZ2WDSw3y1RnDlgG0u8rP8pvGNdbz4w,5
+odoo12_addon_sm_partago_invoicing-12.0.0.1.6.dist-info/RECORD,,
```

