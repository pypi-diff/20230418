# Comparing `tmp/odoo12_addon_sm_partago_tariffs-12.0.0.0.6-py2.py3-none-any.whl.zip` & `tmp/odoo12_addon_sm_partago_tariffs-12.0.0.0.7-py2.py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,37 +1,39 @@
-Zip file size: 25487 bytes, number of entries: 35
--rw-r--r--  2.0 unx       46 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_tariffs/__init__.py
--rw-r--r--  2.0 unx     1476 b- defN 22-Dec-09 12:27 odoo/addons/sm_partago_tariffs/__manifest__.py
+Zip file size: 26840 bytes, number of entries: 37
+-rw-r--r--  2.0 unx       46 b- defN 23-Feb-15 12:56 odoo/addons/sm_partago_tariffs/__init__.py
+-rw-r--r--  2.0 unx     1347 b- defN 23-Apr-18 10:23 odoo/addons/sm_partago_tariffs/__manifest__.py
 -rw-r--r--  2.0 unx     2266 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_tariffs/email_tmpl/abouttoexpire_tariff_email.xml
 -rw-r--r--  2.0 unx     1075 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_tariffs/email_tmpl/notification_tariff_created.xml
--rw-r--r--  2.0 unx      615 b- defN 22-Dec-02 16:24 odoo/addons/sm_partago_tariffs/models/__init__.py
--rw-r--r--  2.0 unx      412 b- defN 22-Dec-02 16:24 odoo/addons/sm_partago_tariffs/models/models_carsharing_user_request.py
--rw-r--r--  2.0 unx      414 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_tariffs/models/models_cs_carconfig.py
--rw-r--r--  2.0 unx      822 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_tariffs/models/models_sm_company.py
--rw-r--r--  2.0 unx     8477 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_tariffs/models/models_sm_member.py
--rw-r--r--  2.0 unx      413 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_tariffs/models/models_smp_carconfig_price_group.py
--rw-r--r--  2.0 unx     2698 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_tariffs/models/models_smp_carsharing_send_email_tariff_wizard.py
--rw-r--r--  2.0 unx     6611 b- defN 22-Dec-02 16:24 odoo/addons/sm_partago_tariffs/models/models_smp_carsharing_tariff.py
--rw-r--r--  2.0 unx      586 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_tariffs/models/models_smp_carsharing_tariff_history.py
--rw-r--r--  2.0 unx     1377 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_tariffs/models/models_smp_carsharing_tariff_model.py
--rw-r--r--  2.0 unx      320 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_tariffs/models/models_smp_reservation_compute.py
--rw-r--r--  2.0 unx     1019 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_tariffs/models/models_smp_tariffmodel_price_group.py
--rw-r--r--  2.0 unx     1467 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_tariffs/models/models_smp_tariffs_cron.py
--rw-r--r--  2.0 unx     1344 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_tariffs/models/res_config_settings.py
--rw-r--r--  2.0 unx      737 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_tariffs/security/ir.model.access.csv
+-rw-r--r--  2.0 unx      632 b- defN 23-Apr-18 09:38 odoo/addons/sm_partago_tariffs/models/__init__.py
+-rw-r--r--  2.0 unx      430 b- defN 23-Mar-17 16:31 odoo/addons/sm_partago_tariffs/models/models_carsharing_user_request.py
+-rw-r--r--  2.0 unx      554 b- defN 23-Apr-18 09:38 odoo/addons/sm_partago_tariffs/models/models_cs_carconfig.py
+-rw-r--r--  2.0 unx      907 b- defN 23-Mar-17 16:31 odoo/addons/sm_partago_tariffs/models/models_sm_company.py
+-rw-r--r--  2.0 unx    10910 b- defN 23-Apr-18 10:10 odoo/addons/sm_partago_tariffs/models/models_sm_member.py
+-rw-r--r--  2.0 unx      445 b- defN 23-Mar-17 16:31 odoo/addons/sm_partago_tariffs/models/models_smp_carconfig_price_group.py
+-rw-r--r--  2.0 unx      448 b- defN 23-Apr-18 09:38 odoo/addons/sm_partago_tariffs/models/models_smp_carconfig_tariff_group.py
+-rw-r--r--  2.0 unx     2907 b- defN 23-Mar-17 16:31 odoo/addons/sm_partago_tariffs/models/models_smp_carsharing_send_email_tariff_wizard.py
+-rw-r--r--  2.0 unx     7163 b- defN 23-Apr-18 10:06 odoo/addons/sm_partago_tariffs/models/models_smp_carsharing_tariff.py
+-rw-r--r--  2.0 unx      620 b- defN 23-Mar-17 16:31 odoo/addons/sm_partago_tariffs/models/models_smp_carsharing_tariff_history.py
+-rw-r--r--  2.0 unx     1551 b- defN 23-Mar-17 16:31 odoo/addons/sm_partago_tariffs/models/models_smp_carsharing_tariff_model.py
+-rw-r--r--  2.0 unx      335 b- defN 23-Mar-17 16:31 odoo/addons/sm_partago_tariffs/models/models_smp_reservation_compute.py
+-rw-r--r--  2.0 unx     1114 b- defN 23-Mar-17 16:31 odoo/addons/sm_partago_tariffs/models/models_smp_tariffmodel_price_group.py
+-rw-r--r--  2.0 unx     1753 b- defN 23-Mar-17 16:31 odoo/addons/sm_partago_tariffs/models/models_smp_tariffs_cron.py
+-rw-r--r--  2.0 unx     1419 b- defN 23-Mar-17 16:31 odoo/addons/sm_partago_tariffs/models/res_config_settings.py
+-rw-r--r--  2.0 unx      849 b- defN 23-Apr-18 09:38 odoo/addons/sm_partago_tariffs/security/ir.model.access.csv
 -rw-r--r--  2.0 unx      144 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_tariffs/views/views.xml
 -rw-r--r--  2.0 unx     1691 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_tariffs/views/views_carconfig_price_group.xml
--rw-r--r--  2.0 unx     1227 b- defN 22-Dec-02 16:24 odoo/addons/sm_partago_tariffs/views/views_carsharing_user_request.xml
+-rw-r--r--  2.0 unx     1704 b- defN 23-Apr-18 09:38 odoo/addons/sm_partago_tariffs/views/views_carconfig_tariff_group.xml
+-rw-r--r--  2.0 unx     1227 b- defN 23-Jan-11 10:56 odoo/addons/sm_partago_tariffs/views/views_carsharing_user_request.xml
 -rw-r--r--  2.0 unx     1193 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_tariffs/views/views_cron.xml
--rw-r--r--  2.0 unx     1162 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_tariffs/views/views_cs_carconfig.xml
--rw-r--r--  2.0 unx     6444 b- defN 22-Dec-02 16:24 odoo/addons/sm_partago_tariffs/views/views_members.xml
+-rw-r--r--  2.0 unx     1214 b- defN 23-Apr-18 09:38 odoo/addons/sm_partago_tariffs/views/views_cs_carconfig.xml
+-rw-r--r--  2.0 unx     6444 b- defN 23-Jan-11 10:56 odoo/addons/sm_partago_tariffs/views/views_members.xml
 -rw-r--r--  2.0 unx     1354 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_tariffs/views/views_res_config_settings.xml
 -rw-r--r--  2.0 unx      599 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_tariffs/views/views_reservation_compute.xml
--rw-r--r--  2.0 unx     5633 b- defN 22-Dec-02 16:24 odoo/addons/sm_partago_tariffs/views/views_tariff.xml
+-rw-r--r--  2.0 unx     5308 b- defN 23-Apr-18 10:04 odoo/addons/sm_partago_tariffs/views/views_tariff.xml
 -rw-r--r--  2.0 unx      821 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_tariffs/views/views_tariff_history.xml
 -rw-r--r--  2.0 unx     2453 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_tariffs/views/views_tariff_model.xml
 -rw-r--r--  2.0 unx     1110 b- defN 22-Jun-28 13:09 odoo/addons/sm_partago_tariffs/views/views_tariffmodel_price_group.xml
--rw-r--r--  2.0 unx      708 b- defN 22-Dec-09 12:29 odoo12_addon_sm_partago_tariffs-12.0.0.0.6.dist-info/METADATA
--rw-r--r--  2.0 unx      110 b- defN 22-Dec-09 12:29 odoo12_addon_sm_partago_tariffs-12.0.0.0.6.dist-info/WHEEL
--rw-r--r--  2.0 unx        5 b- defN 22-Dec-09 12:29 odoo12_addon_sm_partago_tariffs-12.0.0.0.6.dist-info/top_level.txt
-?rw-rw-r--  2.0 unx     4128 b- defN 22-Dec-09 12:29 odoo12_addon_sm_partago_tariffs-12.0.0.0.6.dist-info/RECORD
-35 files, 60957 bytes uncompressed, 18395 bytes compressed:  69.8%
+-rw-r--r--  2.0 unx      672 b- defN 23-Apr-18 10:28 odoo12_addon_sm_partago_tariffs-12.0.0.0.7.dist-info/METADATA
+-rw-r--r--  2.0 unx      110 b- defN 23-Apr-18 10:28 odoo12_addon_sm_partago_tariffs-12.0.0.0.7.dist-info/WHEEL
+-rw-r--r--  2.0 unx        5 b- defN 23-Apr-18 10:28 odoo12_addon_sm_partago_tariffs-12.0.0.0.7.dist-info/top_level.txt
+?rw-rw-r--  2.0 unx     4385 b- defN 23-Apr-18 10:28 odoo12_addon_sm_partago_tariffs-12.0.0.0.7.dist-info/RECORD
+37 files, 67205 bytes uncompressed, 19310 bytes compressed:  71.3%
```

## zipnote {}

```diff
@@ -24,14 +24,17 @@
 
 Filename: odoo/addons/sm_partago_tariffs/models/models_sm_member.py
 Comment: 
 
 Filename: odoo/addons/sm_partago_tariffs/models/models_smp_carconfig_price_group.py
 Comment: 
 
+Filename: odoo/addons/sm_partago_tariffs/models/models_smp_carconfig_tariff_group.py
+Comment: 
+
 Filename: odoo/addons/sm_partago_tariffs/models/models_smp_carsharing_send_email_tariff_wizard.py
 Comment: 
 
 Filename: odoo/addons/sm_partago_tariffs/models/models_smp_carsharing_tariff.py
 Comment: 
 
 Filename: odoo/addons/sm_partago_tariffs/models/models_smp_carsharing_tariff_history.py
@@ -57,14 +60,17 @@
 
 Filename: odoo/addons/sm_partago_tariffs/views/views.xml
 Comment: 
 
 Filename: odoo/addons/sm_partago_tariffs/views/views_carconfig_price_group.xml
 Comment: 
 
+Filename: odoo/addons/sm_partago_tariffs/views/views_carconfig_tariff_group.xml
+Comment: 
+
 Filename: odoo/addons/sm_partago_tariffs/views/views_carsharing_user_request.xml
 Comment: 
 
 Filename: odoo/addons/sm_partago_tariffs/views/views_cron.xml
 Comment: 
 
 Filename: odoo/addons/sm_partago_tariffs/views/views_cs_carconfig.xml
@@ -87,20 +93,20 @@
 
 Filename: odoo/addons/sm_partago_tariffs/views/views_tariff_model.xml
 Comment: 
 
 Filename: odoo/addons/sm_partago_tariffs/views/views_tariffmodel_price_group.xml
 Comment: 
 
-Filename: odoo12_addon_sm_partago_tariffs-12.0.0.0.6.dist-info/METADATA
+Filename: odoo12_addon_sm_partago_tariffs-12.0.0.0.7.dist-info/METADATA
 Comment: 
 
-Filename: odoo12_addon_sm_partago_tariffs-12.0.0.0.6.dist-info/WHEEL
+Filename: odoo12_addon_sm_partago_tariffs-12.0.0.0.7.dist-info/WHEEL
 Comment: 
 
-Filename: odoo12_addon_sm_partago_tariffs-12.0.0.0.6.dist-info/top_level.txt
+Filename: odoo12_addon_sm_partago_tariffs-12.0.0.0.7.dist-info/top_level.txt
 Comment: 
 
-Filename: odoo12_addon_sm_partago_tariffs-12.0.0.0.6.dist-info/RECORD
+Filename: odoo12_addon_sm_partago_tariffs-12.0.0.0.7.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## odoo/addons/sm_partago_tariffs/__manifest__.py

```diff
@@ -1,45 +1,48 @@
 # -*- coding: utf-8 -*-
 {
-  'name': "sm_partago_tariffs",
+    'name': "sm_partago_tariffs",
 
-  'summary': """
+    'summary': """
     Dynamic and complex carsharing tariffs for the system
   """,
 
-  'description': """
+    'description': """
     Dynamic and complex carsharing tariffs for the system
   """,
 
-  'author': "Som Mobilitat",
-  'website': "http://www.sommobilitat.coop",
+    'author': "Som Mobilitat",
+    'website': "http://www.sommobilitat.coop",
 
-  # Categories can be used to filter modules in modules listing
-  # Check https://github.com/odoo/odoo/blob/master/openerp/addons/base/module/module_data.xml
-  # for the full list
-  'category': 'Mobility',
-  'version': '12.0.0.0.6',
+    'category': 'Mobility',
+    'version': '12.0.0.0.7',
 
-  # any module necessary for this one to work correctly
-  # 'depends': ['base', 'product', 'sommobilitat', 'sm_partago_user', 'sm_partago_db'],
-  'depends': ['base','vertical_carsharing','sm_partago_db','sm_carsharing_structure','sm_partago_usage','sm_partago_user'],
-  # always loaded
-  'data': [
-    'security/ir.model.access.csv',
-    'email_tmpl/abouttoexpire_tariff_email.xml',
-    'email_tmpl/notification_tariff_created.xml',
-    'views/views.xml',
-    'views/views_cron.xml',
-    'views/views_tariff.xml',
-    'views/views_carconfig_price_group.xml',
-    'views/views_tariffmodel_price_group.xml',
-    'views/views_tariff_history.xml',
-    'views/views_tariff_model.xml',
-    'views/views_members.xml',
-    'views/views_reservation_compute.xml',
-    'views/views_cs_carconfig.xml',
-    'views/views_res_config_settings.xml',
-    'views/views_carsharing_user_request.xml'
-  ],
-  # only loaded in demonstration mode
-  'demo': [],
+    'depends': [
+        'base',
+        'vertical_carsharing',
+        'sm_partago_db',
+        'sm_carsharing_structure',
+        'sm_partago_usage',
+        'sm_partago_user'
+    ],
+    # always loaded
+    'data': [
+        'security/ir.model.access.csv',
+        'email_tmpl/abouttoexpire_tariff_email.xml',
+        'email_tmpl/notification_tariff_created.xml',
+        'views/views.xml',
+        'views/views_cron.xml',
+        'views/views_tariff.xml',
+        'views/views_carconfig_price_group.xml',
+        'views/views_carconfig_tariff_group.xml',
+        'views/views_tariffmodel_price_group.xml',
+        'views/views_tariff_history.xml',
+        'views/views_tariff_model.xml',
+        'views/views_members.xml',
+        'views/views_reservation_compute.xml',
+        'views/views_cs_carconfig.xml',
+        'views/views_res_config_settings.xml',
+        'views/views_carsharing_user_request.xml'
+    ],
+    # only loaded in demonstration mode
+    'demo': [],
 }
```

## odoo/addons/sm_partago_tariffs/models/__init__.py

```diff
@@ -1,16 +1,16 @@
 # -*- coding: utf-8 -*-
 
 from . import models_cs_carconfig
 from . import models_smp_carsharing_tariff
 from . import models_smp_tariffmodel_price_group
 from . import models_smp_carconfig_price_group
+from . import models_smp_carconfig_tariff_group
 from . import models_smp_carsharing_tariff_model
 from . import models_smp_carsharing_send_email_tariff_wizard
 from . import models_sm_member
 from . import models_sm_company
 from . import models_smp_carsharing_tariff_history
 from . import models_smp_reservation_compute
 from . import models_smp_tariffs_cron
 from . import res_config_settings
 from . import models_carsharing_user_request
-# from . import smp_car_config
```

## odoo/addons/sm_partago_tariffs/models/models_carsharing_user_request.py

```diff
@@ -1,12 +1,13 @@
 # -*- coding: utf-8 -*-
 from odoo import models, fields, api
 from odoo.tools.translate import _
 
+
 class carsharing_user_request(models.Model):
-  _name = 'sm_partago_user.carsharing_user_request'
-  _inherit = 'sm_partago_user.carsharing_user_request'
-  
-  tariffs_ids = fields.One2many(
-    comodel_name='smp.sm_carsharing_tariff',
-    inverse_name='related_carsharing_user_request_id',
-    string=_("CS tariffs"))
+    _name = 'sm_partago_user.carsharing_user_request'
+    _inherit = 'sm_partago_user.carsharing_user_request'
+
+    tariffs_ids = fields.One2many(
+        comodel_name='smp.sm_carsharing_tariff',
+        inverse_name='related_carsharing_user_request_id',
+        string=_("CS tariffs"))
```

## odoo/addons/sm_partago_tariffs/models/models_cs_carconfig.py

```diff
@@ -1,12 +1,15 @@
 # -*- coding: utf-8 -*-
 
 from odoo import models, fields, api
 from odoo.tools.translate import _
 
 
 class smp_car_config(models.Model):
-  _inherit = 'sm_carsharing_structure.cs_carconfig'
-  _name = 'sm_carsharing_structure.cs_carconfig'
+    _inherit = 'sm_carsharing_structure.cs_carconfig'
+    _name = 'sm_carsharing_structure.cs_carconfig'
 
-  related_price_group_id = fields.Many2one('smp.sm_carconfig_price_group', string=_("Related price group"))
-  initial_price = fields.Float(string=_("Initial price (sense IVA)"))
+    related_price_group_id = fields.Many2one(
+        'smp.sm_carconfig_price_group', string=_("Related price group"))
+    related_tariff_group_id = fields.Many2one(
+        'smp.sm_carconfig_tariff_group', string=_("Related tariff group"))
+    initial_price = fields.Float(string=_("Initial price (sense IVA)"))
```

## odoo/addons/sm_partago_tariffs/models/models_sm_company.py

```diff
@@ -1,21 +1,28 @@
 # -*- coding: utf-8 -*-
 
 from odoo import models, fields, api
 from odoo.tools.translate import _
 
 
 class sm_company(models.Model):
-  _inherit = 'res.company'
+    _inherit = 'res.company'
+
+    default_tariff_model_id = fields.Many2one(
+        'smp.sm_carsharing_tariff_model',
+        string=_("Default tariff model"))
+    welcome_tariff_model_id = fields.Many2one(
+        'smp.sm_carsharing_tariff_model',
+        string=_("Welcome tariff model"))
+    pocketbook_threshold = fields.Float(
+        string=_("Pocketbook threshold for tariffs"))
+    default_welcome = fields.Text(
+        string=_("Default name for welcome tariffs"))
+    notification_tariff_creation_id = fields.Many2one(
+        'mail.template',
+        string=_("Notification tariff creation template"))
+    abouttoexpire_mail_template_id = fields.Many2one(
+        'mail.template',
+        string=_("About to expire tariffs notification template"))
 
-  default_tariff_model_id = fields.Many2one('smp.sm_carsharing_tariff_model',
-    string=_("Default tariff model"))
-  welcome_tariff_model_id = fields.Many2one('smp.sm_carsharing_tariff_model',
-    string=_("Welcome tariff model"))
-  pocketbook_threshold = fields.Float(string=_("Pocketbook threshold for tariffs"))
-  default_welcome = fields.Text(string=_("Default name for welcome tariffs"))
-  notification_tariff_creation_id = fields.Many2one('mail.template',
-    string=_("Notification tariff creation template"))
-  abouttoexpire_mail_template_id = fields.Many2one('mail.template',
-    string=_("About to expire tariffs notification template"))
 
 sm_company()
```

## odoo/addons/sm_partago_tariffs/models/models_sm_member.py

```diff
@@ -3,227 +3,283 @@
 import time
 from datetime import datetime, timedelta
 
 from odoo import models, fields, api
 from odoo.tools.translate import _
 from odoo.addons.sm_maintenance.models.models_sm_utils import sm_utils
 
+
 class sm_member(models.Model):
-  _inherit = 'res.partner'
-  _name = 'res.partner'
+    _inherit = 'res.partner'
+    _name = 'res.partner'
+
+    cs_tariffs_id = fields.One2many(
+        comodel_name='smp.sm_carsharing_tariff',
+        inverse_name='related_member_id',
+        string='Tariffs'
+    )
+    default_tariff_model_id = fields.Many2one(
+        'smp.sm_carsharing_tariff_model',
+        string=_("Default tariff model")
+    )
+    has_active_tariffs = fields.Boolean(
+        compute="_has_active_tariffs",
+        store=False
+    )
+    has_active_notabouttoexpire_tariffs = fields.Boolean(
+        compute="_has_active_notabouttoexpire_tariffs",
+        store=False
+    )
+
+    @api.depends('cs_tariffs_id')
+    def _has_active_tariffs(self):
+        for record in self:
+            record.has_active_tariffs = False
+            for tariff in record.cs_tariffs_id:
+                if tariff.closed is False:
+                    record.has_active_tariffs = True
+                    break
+
+    @api.depends('cs_tariffs_id')
+    def _has_active_notabouttoexpire_tariffs(self):
+        for record in self:
+            record.has_active_notclosetoexpire_tariffs = False
+            for tariff in record.cs_tariffs_id:
+                if tariff.closed is False and tariff.abouttoexpire is False:
+                    record.has_active_notclosetoexpire_tariffs = True
+                    break
+
+    def setup_cs_default_tariff(self):
+        company = self.env.user.company_id
+        if not self.default_tariff_model_id:
+            self.write({
+                'default_tariff_model_id': company.default_tariff_model_id.id
+            })
+        return True
+
+    def validate_cs_default_tariff_registration(self):
+        if not self.default_tariff_model_id.id:
+            return False
+        return True
+
+    def update_member_tariff_by_invoice_line(self, invoice_line):
+        carconfig_id = invoice_line.related_reservation_compute_id.carconfig_id
+        if self.has_special_tariff(carconfig_id):
+            tariff = self.get_special_tariff(carconfig_id)
+            if tariff.tariff_type == 'pocketbook':
+                resting_money = tariff.pocketbook - invoice_line.price_total
+                # update pocketbook tariff
+                if resting_money > 0:
+                    tariff.write({'pocketbook': resting_money})
+                else:
+                    tariff.write({'pocketbook': 0, 'closed': True})
+                # create tariff history entry
+                self.env['smp.sm_carsharing_tariff_history'].create({
+                    'name': invoice_line.name,
+                    'date': time.strftime("%Y-%m-%d"),
+                    'amount': -1 * invoice_line.price_total,
+                    'obs': 'REPORT: ' + str(invoice_line.invoice_report_id.name),
+                    'related_invoice_line_id': invoice_line.id,
+                    'related_tariff_id': tariff.id
+                })
+                invoice_line.write({'related_tariff_id': tariff.id})
+
+    def sanitize_tariffs(self):
+        if self.cs_tariffs_id.exists():
+            for tariff in self.cs_tariffs_id:
+                close_tariff = False
+                if tariff.tariff_type == 'pocketbook':
+                    if tariff.pocketbook <= 0:
+                        close_tariff = True
+                if tariff.tariff_type == 'time_frame':
+                    now = datetime.now()
+                    if tariff.date_valid:
+                        date_valid = datetime.strptime(
+                            str(tariff.date_valid) + ' 00:00:00',
+                            "%Y-%m-%d %H:%M:%S"
+                        )
+                        if date_valid < now:
+                            close_tariff = True
+                if close_tariff:
+                    tariff.write({
+                        'closed': True
+                    })
+        return True
 
-  cs_tariffs_id = fields.One2many(comodel_name='smp.sm_carsharing_tariff',
-    inverse_name='related_member_id', string='Tariffs')
-  default_tariff_model_id = fields.Many2one('smp.sm_carsharing_tariff_model', string=_("Default tariff model"))
-  has_active_tariffs = fields.Boolean(compute="_has_active_tariffs",store=False)
-  has_active_notabouttoexpire_tariffs = fields.Boolean(compute="_has_active_notabouttoexpire_tariffs",store=False)
-
-  @api.depends('cs_tariffs_id')
-  def _has_active_tariffs(self):
-    for record in self:
-      record.has_active_tariffs = False
-      for tariff in record.cs_tariffs_id:
-        if tariff.closed == False:
-          record.has_active_tariffs = True
-          break
-
-  @api.depends('cs_tariffs_id')
-  def _has_active_notabouttoexpire_tariffs(self):
-    for record in self:
-      record.has_active_notclosetoexpire_tariffs = False
-      for tariff in record.cs_tariffs_id:
-        if tariff.closed == False and tariff.abouttoexpire == False:
-          record.has_active_notclosetoexpire_tariffs = True
-          break
-
-  def setup_cs_default_tariff(self):
-    company = self.env.user.company_id
-    if not self.default_tariff_model_id:
-      self.write({
-        'default_tariff_model_id': company.default_tariff_model_id.id
-      })
-    return True
-
-  def validate_cs_default_tariff_registration(self):
-    if not self.default_tariff_model_id.id:
-      return False
-    return True
-
-  def update_member_tariff_by_invoice_line(self, invoice_line, compute_pb):
-    carconfig_id = invoice_line.related_reservation_compute_id.carconfig_id
-    if self.has_special_tariff(carconfig_id):
-      tariff = self.get_special_tariff(carconfig_id)
-      if tariff.tariff_type == 'pocketbook' and compute_pb == True:
-        resting_money = tariff.pocketbook - invoice_line.price_total
-        # update pocketbook tariff
-        if resting_money > 0:
-          tariff.write({'pocketbook': resting_money})
+    def get_special_tariff(self, rel_carconfig_id=False):
+        if rel_carconfig_id:
+            # check for rel_car tariffs
+            tariffs = self.env['smp.sm_carsharing_tariff'].search([
+                ('closed', '=', False),
+                ('related_member_id', '=', self.id),
+                ('tariff_type', '=', 'rel_car'),
+                ('related_carconfig_id', '=', rel_carconfig_id.id)
+            ])
+            if tariffs.exists():
+                if tariffs[0].id:
+                    return tariffs[0]
+            # check for rel_car_group tariffs
+            tariffs = self.env['smp.sm_carsharing_tariff'].search([
+                ('closed', '=', False),
+                ('related_member_id', '=', self.id),
+                ('tariff_type', '=', 'rel_car_group')
+            ])
+            if tariffs.exists():
+                for tariff in tariffs:
+                    if tariff.related_tariff_group_id:
+                        if (
+                            rel_carconfig_id.id in
+                            tariff.related_tariff_group_id.applied_carconfigs_id.mapped(
+                                lambda r: r.db_carconfig_id.id)
+                        ):
+                            return tariff
+        # check for pocketbook or timeframe Tariffs
+        # TODO: priority is based on date active ASC, question this strategy
+        tariffs = self.env['smp.sm_carsharing_tariff'].search([
+            ('closed', '=', False),
+            ('related_member_id', '=', self.id),
+            ('tariff_type', 'in', ('pocketbook', 'time_frame'))
+        ])
+        if tariffs.exists():
+            if tariffs[0].id:
+                return tariffs[0]
+        return False
+
+    def create_welcome_tariff_if_mising(self):
+        company = self.env.user.company_id
+        welcome_tariff = company.welcome_tariff_model_id
+        if not welcome_tariff:
+            return
+
+        e_tariffs = self.env['smp.sm_carsharing_tariff'].search([
+            ('related_member_id', '=', self.id)
+        ])
+        if e_tariffs.exists():
+            e_active = datetime.strptime(
+                str(e_tariffs[0].date_active), "%Y-%m-%d") + timedelta(-1)
+        else:
+            e_active = datetime.now()
+        query = [
+            ('name', '=', company.default_welcome),
+            ('related_member_id', '=', self.id)
+        ]
+
+        date_valid = e_active + timedelta(3 * 365 / 12) + timedelta(7)
+        creation_data = {
+            'name': company.default_welcome,
+            'date': e_active.isoformat(),
+            'date_active': e_active.isoformat(),
+            'date_valid': date_valid.isoformat(),
+            'tariff_model_id': welcome_tariff.id,
+            'related_member_id': self.id,
+            'tariff_type': 'time_frame',
+            'description': "<p>4€/hora 40€/dia<br/>Tarifa vàlida fins al " +
+            date_valid.strftime("%d/%m/%Y") + "</p>"
+        }
+        member_welcome_tariff = sm_utils.get_create_existing_model(
+            self.env['smp.sm_carsharing_tariff'], query, creation_data)
+
+    def get_default_tariff(self):
+        return {
+            # 'tariff_model_type': 'tariff',
+            'tariff_model_id': self.default_tariff_model_id,
+            'tariff_name': self.default_tariff_model_id.name,
+            'tariff_type': 'default',
+            'tariff_id': 0,
+            'tariff_aval': False
+        }
+
+    def get_current_tariff(self, rel_carconfig_id=False):
+        self.setup_cs_default_tariff()
+        self.create_welcome_tariff_if_mising()
+        special_tariff = self.get_special_tariff(rel_carconfig_id)
+        tariff_aval = False
+        extra_tariff_model_id = False
+        if not special_tariff:
+            return self.get_default_tariff()
+
+        if special_tariff.time_restricted:
+            tariff_aval = special_tariff.carconfig_availability
+            extra_tariff_model_id = special_tariff.extra_tariff_model_id
+        return {
+            'tariff_model_id': special_tariff.tariff_model_id,
+            'extra_tariff_model_id': extra_tariff_model_id,
+            'tariff_name': special_tariff.name,
+            'tariff_type': special_tariff.tariff_type,
+            'tariff_id': special_tariff.id,
+            'tariff_aval': tariff_aval
+        }
+
+    def create_carsharing_tariff(
+        self,
+        company_tariff,
+        days_to_subtract,
+        tariff_valid_months,
+        date
+    ):
+        if date == "Today":
+            date = datetime.today() - \
+                timedelta(days=days_to_subtract)  # Subtract one day
         else:
-          tariff.write({'pocketbook': 0, 'closed': True})
-        # create tariff history entry
-        self.env['smp.sm_carsharing_tariff_history'].create({
-          'name': invoice_line.name,
-          'date': time.strftime("%Y-%m-%d"),
-          'amount': -1 * invoice_line.price_total,
-          'obs': 'REPORT: ' + str(invoice_line.invoice_report_id.name),
-          'related_invoice_line_id': invoice_line.id,
-          'related_tariff_id': tariff.id
+            date = datetime.strptime(str(date), "%Y/%m/%d") - \
+                timedelta(days=days_to_subtract)
+
+        date_valid = date + \
+            timedelta(tariff_valid_months * 365 / 12)  # Add 3 months
+
+        date = date.strftime("%Y/%m/%d")
+        date_valid = date_valid.strftime("%Y/%m/%d")
+
+        self.env['smp.sm_carsharing_tariff'].create({
+            'name': company_tariff.name,
+            'date': date,
+            'date_active': date,
+            'date_valid': date_valid,
+            'tariff_model_id': company_tariff.id
         })
-        invoice_line.write({'related_tariff_id': tariff.id})
 
-  def sanitize_tariffs(self):
-    if self.cs_tariffs_id.exists():
-      for tariff in self.cs_tariffs_id:
-        close_tariff = False
-        if tariff.tariff_type == 'pocketbook':
-          if tariff.pocketbook <= 0:
-            close_tariff = True
-        if tariff.tariff_type == 'time_frame':
-          now = datetime.now()
-          if tariff.date_valid:
-            date_valid = datetime.strptime(str(tariff.date_valid) + ' 00:00:00', "%Y-%m-%d %H:%M:%S")
-            if date_valid < now:
-              close_tariff = True
-        if close_tariff:
-          tariff.write({
-            'closed': True
-          })
-    return True
-
-  def get_special_tariff(self, rel_carconfig_id=False):
-    if rel_carconfig_id:
-      tariffs = self.env['smp.sm_carsharing_tariff'].sudo().search(
-        [('closed', '=', False), ('related_member_id', '=', self.id),
-         ('related_carconfig_id', '=', rel_carconfig_id.id)])
-      if tariffs.exists():
-        if tariffs[0].id:
-          return tariffs[0]
-      # if rel_carconfig_id.rel_tariff_model_id.id:
-      #     return {'tariff_model': rel_carconfig_id.rel_tariff_model_id}
-
-    tariffs = self.env['smp.sm_carsharing_tariff'].sudo().search(
-      [('closed', '=', False), ('related_member_id', '=', self.id), ('tariff_type', '!=', 'rel_car')])
-    if tariffs.exists():
-      if tariffs[0].id:
-        return tariffs[0]
-    return False
-
-  def create_welcome_tariff_if_mising(self):
-    company = self.env.user.company_id
-    welcome_tariff = company.welcome_tariff_model_id
-    if not welcome_tariff:
-      return
-
-    e_tariffs = self.env['smp.sm_carsharing_tariff'].search([
-      ('related_member_id', '=', self.id)
-    ])
-    if e_tariffs.exists():
-      e_active = datetime.strptime(str(e_tariffs[0].date_active), "%Y-%m-%d") + timedelta(-1)
-    else:
-      e_active = datetime.now()
-    query = [
-      ('name', '=', company.default_welcome),
-      ('related_member_id', '=', self.id)
-    ]
-    
-    date_valid = e_active + timedelta(3 * 365 / 12) + timedelta(7)
-    creation_data = {
-      'name': company.default_welcome,
-      'date': e_active.isoformat(),
-      'date_active': e_active.isoformat(),
-      'date_valid': date_valid.isoformat(),
-      'tariff_model_id': welcome_tariff.id,
-      'related_member_id': self.id,
-      'tariff_type': 'time_frame',
-      'description': "<p>4€/hora 40€/dia<br/>Tarifa vàlida fins al " + date_valid.strftime(
-        "%d/%m/%Y") + "</p>"
-    }
-    member_welcome_tariff = sm_utils.get_create_existing_model(
-      self.env['smp.sm_carsharing_tariff'], query, creation_data)
-
-  def get_default_tariff(self):
-    return {
-      # 'tariff_model_type': 'tariff',
-      'tariff_model_id': self.default_tariff_model_id,
-      'tariff_name': self.default_tariff_model_id.name,
-      'tariff_type': 'default',
-      'tariff_id': 0,
-      'tariff_aval': False
-    }
-
-  def get_current_tariff(self, rel_carconfig_id=False):
-    self.setup_cs_default_tariff()
-    self.create_welcome_tariff_if_mising()
-    special_tariff = self.get_special_tariff(rel_carconfig_id)
-    tariff_aval = False
-    extra_tariff_model_id = False
-    if not special_tariff:
-      return self.get_default_tariff()
-
-    if special_tariff.time_restricted:
-      tariff_aval = special_tariff.carconfig_availability
-      extra_tariff_model_id = special_tariff.extra_tariff_model_id
-    return {
-      'tariff_model_id': special_tariff.tariff_model_id,
-      'extra_tariff_model_id': extra_tariff_model_id,
-      'tariff_name': special_tariff.name,
-      'tariff_type': special_tariff.tariff_type,
-      'tariff_id': special_tariff.id,
-      'tariff_aval': tariff_aval
-      }
-
-  def create_carsharing_tariff(self, company_tariff, days_to_subtract, tariff_valid_months, date):
-    if date == "Today":
-      date = datetime.today() - timedelta(days=days_to_subtract)  # Subtract one day
-    else:
-      date = datetime.strptime(str(date), "%Y/%m/%d") - timedelta(days=days_to_subtract)
-
-    date_valid = date + timedelta(tariff_valid_months * 365 / 12)  # Add 3 months
-
-    date = date.strftime("%Y/%m/%d")
-    date_valid = date_valid.strftime("%Y/%m/%d")
-
-    self.env['smp.sm_carsharing_tariff'].create({
-      'name': company_tariff.name,
-      'date': date,
-      'date_active': date,
-      'date_valid': date_valid,
-      'tariff_model_id': company_tariff.id
-    })
-
-  def tariff_already_defined(self, tariff_to_check, tariff_list):
-    for tariff in tariff_list:
-      if tariff.tariff_model_id == tariff_to_check:
+    def tariff_already_defined(self, tariff_to_check, tariff_list):
+        for tariff in tariff_list:
+            if tariff.tariff_model_id == tariff_to_check:
+                return True
+
+    def has_special_tariff(self, rel_carconfig_id=False):
+        special_tariff = self.get_special_tariff(rel_carconfig_id)
+        if not special_tariff:
+            return False
         return True
 
-  def has_special_tariff(self, rel_carconfig_id=False):
-    special_tariff = self.get_special_tariff(rel_carconfig_id)
-    if not special_tariff:
-      return False
-    return True
-    
-  @api.model
-  def get_send_email_tariff_wizard_view(self):
-    view_ref = self.env['ir.ui.view'].sudo().search(
-      [('name', '=', 'sm_partago_tariffs.carsharing_send_email_tariff.wizard.form')])
-    return view_ref.id
-
-  @api.model
-  def get_send_email_tariff_view(self):
-    if self.env.context:
-      if 'active_ids' in self.env.context:
-        members = self.env['res.partner'].browse(self.env.context['active_ids'])
-        if members.exists():
-          for member in members:
-            data = {'current_member_id': member.id}
-            return {
-              'type': 'ir.actions.act_window',
-              'name': "Create tariff",
-              'res_model': 'sm_carsharing_send_email_tariff.wizard',
-              'view_type': 'form',
-              'view_mode': 'form',
-              'res_id': self.env['sm_carsharing_send_email_tariff.wizard'].create(data).id,
-              'view_id': self.get_send_email_tariff_wizard_view(),
-              'target': 'new',
-            }
+    @api.model
+    def get_send_email_tariff_wizard_view(self):
+        view_ref = self.env['ir.ui.view'].sudo().search([
+            (
+                'name',
+                '=',
+                'sm_partago_tariffs.carsharing_send_email_tariff.wizard.form'
+            )
+        ])
+        return view_ref.id
+
+    @api.model
+    def get_send_email_tariff_view(self):
+        if self.env.context:
+            if 'active_ids' in self.env.context:
+                members = self.env['res.partner'].browse(
+                    self.env.context['active_ids'])
+                if members.exists():
+                    for member in members:
+                        data = {'current_member_id': member.id}
+                        return {
+                            'type': 'ir.actions.act_window',
+                            'name': "Create tariff",
+                            'res_model': 'sm_carsharing_send_email_tariff.wizard',
+                            'view_type': 'form',
+                            'view_mode': 'form',
+                            'res_id': self.env[
+                                'sm_carsharing_send_email_tariff.wizard'
+                            ].create(data).id,
+                            'view_id': self.get_send_email_tariff_wizard_view(),
+                            'target': 'new',
+                        }
+
 
 sm_member()
```

## odoo/addons/sm_partago_tariffs/models/models_smp_carconfig_price_group.py

```diff
@@ -1,14 +1,16 @@
 # -*- coding: utf-8 -*-
 
 from odoo import models, fields
 from odoo.tools.translate import _
 
 
 class smp_carconfig_price_group(models.Model):
-  _name = 'smp.sm_carconfig_price_group'
+    _name = 'smp.sm_carconfig_price_group'
 
-  name = fields.Char(string=_("Name"))
-  applied_carconfigs_id = fields.One2many(comodel_name='sm_carsharing_structure.cs_carconfig',
-  inverse_name='related_price_group_id',string=_("Applied carconfigs"))
+    name = fields.Char(string=_("Name"))
+    applied_carconfigs_id = fields.One2many(
+        comodel_name='sm_carsharing_structure.cs_carconfig',
+        inverse_name='related_price_group_id',
+        string=_("Applied carconfigs"))
 
-  _order = "name desc"
+    _order = "name desc"
```

## odoo/addons/sm_partago_tariffs/models/models_smp_carsharing_send_email_tariff_wizard.py

```diff
@@ -3,74 +3,66 @@
 from odoo import models, fields, api
 from odoo.tools.translate import _
 from odoo.addons.sm_maintenance.models.models_sm_utils import sm_utils
 from odoo.addons.sm_connect.models.models_sm_carsharing_db_utils import sm_carsharing_db_utils
 
 
 class sm_carsharing_send_email_tariff_wizard(models.TransientModel):
-  _name = "sm_carsharing_send_email_tariff.wizard"
+    _name = "sm_carsharing_send_email_tariff.wizard"
 
-  name = fields.Char(string=_("Name"))
-  reason = fields.Char(string=_("Reason"))
-  current_member_id = fields.Many2one(
-    'res.partner', string=_('Member'))  # ocult
-
-  tariff_model_id = fields.Many2one(
-    'smp.sm_carsharing_tariff_model', string=_("Related tariff model"))
-
-  tariff_type = fields.Selection([
-    ('pocketbook', 'PocketBook'),
-    ('time_frame', 'Time Frame'),
-    ('rel_car', 'Related car')],
-    string=_('Type'))
-
-  date = fields.Date(string=_("Date"))
-  date_active = fields.Date(string=_("Start Date"))
-
-  pocketbook_initial = fields.Integer(string=_("Initial Pocketbook"))
-  pocketbook_threshold = fields.Float(string=_("Pocketbook threshold"))
-  pocketbook = fields.Float(string=_("Pocketbook"))
-
-  date_valid = fields.Date(string=_("Valid until"))
-
-  time_restricted = fields.Boolean(string=_("Has time restrictions?"))
-  related_carconfig_id = fields.Many2one(
-    'smp.sm_car_config', string=_("Related CarConfig"))
-
-  carconfig_availability = fields.Char(string=_("CarConfig availability"))
-  extra_tariff_model_id = fields.Many2one(
-    'smp.sm_carsharing_tariff_model', string=_("Extra time related tariff model"))
-
-  description = fields.Html(string=_("Description"))
-
-  notify = fields.Boolean(string=_("Send notification?"), default=True)
-
-  @api.multi
-  def send_email_tariff(self):
-    self.create_tariff()
-    return True
-
-  @api.multi
-  def create_tariff(self):
-    record = self.env['smp.sm_carsharing_tariff'].create({
-      'name': self.name,
-      'reason': self.reason,
-      'related_member_id': self.current_member_id.id,
-      'tariff_model_id': self.tariff_model_id.id,
-      'tariff_type': self.tariff_type,
-      'date': self.date,
-      'date_active': self.date_active,
-      'pocketbook_initial': self.pocketbook_initial,
-      'pocketbook_threshold': self.pocketbook_threshold,
-      'pocketbook': self.pocketbook,
-      'date_valid': self.date_valid,
-      'time_restricted': self.time_restricted,
-      'related_carconfig_id': self.related_carconfig_id.id,
-      'carconfig_availability': self.carconfig_availability,
-      'extra_tariff_model_id': self.extra_tariff_model_id.id,
-      'description': self.description
-    })
-    if self.notify:
-      sm_utils.send_email_from_template(
-        record, 'notification_tariff_creation_id')
+    name = fields.Char(string=_("Name"))
+    reason = fields.Char(string=_("Reason"))
+    current_member_id = fields.Many2one(
+        'res.partner', string=_('Member'))  # ocult
+    tariff_model_id = fields.Many2one(
+        'smp.sm_carsharing_tariff_model', string=_("Related tariff model"))
+    tariff_type = fields.Selection([
+        ('pocketbook', 'PocketBook'),
+        ('time_frame', 'Time Frame'),
+        ('rel_car', 'Related car')],
+        string=_('Type'))
+    date = fields.Date(string=_("Date"))
+    date_active = fields.Date(string=_("Start Date"))
+    pocketbook_initial = fields.Integer(string=_("Initial Pocketbook"))
+    pocketbook_threshold = fields.Float(string=_("Pocketbook threshold"))
+    pocketbook = fields.Float(string=_("Pocketbook"))
+    date_valid = fields.Date(string=_("Valid until"))
+    time_restricted = fields.Boolean(string=_("Has time restrictions?"))
+    related_carconfig_id = fields.Many2one(
+        'smp.sm_car_config', string=_("Related CarConfig"))
+    carconfig_availability = fields.Char(string=_("CarConfig availability"))
+    extra_tariff_model_id = fields.Many2one(
+        'smp.sm_carsharing_tariff_model',
+        string=_("Extra time related tariff model"))
+    description = fields.Html(string=_("Description"))
+    notify = fields.Boolean(string=_("Send notification?"), default=True)
+
+    @api.multi
+    def send_email_tariff(self):
+        self.create_tariff()
+        return True
+
+    @api.multi
+    def create_tariff(self):
+        record = self.env['smp.sm_carsharing_tariff'].create({
+            'name': self.name,
+            'reason': self.reason,
+            'related_member_id': self.current_member_id.id,
+            'tariff_model_id': self.tariff_model_id.id,
+            'tariff_type': self.tariff_type,
+            'date': self.date,
+            'date_active': self.date_active,
+            'pocketbook_initial': self.pocketbook_initial,
+            'pocketbook_threshold': self.pocketbook_threshold,
+            'pocketbook': self.pocketbook,
+            'date_valid': self.date_valid,
+            'time_restricted': self.time_restricted,
+            'related_carconfig_id': self.related_carconfig_id.id,
+            'carconfig_availability': self.carconfig_availability,
+            'extra_tariff_model_id': self.extra_tariff_model_id.id,
+            'description': self.description
+        })
+        if self.notify:
+            sm_utils.send_email_from_template(
+                record, 'notification_tariff_creation_id')
 
-    return True
+        return True
```

## odoo/addons/sm_partago_tariffs/models/models_smp_carsharing_tariff.py

```diff
@@ -1,152 +1,180 @@
-  # -*- coding: utf-8 -*-
+# -*- coding: utf-8 -*-
 
 from datetime import datetime, timedelta
 
 from odoo import models, fields, api
 from odoo.tools.translate import _
 from odoo.addons.sm_maintenance.models.models_sm_resources import sm_resources
 
 
 class smp_carsharing_tariff(models.Model):
-  _name = 'smp.sm_carsharing_tariff'
-  
-  name = fields.Char(string=_("Name"))
-  reason = fields.Char(string=_("Reason"))
-  date = fields.Date(string=_("Date"), required="True")
-  date_active = fields.Date(string=_("Start Date"), required="True")
-  date_valid = fields.Date(string=_("Valid until"))
-  tariff_model_id = fields.Many2one('smp.sm_carsharing_tariff_model', string=_("Related tariff model"))
-  extra_tariff_model_id = fields.Many2one('smp.sm_carsharing_tariff_model',
-    string=_("Extra  time related tariff model"))
-  time_restricted = fields.Boolean(string=_("Has time restrictions?"))
-  related_member_id = fields.Many2one('res.partner', string=_("Related member"))
-  related_carconfig_id = fields.Many2one('smp.sm_car_config', string=_("Related CarConfig"))
-  carconfig_availability = fields.Char(string=_("CarConfig availability"))
-  pocketbook = fields.Float(string=_("Pocketbook"))
-  closed = fields.Boolean(string=_("Closed"))
-  tariff_history_ids = fields.One2many(comodel_name='smp.sm_carsharing_tariff_history',
-    inverse_name='related_tariff_id', string=_("Tariff history"))
-  description = fields.Html(string=_("Description"))
-  abouttoexpire = fields.Boolean(string=_("about to expire"), compute="_check_if_abouttoexpire",
-    store=False)
-  abouttoexpire_member_notified = fields.Boolean(string=_("About to expire member notified"))
-  tariff_type = fields.Selection([
-    ('pocketbook', 'PocketBook'),
-    ('time_frame', 'Time Frame'),
-    ('rel_car', 'Related car')],
-    string=_('Type'), required="True")
-  
-  pocketbook_threshold = fields.Float(string=_("Pocketbook threshold"))
-  
-  pocketbook_initial = fields.Integer(string=_("Initial Pocketbook"))
-  related_carsharing_user_request_id = fields.Many2one('sm_partago_user.carsharing_user_request', string=_("Related Carsharing user request"))
-  
-  _order = "date_active asc"
-
-  @api.multi
-  def recompute_pb_tariff(self):
-    if self.env.context:
-      if 'active_ids' in self.env.context:
-        tariffs = self.env['smp.sm_carsharing_tariff'].browse(self.env.context['active_ids'])
-        if tariffs.exists():
-          for tariff in tariffs:
-            if tariff.tariff_type == 'pocketbook':
-              for t_history in tariff.tariff_history_ids:
-                if abs(t_history.amount) < t_history.related_invoice_line_id.price_total and t_history.amount<0:
-                  remove_from_th = t_history.related_invoice_line_id.price_total + t_history.amount
-                  tariff.write({
-                    'pocketbook': tariff.pocketbook - remove_from_th
-                  })
-                  t_history.write({
-                    'amount': -1*t_history.related_invoice_line_id.price_total
-                  })
-              tariff.related_member_id.sanitize_tariffs()
-
-    return sm_resources.getInstance().get_successful_action_message(self,
-      _('Tariff pb recomputed done successfully'),self._name)
-
-  @api.multi
-  def mark_as_notified(self):
-    if self.env.context:
-      if 'active_ids' in self.env.context:
-        tariffs = self.env['smp.sm_carsharing_tariff'].browse(self.env.context['active_ids'])
-        if tariffs.exists():
-          for tariff in tariffs:
-            tariff.write({'abouttoexpire_member_notified': True})
-    return sm_resources.getInstance().get_successful_action_message(self,
-      _('Mark as notified done successfully'), self._name)
-
-  @api.depends('tariff_type', 'pocketbook', 'date_valid')
-  def _check_if_abouttoexpire(self):
-    for record in self:
-      abouttoexpire = False
-      if record.tariff_type == 'pocketbook':
+    _name = 'smp.sm_carsharing_tariff'
+
+    name = fields.Char(string=_("Name"))
+    reason = fields.Char(string=_("Reason"))
+    date = fields.Date(string=_("Date"), required="True")
+    date_active = fields.Date(string=_("Start Date"), required="True")
+    date_valid = fields.Date(string=_("Valid until"))
+    tariff_model_id = fields.Many2one(
+        'smp.sm_carsharing_tariff_model',
+        string=_("Related tariff model")
+    )
+    extra_tariff_model_id = fields.Many2one(
+        'smp.sm_carsharing_tariff_model',
+        string=_("Extra  time related tariff model")
+    )
+    time_restricted = fields.Boolean(string=_("Has time restrictions?"))
+    related_member_id = fields.Many2one(
+        'res.partner', string=_("Related member"))
+    related_carconfig_id = fields.Many2one(
+        'smp.sm_car_config',
+        string=_("Related CarConfig")
+    )
+    carconfig_availability = fields.Char(string=_("CarConfig availability"))
+    pocketbook = fields.Float(string=_("Pocketbook"))
+    closed = fields.Boolean(string=_("Closed"))
+    tariff_history_ids = fields.One2many(
+        comodel_name='smp.sm_carsharing_tariff_history',
+        inverse_name='related_tariff_id',
+        string=_("Tariff history")
+    )
+    description = fields.Html(string=_("Description"))
+    abouttoexpire = fields.Boolean(
+        string=_("about to expire"),
+        compute="_check_if_abouttoexpire",
+        store=False
+    )
+    abouttoexpire_member_notified = fields.Boolean(
+        string=_("About to expire member notified")
+    )
+    tariff_type = fields.Selection([
+        ('pocketbook', 'PocketBook'),
+        ('time_frame', 'Time Frame'),
+        ('rel_car', 'Related car'),
+        ('rel_car_group', 'Related car group')],
+        string=_('Type'), required="True")
+
+    pocketbook_threshold = fields.Float(string=_("Pocketbook threshold"))
+    pocketbook_initial = fields.Integer(string=_("Initial Pocketbook"))
+    related_carsharing_user_request_id = fields.Many2one(
+        'sm_partago_user.carsharing_user_request',
+        string=_("Related Carsharing user request"))
+    related_tariff_group_id = fields.Many2one(
+        'smp.sm_carconfig_tariff_group',
+        string=_("Related tariff group"))
+
+    _order = "date_active asc"
+
+    @api.multi
+    def mark_as_notified(self):
+        if self.env.context:
+            if 'active_ids' in self.env.context:
+                tariffs = self.env['smp.sm_carsharing_tariff'].browse(
+                    self.env.context['active_ids'])
+                if tariffs.exists():
+                    for tariff in tariffs:
+                        tariff.write({'abouttoexpire_member_notified': True})
+        return sm_resources.getInstance().get_successful_action_message(
+            self,
+            _('Mark as notified done successfully'),
+            self._name
+        )
+
+    @api.depends('tariff_type', 'pocketbook', 'date_valid')
+    def _check_if_abouttoexpire(self):
+        for record in self:
+            abouttoexpire = False
+            if record.tariff_type == 'pocketbook':
+                company = self.env.user.company_id
+                if record.pocketbook_threshold > 0:
+                    if (
+                        record.pocketbook <=
+                        record.pocketbook_initial *
+                            (record.pocketbook_threshold / 100)
+                    ):
+                        abouttoexpire = True
+                else:
+                    if (
+                        record.pocketbook <=
+                        record.pocketbook_initial *
+                            (company.pocketbook_threshold / 100)
+                    ):
+                        abouttoexpire = True
+
+            if record.tariff_type == 'time_frame':
+                if record.date_valid:
+                    date_valid = datetime.strptime(
+                        str(record.date_valid), "%Y-%m-%d").date()
+                    now = datetime.now().date()
+                    if date_valid >= now:
+                        if (date_valid - now).days <= 35:
+                            abouttoexpire = True
+
+            record.abouttoexpire = abouttoexpire
+
+    @api.multi
+    def search_descriptions(self):
+        if self.env.context:
+            if 'active_ids' in self.env.context:
+                tariffs = self.env['smp.sm_carsharing_tariff'].browse(
+                    self.env.context['active_ids'])
+                if tariffs.exists():
+                    for tariff in tariffs:
+                        tariff_type = tariff.tariff_model_id.name
+                        model_tariff_description = \
+                            tariff.tariff_model_id.description
+                        if model_tariff_description:
+                            company = self.env.user.company_id
+
+                            if tariff_type == company.default_welcome:
+
+                                date_valid = tariff.date_valid
+                                if not date_valid:
+                                    date_valid = self.calculateDateValid()
+
+                                new_description = \
+                                    model_tariff_description + \
+                                    " " + date_valid + "</p>"
+
+                                tariff.write({'description': new_description})
+                            else:
+                                date_valid = self.calculateDateValid()
+                                tariff.write({
+                                    'description':
+                                        tariff.tariff_model_id.description,
+                                    'date_valid': date_valid
+                                })
+
+        return sm_resources.getInstance().get_successful_action_message(
+            self,
+            _('Search description done successfully'),
+            self._name
+        )
+
+    @api.constrains('tariff_model_id')
+    def go_for_tariff_model_description(self):
+        self.write({'description': self.tariff_model_id.description})
+
+    def calculateDateValid(self):
         company = self.env.user.company_id
-        if record.pocketbook_threshold > 0:
-          if record.pocketbook <= record.pocketbook_initial * (record.pocketbook_threshold / 100):
-            abouttoexpire = True
-        else:
-          if record.pocketbook <= record.pocketbook_initial * (company.pocketbook_threshold / 100):
-            abouttoexpire = True
-
-      if record.tariff_type == 'time_frame':
-        if record.date_valid:
-          date_valid = datetime.strptime(
-            str(record.date_valid), "%Y-%m-%d").date()
-          now = datetime.now().date()
-          if date_valid >= now:
-            if (date_valid - now).days <= 35:
-              abouttoexpire = True
-
-      record.abouttoexpire = abouttoexpire
-
-  @api.multi
-  def search_descriptions(self):
-    if self.env.context:
-      if 'active_ids' in self.env.context:
-        tariffs = self.env['smp.sm_carsharing_tariff'].browse(self.env.context['active_ids'])
-        if tariffs.exists():
-          for tariff in tariffs:
-            tariff_type = tariff.tariff_model_id.name
-            model_tariff_description = tariff.tariff_model_id.description
-            if model_tariff_description:
-              company = self.env.user.company_id
-
-              if tariff_type == company.default_welcome:
-
-                date_valid = tariff.date_valid
-                if not date_valid:
-                  date_valid = self.calculateDateValid()
-
-                new_description = model_tariff_description + " " + date_valid + "</p>"
-
-                tariff.write({'description': new_description})
-              else:
-                date_valid = self.calculateDateValid()
-                tariff.write({'description': tariff.tariff_model_id.description,
-                        'date_valid': date_valid})
-
-    return sm_resources.getInstance().get_successful_action_message(self,
-      _('Search description done successfully'), self._name)
-
-  @api.constrains('tariff_model_id')
-  def go_for_tariff_model_description(self):
-    self.write({'description': self.tariff_model_id.description})
-
-  def calculateDateValid(self):
-    company = self.env.user.company_id
-    welcome_tariffs_duration = company.sm_tariff_month_duration_welcome
-    if self.tariff_model_id.id == self.env.user.company_id.welcome_tariff_model_id.id:
-      if welcome_tariffs_duration:
-        duration = welcome_tariffs_duration
-        if self.date_active:
-          return datetime.strptime(str(self.date_active), "%Y-%m-%d") + timedelta(duration * 365 / 12)
-    return False
-
-  def check_if_primary_tariff(self):
-    current_member = self.related_member_id
-    if current_member:
-      primary_tariff = current_member.get_current_tariff(False)
-      if self.id == primary_tariff['tariff_id']:
-        return True
-    return False
+        welcome_tariffs_duration = company.sm_tariff_month_duration_welcome
+        if (
+            self.tariff_model_id.id ==
+            self.env.user.company_id.welcome_tariff_model_id.id
+        ):
+            if welcome_tariffs_duration:
+                duration = welcome_tariffs_duration
+                if self.date_active:
+                    return datetime.strptime(
+                        str(self.date_active),
+                        "%Y-%m-%d"
+                    ) + timedelta(duration * 365 / 12)
+        return False
+
+    def check_if_primary_tariff(self):
+        current_member = self.related_member_id
+        if current_member:
+            primary_tariff = current_member.get_current_tariff(False)
+            if self.id == primary_tariff['tariff_id']:
+                return True
+        return False
```

## odoo/addons/sm_partago_tariffs/models/models_smp_carsharing_tariff_history.py

```diff
@@ -1,17 +1,19 @@
 # -*- coding: utf-8 -*-
 
 from odoo import models, fields
 from odoo.tools.translate import _
 
 
 class smp_carsharing_tariff(models.Model):
-  _name = 'smp.sm_carsharing_tariff_history'
+    _name = 'smp.sm_carsharing_tariff_history'
 
-  name = fields.Char(string=_("Name"), required=True)
-  date = fields.Date(string=_("Date"))
-  amount = fields.Float(string=_("Amount"))
-  obs = fields.Char(string=_("Observations"))
-  related_invoice_line_id = fields.Many2one('account.invoice.line', string=_("Related Invoice Line"))
-  related_tariff_id = fields.Many2one('smp.sm_carsharing_tariff', string=_("Related Tariff"))
+    name = fields.Char(string=_("Name"), required=True)
+    date = fields.Date(string=_("Date"))
+    amount = fields.Float(string=_("Amount"))
+    obs = fields.Char(string=_("Observations"))
+    related_invoice_line_id = fields.Many2one(
+        'account.invoice.line', string=_("Related Invoice Line"))
+    related_tariff_id = fields.Many2one(
+        'smp.sm_carsharing_tariff', string=_("Related Tariff"))
 
-  _order = "date desc"
+    _order = "date desc"
```

## odoo/addons/sm_partago_tariffs/models/models_smp_carsharing_tariff_model.py

```diff
@@ -1,35 +1,40 @@
 # -*- coding: utf-8 -*-
 
 from odoo import models, fields
 from odoo.tools.translate import _
 
 
 class smp_carsharing_tariff_model(models.Model):
-  _name = 'smp.sm_carsharing_tariff_model'
+    _name = 'smp.sm_carsharing_tariff_model'
 
-  name = fields.Char(string=_("Name"))
-  description = fields.Char(string=_("Description"))
-  cs_mins_product_id = fields.Many2one('product.product', string=_("Mins product"))
-  cs_days_product_id = fields.Many2one('product.product', string=_("Days product"))
-  cs_mileage_product_id = fields.Many2one('product.product', string=_("Mileage product"))
-  price_groups_id = fields.One2many(comodel_name='smp.sm_tariffmodel_price_group',
-    inverse_name='rel_tariff_model_id', string=_("Price Groups"))
-  rel_tariffs_id = fields.One2many(comodel_name='smp.sm_carsharing_tariff',
-    inverse_name='tariff_model_id', string=_("Related tariffs"))
-
-  _order = "name desc"
-
-  def get_prices(self,cs_carconfig=False):
-    if cs_carconfig:
-      for pg in self.price_groups_id:
-        if pg.applied_carconfig_price_group_id.id == cs_carconfig.related_price_group_id.id:
-          return {
-            'day_price': pg.cs_days_product_id,
-            'min_price': pg.cs_mins_product_id,
-            'kms_price': pg.cs_mileage_product_id
-          }
-    return {
-      'day_price': self.cs_days_product_id,
-      'min_price': self.cs_mins_product_id,
-      'kms_price': self.cs_mileage_product_id
-    }
+    name = fields.Char(string=_("Name"))
+    description = fields.Char(string=_("Description"))
+    cs_mins_product_id = fields.Many2one(
+        'product.product', string=_("Mins product"))
+    cs_days_product_id = fields.Many2one(
+        'product.product', string=_("Days product"))
+    cs_mileage_product_id = fields.Many2one(
+        'product.product', string=_("Mileage product"))
+    price_groups_id = fields.One2many(
+        comodel_name='smp.sm_tariffmodel_price_group',
+        inverse_name='rel_tariff_model_id', string=_("Price Groups"))
+    rel_tariffs_id = fields.One2many(
+        comodel_name='smp.sm_carsharing_tariff',
+        inverse_name='tariff_model_id', string=_("Related tariffs"))
+
+    _order = "name desc"
+
+    def get_prices(self, cs_carconfig=False):
+        if cs_carconfig:
+            for pg in self.price_groups_id:
+                if pg.applied_carconfig_price_group_id.id == cs_carconfig.related_price_group_id.id:
+                    return {
+                        'day_price': pg.cs_days_product_id,
+                        'min_price': pg.cs_mins_product_id,
+                        'kms_price': pg.cs_mileage_product_id
+                    }
+        return {
+            'day_price': self.cs_days_product_id,
+            'min_price': self.cs_mins_product_id,
+            'kms_price': self.cs_mileage_product_id
+        }
```

## odoo/addons/sm_partago_tariffs/models/models_smp_reservation_compute.py

```diff
@@ -1,11 +1,12 @@
 # -*- coding: utf-8 -*-
 
 from odoo import models, fields, api
 from odoo.tools.translate import _
 
 
 class smp_reservation_compute(models.Model):
-  _inherit = 'smp.sm_reservation_compute'
-  _name = 'smp.sm_reservation_compute'
+    _inherit = 'smp.sm_reservation_compute'
+    _name = 'smp.sm_reservation_compute'
 
-  applied_tariff_id = fields.Many2one('smp.sm_carsharing_tariff', string=_("Applied tariff"))
+    applied_tariff_id = fields.Many2one(
+        'smp.sm_carsharing_tariff', string=_("Applied tariff"))
```

## odoo/addons/sm_partago_tariffs/models/models_smp_tariffmodel_price_group.py

```diff
@@ -1,24 +1,29 @@
 # -*- coding: utf-8 -*-
-from odoo import api,models, fields
+from odoo import api, models, fields
 from odoo.tools.translate import _
 
 
 class smp_tariffmodel_price_group(models.Model):
-  _name = 'smp.sm_tariffmodel_price_group'
+    _name = 'smp.sm_tariffmodel_price_group'
 
-  name = fields.Char(string=_("Name"),compute="_get_price_group_name")
-  rel_tariff_model_id = fields.Many2one('smp.sm_carsharing_tariff_model', string=_("Rel. Tariff Model"))
-  applied_carconfig_price_group_id = fields.Many2one('smp.sm_carconfig_price_group',
-    string=_("Applied. Carconfig Price Group"))
-  cs_mins_product_id = fields.Many2one('product.product', string=_("Mins product"))
-  cs_days_product_id = fields.Many2one('product.product', string=_("Days product"))
-  cs_mileage_product_id = fields.Many2one('product.product', string=_("Mileage product"))
+    name = fields.Char(string=_("Name"), compute="_get_price_group_name")
+    rel_tariff_model_id = fields.Many2one(
+        'smp.sm_carsharing_tariff_model', string=_("Rel. Tariff Model"))
+    applied_carconfig_price_group_id = fields.Many2one(
+        'smp.sm_carconfig_price_group',
+        string=_("Applied. Carconfig Price Group"))
+    cs_mins_product_id = fields.Many2one(
+        'product.product', string=_("Mins product"))
+    cs_days_product_id = fields.Many2one(
+        'product.product', string=_("Days product"))
+    cs_mileage_product_id = fields.Many2one(
+        'product.product', string=_("Mileage product"))
 
-  _order = "name desc"
+    _order = "name desc"
 
-  @api.depends('rel_tariff_model_id')
-  def _get_price_group_name(self):
-    for record in self:
-      record.name = ''
-      if record.applied_carconfig_price_group_id:
-        record.name = record.applied_carconfig_price_group_id.name
+    @api.depends('rel_tariff_model_id')
+    def _get_price_group_name(self):
+        for record in self:
+            record.name = ''
+            if record.applied_carconfig_price_group_id:
+                record.name = record.applied_carconfig_price_group_id.name
```

## odoo/addons/sm_partago_tariffs/models/models_smp_tariffs_cron.py

```diff
@@ -1,39 +1,40 @@
 from odoo import models, fields, api
 from odoo.addons.sm_maintenance.models.models_sm_utils import sm_utils
 
+
 class smp_tariffs_cron(models.Model):
-  _name = 'sm_partago_tariffs.smp_tariffs_cron'
+    _name = 'sm_partago_tariffs.smp_tariffs_cron'
 
-  @api.model
-  def maintenance_welcome_tariffs(self):
-    company = self.env.user.company_id
-    tariffs = self.env['smp.sm_carsharing_tariff'].search([(
-      'name', '=', company.default_welcome
-    )])
-    if tariffs.exists():
-      for tariff in tariffs:
-        if not tariff.tariff_model_id.id:
-          company = self.env.user.company_id
-          welcome_tariff_model = company.welcome_tariff_model_id
-          tariff.write({
-            'tariff_model_id': welcome_tariff_model.id
-          })
+    @api.model
+    def maintenance_welcome_tariffs(self):
+        company = self.env.user.company_id
+        tariffs = self.env['smp.sm_carsharing_tariff'].search([(
+            'name', '=', company.default_welcome
+        )])
+        if tariffs.exists():
+            for tariff in tariffs:
+                if not tariff.tariff_model_id.id:
+                    company = self.env.user.company_id
+                    welcome_tariff_model = company.welcome_tariff_model_id
+                    tariff.write({
+                        'tariff_model_id': welcome_tariff_model.id
+                    })
 
-  @api.model
-  def notify_members_abouttoexpire_tariffs(self):
-    members = self.env['res.partner'].search([
-      ('cooperator_register_number', '>', 0)
-    ])
-    if members.exists():
-      for member in members:
-        if member.cs_tariffs_id.exists():
-          if member.has_active_notabouttoexpire_tariffs is False:
-            for tariff in member.cs_tariffs_id:
-              if (tariff.abouttoexpire
-                and not tariff.closed 
-                and not tariff.abouttoexpire_member_notified 
-                and tariff.check_if_primary_tariff()):
-                sm_utils.send_email_from_template(
-                  tariff, 'abouttoexpire_mail_template_id')
-                tariff.write(
-                  {'abouttoexpire_member_notified': True})
+    @api.model
+    def notify_members_abouttoexpire_tariffs(self):
+        members = self.env['res.partner'].search([
+            ('cooperator_register_number', '>', 0)
+        ])
+        if members.exists():
+            for member in members:
+                if member.cs_tariffs_id.exists():
+                    if member.has_active_notabouttoexpire_tariffs is False:
+                        for tariff in member.cs_tariffs_id:
+                            if (tariff.abouttoexpire
+                                and not tariff.closed
+                                and not tariff.abouttoexpire_member_notified
+                                    and tariff.check_if_primary_tariff()):
+                                sm_utils.send_email_from_template(
+                                    tariff, 'abouttoexpire_mail_template_id')
+                                tariff.write(
+                                    {'abouttoexpire_member_notified': True})
```

## odoo/addons/sm_partago_tariffs/models/res_config_settings.py

```diff
@@ -1,44 +1,41 @@
 # -*- coding: utf-8 -*-
 # Part of Odoo. See LICENSE file for full copyright and licensing details.
 
 import datetime
-
 from werkzeug import urls
-
 from odoo import api, fields, models, tools, _
 
 
 class ResConfigSettings(models.TransientModel):
-  _name = 'res.config.settings'
-  _inherit = 'res.config.settings'
+    _name = 'res.config.settings'
+    _inherit = 'res.config.settings'
 
-  tariff_default_model_id = fields.Many2one(
-    related='company_id.default_tariff_model_id',
-    string=_("Default tariff model (predefined)"), 
-    readonly=False)
-
-  welcome_tariff_model_id = fields.Many2one(
-    related='company_id.welcome_tariff_model_id',
-    string=_("Default welcome tariff model (predefined)"), 
-    readonly=False)
-   
-  pocketbook_threshold = fields.Float(
-    related='company_id.pocketbook_threshold',
-    string=_("Pocketbook threshold for tariffs"), 
-    readonly=False)
-
-  welcome_default = fields.Text(
-    related='company_id.default_welcome',
-    string=_("Default name for welcome tariffs"), 
-    readonly=False)
-
-  notification_tariff_creation_id = fields.Many2one(
-    related='company_id.notification_tariff_creation_id',
-    string=_("Notification tariff creation template"),
-    readonly=False)
-
-  abouttoexpire_mail_template_id = fields.Many2one(
-    related='company_id.abouttoexpire_mail_template_id',
-    string=_("About to expire tariffs notification template"),
-    readonly=False)
-    
+    tariff_default_model_id = fields.Many2one(
+        related='company_id.default_tariff_model_id',
+        string=_("Default tariff model (predefined)"),
+        readonly=False)
+
+    welcome_tariff_model_id = fields.Many2one(
+        related='company_id.welcome_tariff_model_id',
+        string=_("Default welcome tariff model (predefined)"),
+        readonly=False)
+
+    pocketbook_threshold = fields.Float(
+        related='company_id.pocketbook_threshold',
+        string=_("Pocketbook threshold for tariffs"),
+        readonly=False)
+
+    welcome_default = fields.Text(
+        related='company_id.default_welcome',
+        string=_("Default name for welcome tariffs"),
+        readonly=False)
+
+    notification_tariff_creation_id = fields.Many2one(
+        related='company_id.notification_tariff_creation_id',
+        string=_("Notification tariff creation template"),
+        readonly=False)
+
+    abouttoexpire_mail_template_id = fields.Many2one(
+        related='company_id.abouttoexpire_mail_template_id',
+        string=_("About to expire tariffs notification template"),
+        readonly=False)
```

## odoo/addons/sm_partago_tariffs/security/ir.model.access.csv

```diff
@@ -1,7 +1,8 @@
 id,name,model_id:id,group_id:id,perm_read,perm_write,perm_create,perm_unlink
 access_smp_sm_carconfig_price_group,smp.sm_carconfig_price_group,model_smp_sm_carconfig_price_group,,1,1,1,1
+access_smp_sm_carconfig_tariff_group,smp.sm_carconfig_tariff_group,model_smp_sm_carconfig_tariff_group,,1,1,1,1
 access_smp_sm_carsharing_tariff,smp.sm_carsharing_tariff,model_smp_sm_carsharing_tariff,,1,1,1,1
 access_smp_sm_carsharing_tariff_history,smp.sm_carsharing_tariff_history,model_smp_sm_carsharing_tariff_history,,1,1,1,1
 access_smp_sm_carsharing_tariff_model,smp.sm_carsharing_tariff_model,model_smp_sm_carsharing_tariff_model,,1,1,1,1
 access_smp_sm_reservation_compute,smp.sm_reservation_compute,model_smp_sm_reservation_compute,,1,1,1,1
 access_smp_sm_tariffmodel_price_group,smp.sm_tariffmodel_price_group,model_smp_sm_tariffmodel_price_group,,1,1,1,1
```

## odoo/addons/sm_partago_tariffs/views/views_cs_carconfig.xml

### odoo/addons/sm_partago_tariffs/views/views_cs_carconfig.xml

```diff
@@ -16,14 +16,15 @@
       <field name="name">sm_carsharing_structure.cs_carconfig.form.inherit</field>
       <field name="model">sm_carsharing_structure.cs_carconfig</field>
       <field name="inherit_id" ref="sm_carsharing_structure.view_cs_carconfig_form"/>
       <field name="arch" type="xml">
         <xpath expr="//page" position="inside">
           <group>
             <field name="related_price_group_id"/>
+            <field name="related_tariff_group_id"/>
             <field name="initial_price"/>
           </group>
         </xpath>
       </field>
     </record>
   </data>
 </odoo>
```

## odoo/addons/sm_partago_tariffs/views/views_tariff.xml

### odoo/addons/sm_partago_tariffs/views/views_tariff.xml

```diff
@@ -13,22 +13,14 @@
       <field name="name">Mark as about to expire notified</field>
       <field name="type">ir.actions.server</field>
       <field name="model_id" ref="model_smp_sm_carsharing_tariff"/>
       <field name="binding_model_id" ref="model_smp_sm_carsharing_tariff"/>
       <field name="state">code</field>
       <field name="code">action = model.mark_as_notified()</field>
     </record>
-    <record id="view_tariff_recompute_pb_tariff_workflow" model="ir.actions.server">
-      <field name="name">Recompute pocketbook tariff</field>
-      <field name="type">ir.actions.server</field>
-      <field name="model_id" ref="model_smp_sm_carsharing_tariff"/>
-      <field name="binding_model_id" ref="model_smp_sm_carsharing_tariff"/>
-      <field name="state">code</field>
-      <field name="code">action = model.recompute_pb_tariff()</field>
-    </record>
     <record id="view_tariff_window" model="ir.actions.act_window">
       <field name="name">User Tariffs</field>
       <field name="res_model">smp.sm_carsharing_tariff</field>
       <field name="view_mode">tree,form</field>
     </record>
     <record id="view_tariff_search" model="ir.ui.view">
       <field name="name">smp.tariff.search</field>
@@ -75,14 +67,15 @@
                   <field name="reason"/>
                   <field name="related_member_id"/>
                   <field name="tariff_model_id"/>
                   <field name="tariff_type"/>
                   <field name="date"/>
                   <field name="date_active"/>
                   <field name="date_valid" attrs="{'invisible': [('tariff_type','!=','time_frame')]}"/>
+                  <field name="related_tariff_group_id" attrs="{'invisible': [('tariff_type','!=','rel_car_group')]}"/>
                   <field name="related_carconfig_id" attrs="{'invisible': [('tariff_type','!=','rel_car')]}"/>
                   <field name="time_restricted" attrs="{'invisible': [('tariff_type','!=','rel_car')]}"/>
                   <field name="carconfig_availability" attrs="{'required':[('time_restricted','=',True)], 'invisible': [('time_restricted','!=',True)]}"/>
                   <field name="extra_tariff_model_id" attrs="{'required':[('time_restricted','=',True)], 'invisible': [('time_restricted','!=',True)]}"/>
                   <field name="pocketbook_initial" attrs="{'invisible': [('tariff_type','!=','pocketbook')]}"/>
                   <field name="pocketbook_threshold" attrs="{'invisible': [('tariff_type','!=','pocketbook')]}"/>
                   <field name="pocketbook" attrs="{'invisible': [('tariff_type','!=','pocketbook')]}"/>
```

## Comparing `odoo12_addon_sm_partago_tariffs-12.0.0.0.6.dist-info/METADATA` & `odoo12_addon_sm_partago_tariffs-12.0.0.0.7.dist-info/METADATA`

 * *Files 8% similar despite different names*

```diff
@@ -1,23 +1,20 @@
 Metadata-Version: 2.1
 Name: odoo12-addon-sm-partago-tariffs
-Version: 12.0.0.0.6
+Version: 12.0.0.0.7
 Summary: Dynamic and complex carsharing tariffs for the system
 Home-page: http://www.sommobilitat.coop
 Author: Som Mobilitat
-License: UNKNOWN
-Platform: UNKNOWN
 Classifier: Programming Language :: Python
 Classifier: Framework :: Odoo
 Classifier: Framework :: Odoo :: 12.0
 Requires-Python: >=3.5
 Requires-Dist: odoo12-addon-sm-carsharing-structure
 Requires-Dist: odoo12-addon-sm-partago-db
 Requires-Dist: odoo12-addon-sm-partago-usage
 Requires-Dist: odoo12-addon-sm-partago-user
 Requires-Dist: odoo12-addon-vertical-carsharing
 Requires-Dist: odoo (<12.1dev,>=12.0a)
 
 
     Dynamic and complex carsharing tariffs for the system
   
-
```

## Comparing `odoo12_addon_sm_partago_tariffs-12.0.0.0.6.dist-info/RECORD` & `odoo12_addon_sm_partago_tariffs-12.0.0.0.7.dist-info/RECORD`

 * *Files 11% similar despite different names*

```diff
@@ -1,35 +1,37 @@
 odoo/addons/sm_partago_tariffs/__init__.py,sha256=Ax4qLxdb9ATk05MF7cSQ0BdpYCpGVYFy9n4U4zODf9o,46
-odoo/addons/sm_partago_tariffs/__manifest__.py,sha256=rSDNQ4TK-YlpPf4QqPo_A1ck2sc6WFJVX2D9th01IWU,1476
+odoo/addons/sm_partago_tariffs/__manifest__.py,sha256=k_06deogozZeLBPl3JoVFLnbYBfqFMrpWXNlJKh72kc,1347
 odoo/addons/sm_partago_tariffs/email_tmpl/abouttoexpire_tariff_email.xml,sha256=MxRSWMdQfjd0qKydUzgin245JuIWbAmk2xE54yYfWys,2266
 odoo/addons/sm_partago_tariffs/email_tmpl/notification_tariff_created.xml,sha256=oA4xLjTq-Qzbjm7zAQ5Hmcaji8Cu1WoWJTh6xEnKda8,1075
-odoo/addons/sm_partago_tariffs/models/__init__.py,sha256=ARoAc1nx3N6kpUnz6xQmGsXHNhCXtBwibCsnzbX_a30,615
-odoo/addons/sm_partago_tariffs/models/models_carsharing_user_request.py,sha256=PfXxfKzgNuKLpChhlOgAeYS7oL35NLYedqyepVf2FvM,412
-odoo/addons/sm_partago_tariffs/models/models_cs_carconfig.py,sha256=XyC8GsOTNxDeyCpej-UbrUYrtqt8nEJ9nBWNw0v27vc,414
-odoo/addons/sm_partago_tariffs/models/models_sm_company.py,sha256=dvjikcIWCa5eyOZj2ftV-hEIMQKnhPLzGD_MwqeeBwI,822
-odoo/addons/sm_partago_tariffs/models/models_sm_member.py,sha256=eaQWTlXqCoaFOlw4Y7W16ZSU1OoGIZ2_E4bp1L7CP1w,8477
-odoo/addons/sm_partago_tariffs/models/models_smp_carconfig_price_group.py,sha256=E9qdnxmXycpn7GN9EMGxQVLW6MfSdv2EQRQeP63tJ7o,413
-odoo/addons/sm_partago_tariffs/models/models_smp_carsharing_send_email_tariff_wizard.py,sha256=00_cOSxayMlRBA-VZUfd7D9ZLZPxbLVLKJwcmjVSjHw,2698
-odoo/addons/sm_partago_tariffs/models/models_smp_carsharing_tariff.py,sha256=W_aH11-HXp10SR9_C4yuv5wypkLVOpRjIKsVXO-yPPk,6611
-odoo/addons/sm_partago_tariffs/models/models_smp_carsharing_tariff_history.py,sha256=Q4io5TM3SEWes2JtbiA1xNf4hFz2rWjEE0LvF_jYsqU,586
-odoo/addons/sm_partago_tariffs/models/models_smp_carsharing_tariff_model.py,sha256=I2yKlsyrRO2UgVRlL24k_kR4bhBgC3QSH-vbjbfw4Ac,1377
-odoo/addons/sm_partago_tariffs/models/models_smp_reservation_compute.py,sha256=z3P7mnrN11_Lo8jSt3kWOVi9CPezHoQIN3rquSljPa0,320
-odoo/addons/sm_partago_tariffs/models/models_smp_tariffmodel_price_group.py,sha256=GQua5r-M-6s8Jqaw4n8rQNHTf0kZWy-TJJXi1y-sxPA,1019
-odoo/addons/sm_partago_tariffs/models/models_smp_tariffs_cron.py,sha256=luIoB25cILPPP8vW4YYmMHoxIbRRhpHty_JC42O3Mic,1467
-odoo/addons/sm_partago_tariffs/models/res_config_settings.py,sha256=bzJFNMfsfWqBKOTIcNIzmfBcOgSIs4t9A7u2wre5IJk,1344
-odoo/addons/sm_partago_tariffs/security/ir.model.access.csv,sha256=7R_ximqi7JXv6v7o9kioUub6fd3WMPFMYn59egcRga4,737
+odoo/addons/sm_partago_tariffs/models/__init__.py,sha256=y3qRLlmMSu1Dh8WrXgwJ9uhK2YcTrrdrdEcqBud1AWU,632
+odoo/addons/sm_partago_tariffs/models/models_carsharing_user_request.py,sha256=c_ylKa-ucZSwErHdEeVSF1iZtl2ug5h9luFOTmPPXNU,430
+odoo/addons/sm_partago_tariffs/models/models_cs_carconfig.py,sha256=tKU15MFUdRoYDNJfFsS-Go-O4CQL-O7lRrydAFcordI,554
+odoo/addons/sm_partago_tariffs/models/models_sm_company.py,sha256=nFCMxY0ivDcD47qhQAHiFO_60e-ND-oLYC8HM9U0lDE,907
+odoo/addons/sm_partago_tariffs/models/models_sm_member.py,sha256=kM8nvVbT9PzZEpMmJrJjqYit2Mu0gEJlfh1U4vnx1yY,10910
+odoo/addons/sm_partago_tariffs/models/models_smp_carconfig_price_group.py,sha256=5bkHrOq3jIOVzG1okH0YpIMj7MobHRKuLkOEA5a0W7I,445
+odoo/addons/sm_partago_tariffs/models/models_smp_carconfig_tariff_group.py,sha256=dAIF0ZHYplTd4jOl2U7OKeyn3AtE76YT61oAI8kT7kU,448
+odoo/addons/sm_partago_tariffs/models/models_smp_carsharing_send_email_tariff_wizard.py,sha256=w8h9y0znyXYYLKJrxHaRu-owQCB7T2YVHcwU4JvWXOg,2907
+odoo/addons/sm_partago_tariffs/models/models_smp_carsharing_tariff.py,sha256=3tUolOvPQwu5KWfT430jrL4Nx_KaEt6_tevywt18YT8,7163
+odoo/addons/sm_partago_tariffs/models/models_smp_carsharing_tariff_history.py,sha256=uuk3EmT91ioTDoH2nVbaQHBTHlsp--A0I1qDvRSyttE,620
+odoo/addons/sm_partago_tariffs/models/models_smp_carsharing_tariff_model.py,sha256=QjjJ87K9YyPIo3a8ugH18Ak0HtxiIbhc1UKFt8V12Yo,1551
+odoo/addons/sm_partago_tariffs/models/models_smp_reservation_compute.py,sha256=pbvb3HNSqHWUJ8b27MF3JVfOT5kUgqfmtT-qLx2aHzU,335
+odoo/addons/sm_partago_tariffs/models/models_smp_tariffmodel_price_group.py,sha256=q_2GdbSf5I44dR3uakYJR3InO7n-hL2OLrEHcLUmkx4,1114
+odoo/addons/sm_partago_tariffs/models/models_smp_tariffs_cron.py,sha256=6dIKvA0OLte0UXjORS8dITPab93mzf39dwjPOPL5ycE,1753
+odoo/addons/sm_partago_tariffs/models/res_config_settings.py,sha256=aahPGsG1KVk5fb_TtWsTwb0nsDMGT5XVvEGWxtMXRfU,1419
+odoo/addons/sm_partago_tariffs/security/ir.model.access.csv,sha256=ZGAv0T47xhDxJ5z8sk2mm0It3sSNZieX821_ySzh4QI,849
 odoo/addons/sm_partago_tariffs/views/views.xml,sha256=Q2tTNBt-TBlJoi37XFq-Elh0vpES0PqL1Qqf9DwTDuI,144
 odoo/addons/sm_partago_tariffs/views/views_carconfig_price_group.xml,sha256=njJjh9aj_B4kvvZhIWBtHT3UH87KFMyLPXGm_X6z5QU,1691
+odoo/addons/sm_partago_tariffs/views/views_carconfig_tariff_group.xml,sha256=K--rPrJHnaYX-Zz4jfWPvHCZFeu9dfAnSC3Fr_bachY,1704
 odoo/addons/sm_partago_tariffs/views/views_carsharing_user_request.xml,sha256=lM17FowZhHKKONXwuKVo9OxZQ5aNGme3rT20PEMe084,1227
 odoo/addons/sm_partago_tariffs/views/views_cron.xml,sha256=gZkUpqeQ_dcq5b7-xNkR7jnanL9y5P5byK-hD7pQTCc,1193
-odoo/addons/sm_partago_tariffs/views/views_cs_carconfig.xml,sha256=XLgCsv1RzzBgCDFU4HrNANyFHmia5xXbx1ve2y5n1tA,1162
+odoo/addons/sm_partago_tariffs/views/views_cs_carconfig.xml,sha256=PkwTBU3jiUsGdA5mca6Cq3JFCSiyN6so0UgUFipyS7A,1214
 odoo/addons/sm_partago_tariffs/views/views_members.xml,sha256=h7iAvJpfcwHt5QfMVanfua1k1kwfL_XeekFRmNi0Xk8,6444
 odoo/addons/sm_partago_tariffs/views/views_res_config_settings.xml,sha256=jGcQT7Ulf8Bc2cWNJ0HqfCVhzsIbnY-C3kk0cxNocoI,1354
 odoo/addons/sm_partago_tariffs/views/views_reservation_compute.xml,sha256=n9BA9F-BHreY3DfFMMRSXEzJpk74wK-nCsQ4kYfPH3M,599
-odoo/addons/sm_partago_tariffs/views/views_tariff.xml,sha256=xfTvg0miZdBp7Nq9i3BVo--xel2QynUMYsweSc3pFpY,5633
+odoo/addons/sm_partago_tariffs/views/views_tariff.xml,sha256=4tE29wGpAkGkiS2A2ZMDKuZop0pbUPiCXwZ8py4jigU,5308
 odoo/addons/sm_partago_tariffs/views/views_tariff_history.xml,sha256=hbYtGQCaColkMz7L5Qf_M60yv8DLKcLigyFiEIaRIQo,821
 odoo/addons/sm_partago_tariffs/views/views_tariff_model.xml,sha256=lH4ojEHkljZyPR-FnwAjvYhYiLfSun4liwEaFcWhZdo,2453
 odoo/addons/sm_partago_tariffs/views/views_tariffmodel_price_group.xml,sha256=jP2EFHekxUdS_QsWr69JQ83icGvXiwsTRgCrjMfWoYs,1110
-odoo12_addon_sm_partago_tariffs-12.0.0.0.6.dist-info/METADATA,sha256=Zl3XSaB0mkI4RlYf12b6pSyGVk5kUBB298jx6WZF9M0,708
-odoo12_addon_sm_partago_tariffs-12.0.0.0.6.dist-info/WHEEL,sha256=z9j0xAa_JmUKMpmz72K0ZGALSM_n-wQVmGbleXx2VHg,110
-odoo12_addon_sm_partago_tariffs-12.0.0.0.6.dist-info/top_level.txt,sha256=qBj40grFkGOfDZ2WDSw3y1RnDlgG0u8rP8pvGNdbz4w,5
-odoo12_addon_sm_partago_tariffs-12.0.0.0.6.dist-info/RECORD,,
+odoo12_addon_sm_partago_tariffs-12.0.0.0.7.dist-info/METADATA,sha256=6hhoWcSc0bmX-KFmhNhqiajrSJs94NOE3OI50UfYI1o,672
+odoo12_addon_sm_partago_tariffs-12.0.0.0.7.dist-info/WHEEL,sha256=z9j0xAa_JmUKMpmz72K0ZGALSM_n-wQVmGbleXx2VHg,110
+odoo12_addon_sm_partago_tariffs-12.0.0.0.7.dist-info/top_level.txt,sha256=qBj40grFkGOfDZ2WDSw3y1RnDlgG0u8rP8pvGNdbz4w,5
+odoo12_addon_sm_partago_tariffs-12.0.0.0.7.dist-info/RECORD,,
```

