# Comparing `tmp/karrio.dhl_express-2023.3.4-py3-none-any.whl.zip` & `tmp/karrio.dhl_express-2023.4-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,22 +1,22 @@
-Zip file size: 26099 bytes, number of entries: 20
--rw-rw-r--  2.0 unx      576 b- defN 23-Mar-28 20:40 karrio/mappers/dhl_express/__init__.py
--rw-rw-r--  2.0 unx     3568 b- defN 23-Mar-28 21:52 karrio/mappers/dhl_express/mapper.py
--rw-rw-r--  2.0 unx     2464 b- defN 22-Nov-15 19:21 karrio/mappers/dhl_express/proxy.py
--rw-rw-r--  2.0 unx      425 b- defN 22-Nov-15 19:21 karrio/mappers/dhl_express/settings.py
+Zip file size: 26316 bytes, number of entries: 20
+-rw-rw-r--  2.0 unx      576 b- defN 23-Mar-29 20:04 karrio/mappers/dhl_express/__init__.py
+-rw-rw-r--  2.0 unx     3374 b- defN 23-Apr-01 12:45 karrio/mappers/dhl_express/mapper.py
+-rw-rw-r--  2.0 unx     1938 b- defN 23-Apr-04 13:04 karrio/mappers/dhl_express/proxy.py
+-rw-rw-r--  2.0 unx      447 b- defN 23-Apr-15 06:44 karrio/mappers/dhl_express/settings.py
 -rw-rw-r--  2.0 unx      690 b- defN 22-Nov-15 19:21 karrio/providers/dhl_express/__init__.py
--rw-rw-r--  2.0 unx     2867 b- defN 23-Mar-27 07:55 karrio/providers/dhl_express/address.py
--rw-rw-r--  2.0 unx     1021 b- defN 22-Nov-15 19:21 karrio/providers/dhl_express/error.py
--rw-rw-r--  2.0 unx     8467 b- defN 23-Mar-28 23:06 karrio/providers/dhl_express/rate.py
--rw-rw-r--  2.0 unx    18795 b- defN 23-Mar-29 00:47 karrio/providers/dhl_express/shipment.py
--rw-rw-r--  2.0 unx     3464 b- defN 23-Mar-27 07:55 karrio/providers/dhl_express/tracking.py
--rw-rw-r--  2.0 unx    26081 b- defN 23-Mar-29 13:17 karrio/providers/dhl_express/units.py
--rw-rw-r--  2.0 unx     1396 b- defN 23-Mar-27 07:55 karrio/providers/dhl_express/utils.py
+-rw-rw-r--  2.0 unx     2895 b- defN 23-Apr-01 15:58 karrio/providers/dhl_express/address.py
+-rw-rw-r--  2.0 unx      642 b- defN 23-Apr-04 18:00 karrio/providers/dhl_express/error.py
+-rw-rw-r--  2.0 unx     9090 b- defN 23-Apr-04 18:03 karrio/providers/dhl_express/rate.py
+-rw-rw-r--  2.0 unx    18193 b- defN 23-Apr-04 18:28 karrio/providers/dhl_express/shipment.py
+-rw-rw-r--  2.0 unx     3768 b- defN 23-Apr-04 14:05 karrio/providers/dhl_express/tracking.py
+-rw-rw-r--  2.0 unx    26580 b- defN 23-Apr-04 15:00 karrio/providers/dhl_express/units.py
+-rw-rw-r--  2.0 unx     1558 b- defN 23-Apr-15 02:55 karrio/providers/dhl_express/utils.py
 -rw-rw-r--  2.0 unx      307 b- defN 22-Nov-15 19:21 karrio/providers/dhl_express/pickup/__init__.py
--rw-rw-r--  2.0 unx     2300 b- defN 22-Nov-15 19:21 karrio/providers/dhl_express/pickup/cancel.py
--rw-rw-r--  2.0 unx     4534 b- defN 23-Mar-27 07:55 karrio/providers/dhl_express/pickup/create.py
--rw-rw-r--  2.0 unx     4693 b- defN 22-Nov-15 19:21 karrio/providers/dhl_express/pickup/update.py
--rw-rw-r--  2.0 unx     1022 b- defN 23-Mar-29 13:35 karrio.dhl_express-2023.3.4.dist-info/METADATA
--rw-rw-r--  2.0 unx       92 b- defN 23-Mar-29 13:35 karrio.dhl_express-2023.3.4.dist-info/WHEEL
--rw-rw-r--  2.0 unx        7 b- defN 23-Mar-29 13:35 karrio.dhl_express-2023.3.4.dist-info/top_level.txt
--rw-rw-r--  2.0 unx     1898 b- defN 23-Mar-29 13:35 karrio.dhl_express-2023.3.4.dist-info/RECORD
-20 files, 84667 bytes uncompressed, 22919 bytes compressed:  72.9%
+-rw-rw-r--  2.0 unx     2369 b- defN 23-Apr-04 18:00 karrio/providers/dhl_express/pickup/cancel.py
+-rw-rw-r--  2.0 unx     4552 b- defN 23-Apr-04 18:02 karrio/providers/dhl_express/pickup/create.py
+-rw-rw-r--  2.0 unx     4754 b- defN 23-Apr-01 15:18 karrio/providers/dhl_express/pickup/update.py
+-rw-rw-r--  2.0 unx     1020 b- defN 23-Apr-18 07:10 karrio.dhl_express-2023.4.dist-info/METADATA
+-rw-rw-r--  2.0 unx       92 b- defN 23-Apr-18 07:10 karrio.dhl_express-2023.4.dist-info/WHEEL
+-rw-rw-r--  2.0 unx        7 b- defN 23-Apr-18 07:10 karrio.dhl_express-2023.4.dist-info/top_level.txt
+-rw-rw-r--  2.0 unx     1889 b- defN 23-Apr-18 07:10 karrio.dhl_express-2023.4.dist-info/RECORD
+20 files, 84741 bytes uncompressed, 23152 bytes compressed:  72.7%
```

## zipnote {}

```diff
@@ -42,20 +42,20 @@
 
 Filename: karrio/providers/dhl_express/pickup/create.py
 Comment: 
 
 Filename: karrio/providers/dhl_express/pickup/update.py
 Comment: 
 
-Filename: karrio.dhl_express-2023.3.4.dist-info/METADATA
+Filename: karrio.dhl_express-2023.4.dist-info/METADATA
 Comment: 
 
-Filename: karrio.dhl_express-2023.3.4.dist-info/WHEEL
+Filename: karrio.dhl_express-2023.4.dist-info/WHEEL
 Comment: 
 
-Filename: karrio.dhl_express-2023.3.4.dist-info/top_level.txt
+Filename: karrio.dhl_express-2023.4.dist-info/top_level.txt
 Comment: 
 
-Filename: karrio.dhl_express-2023.3.4.dist-info/RECORD
+Filename: karrio.dhl_express-2023.4.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## karrio/mappers/dhl_express/mapper.py

```diff
@@ -46,44 +46,38 @@
         self, payload: models.DocumentUploadRequest
     ) -> lib.Serializable:
         return super().create_document_upload_request(payload)
 
     def parse_address_validation_response(
         self, response: lib.Deserializable
     ) -> typing.Tuple[models.AddressValidationDetails, typing.List[models.Message]]:
-        return provider.parse_address_validation_response(
-            response.deserialize(), self.settings
-        )
+        return provider.parse_address_validation_response(response, self.settings)
 
     def parse_cancel_pickup_response(
-        self, response: lib.Deserializable[str]
+        self, response: lib.Deserializable
     ) -> typing.Tuple[models.ConfirmationDetails, typing.List[models.Message]]:
-        return provider.parse_pickup_cancel_response(
-            response.deserialize(), self.settings
-        )
+        return provider.parse_pickup_cancel_response(response, self.settings)
 
     def parse_pickup_response(
-        self, response: lib.Deserializable[str]
+        self, response: lib.Deserializable
     ) -> typing.Tuple[models.PickupDetails, typing.List[models.Message]]:
-        return provider.parse_pickup_response(response.deserialize(), self.settings)
+        return provider.parse_pickup_response(response, self.settings)
 
     def parse_pickup_update_response(
-        self, response: lib.Deserializable[str]
+        self, response: lib.Deserializable
     ) -> typing.Tuple[models.PickupDetails, typing.List[models.Message]]:
-        return provider.parse_pickup_update_response(
-            response.deserialize(), self.settings
-        )
+        return provider.parse_pickup_update_response(response, self.settings)
 
     def parse_rate_response(
-        self, response: lib.Deserializable[str]
+        self, response: lib.Deserializable
     ) -> typing.Tuple[typing.List[models.RateDetails], typing.List[models.Message]]:
-        return provider.parse_rate_response(response.deserialize(), self.settings)
+        return provider.parse_rate_response(response, self.settings)
 
     def parse_shipment_response(
-        self, response: lib.Deserializable[str]
+        self, response: lib.Deserializable
     ) -> typing.Tuple[models.ShipmentDetails, typing.List[models.Message]]:
-        return provider.parse_shipment_response(response.deserialize(), self.settings)
+        return provider.parse_shipment_response(response, self.settings)
 
     def parse_tracking_response(
-        self, response: lib.Deserializable[str]
+        self, response: lib.Deserializable
     ) -> typing.Tuple[typing.List[models.TrackingDetails], typing.List[models.Message]]:
-        return provider.parse_tracking_response(response.deserialize(), self.settings)
+        return provider.parse_tracking_response(response, self.settings)
```

## karrio/mappers/dhl_express/proxy.py

```diff
@@ -1,71 +1,54 @@
-from typing import Any
-from karrio.core.utils import XP, request as http, Serializable, Deserializable
+import karrio.lib as lib
 from karrio.api.proxy import Proxy as BaseProxy
-from dhl_express_lib.dct_req_global_2_0 import DCTRequest
-from dhl_express_lib.tracking_request_known_1_0 import KnownTrackingRequest
-from dhl_express_lib.ship_val_global_req_10_0 import ShipmentRequest
-from dhl_express_lib.book_pickup_global_req_3_0 import BookPURequest
-from dhl_express_lib.modify_pickup_global_req_3_0 import ModifyPURequest
-from dhl_express_lib.cancel_pickup_global_req_3_0 import CancelPURequest
-from dhl_express_lib.routing_global_req_2_0 import RouteRequest
 from karrio.mappers.dhl_express.settings import Settings
 
 
 class Proxy(BaseProxy):
     settings: Settings
 
-    def _send_request(self, request: Serializable[Any]) -> str:
-        return http(
+    def _send_request(self, request: lib.Serializable) -> str:
+        return lib.request(
             url=self.settings.server_url,
             data=request.serialize(),
             headers={"Content-Type": "application/xml"},
             trace=self.trace_as("xml"),
             method="POST",
         )
 
-    def validate_address(
-        self, request: Serializable[RouteRequest]
-    ) -> Deserializable[str]:
+    def validate_address(self, request: lib.Serializable) -> lib.Deserializable:
         response = self._send_request(request)
 
-        return Deserializable(response, XP.to_xml)
+        return lib.Deserializable(response, lib.to_element)
 
-    def get_rates(self, request: Serializable[DCTRequest]) -> Deserializable[str]:
+    def get_rates(self, request: lib.Serializable) -> lib.Deserializable:
         response = self._send_request(request)
 
-        return Deserializable(response, XP.to_xml)
+        return lib.Deserializable(response, lib.to_element, request.ctx)
 
-    def get_tracking(
-        self, request: Serializable[KnownTrackingRequest]
-    ) -> Deserializable[str]:
+    def get_tracking(self, request: lib.Serializable) -> lib.Deserializable:
         response = self._send_request(request)
 
-        return Deserializable(response, XP.to_xml)
+        return lib.Deserializable(response, lib.to_element)
 
-    def create_shipment(
-        self, request: Serializable[ShipmentRequest]
-    ) -> Deserializable[str]:
+    def create_shipment(self, request: lib.Serializable) -> lib.Deserializable:
         response = self._send_request(request)
 
-        return Deserializable(response, XP.to_xml)
+        return lib.Deserializable(response, lib.to_element)
 
-    def schedule_pickup(
-        self, request: Serializable[BookPURequest]
-    ) -> Deserializable[str]:
+    def schedule_pickup(self, request: lib.Serializable) -> lib.Deserializable:
         response = self._send_request(request)
 
-        return Deserializable(response, XP.to_xml)
+        return lib.Deserializable(response, lib.to_element)
 
-    def modify_pickup(
-        self, request: Serializable[ModifyPURequest]
-    ) -> Deserializable[str]:
+    def modify_pickup(self, request: lib.Serializable) -> lib.Deserializable:
         response = self._send_request(request)
 
-        return Deserializable(response, XP.to_xml)
+        return lib.Deserializable(response, lib.to_element)
 
-    def cancel_pickup(
-        self, request: Serializable[CancelPURequest]
-    ) -> Deserializable[str]:
+    def cancel_pickup(self, request: lib.Serializable) -> lib.Deserializable:
         response = self._send_request(request)
 
-        return Deserializable(response, XP.to_xml)
+        return lib.Deserializable(response, lib.to_element)
+
+    def upload_document(self, request: lib.Serializable) -> lib.Deserializable:
+        return super().upload_document(request)
```

## karrio/mappers/dhl_express/settings.py

```diff
@@ -9,11 +9,12 @@
     """DHL connection settings."""
 
     site_id: str
     password: str
     account_number: str = None
     account_country_code: str = None
     metadata: dict = {}
+    config: dict = {}
 
     id: str = None
     test_mode: bool = False
     carrier_id: str = "dhl_express"
```

## karrio/providers/dhl_express/address.py

```diff
@@ -15,17 +15,19 @@
 )
 from karrio.providers.dhl_express.units import CountryRegion
 from karrio.providers.dhl_express.utils import Settings
 from karrio.providers.dhl_express.error import parse_error_response
 
 
 def parse_address_validation_response(
-    response: Element, settings: Settings
+    _response: lib.Deserializable[Element],
+    settings: Settings,
 ) -> Tuple[AddressValidationDetails, List[Message]]:
-    notes = response.xpath(".//*[local-name() = $name]", name="Note")
+    response = _response.deserialize()
+    notes = lib.find_element("Note", response)
     success = next(
         (True for note in notes if XP.to_object(Note, note).ActionNote == "Success"),
         False,
     )
     validation_details = AddressValidationDetails(
         carrier_id=settings.carrier_id,
         carrier_name=settings.carrier_name,
@@ -33,15 +35,15 @@
     )
 
     return validation_details, parse_error_response(response, settings)
 
 
 def address_validation_request(
     payload: AddressValidationRequest, settings: Settings
-) -> Serializable[RouteRequest]:
+) -> Serializable:
     country = (
         Country[payload.address.country_code]
         if payload.address.country_code is not None
         else None
     )
     division = (
         CountryState[country.name].value[payload.address.state_code].value
```

## karrio/providers/dhl_express/error.py

```diff
@@ -1,29 +1,22 @@
-from typing import List, Callable
-from functools import reduce
-from karrio.core.utils.xml import Element
-from karrio.providers.dhl_express import Settings
-from karrio.core.models import Message
-from dhl_express_lib.dct_response_global_2_0 import ConditionType
+import dhl_express_lib.dct_response_global_3_0 as dhl
+import typing
+import karrio.lib as lib
+import karrio.core.models as models
+import karrio.providers.dhl_express.utils as provider_utils
 
 
-def parse_error_response(response, settings: Settings) -> List[Message]:
-    conditions = response.xpath(".//*[local-name() = $name]", name="Condition")
-    return reduce(_extract_error(settings), conditions, [])
+def parse_error_response(
+    response: lib.Element,
+    settings: provider_utils.Settings,
+) -> typing.List[models.Message]:
+    errors = lib.find_element("Condition", response, dhl.ConditionType)
 
-
-def _extract_error(
-    settings: Settings,
-) -> Callable[[List[Message], Element], List[Message]]:
-    def extract(errors: List[Message], condition_node: Element) -> List[Message]:
-        condition = ConditionType()
-        condition.build(condition_node)
-        return errors + [
-            Message(
-                code=condition.ConditionCode,
-                message=condition.ConditionData,
-                carrier_name=settings.carrier_name,
-                carrier_id=settings.carrier_id,
-            )
-        ]
-
-    return extract
+    return [
+        models.Message(
+            carrier_id=settings.carrier_id,
+            carrier_name=settings.carrier_name,
+            code=error.ConditionCode,
+            message=error.ConditionData,
+        )
+        for error in errors
+    ]
```

## karrio/providers/dhl_express/rate.py

```diff
@@ -1,42 +1,60 @@
 import dhl_express_lib.dct_requestdatatypes_global as dhl_global
-import dhl_express_lib.dct_response_global_2_0 as dhl_response
-import dhl_express_lib.dct_req_global_2_0 as dhl
+import dhl_express_lib.dct_response_global_3_0 as dhl_response
+import dhl_express_lib.dct_req_global_3_0 as dhl
 import time
 import typing
 import karrio.lib as lib
 import karrio.core.units as units
 import karrio.core.models as models
 import karrio.core.errors as errors
 import karrio.providers.dhl_express.error as provider_error
 import karrio.providers.dhl_express.units as provider_units
 import karrio.providers.dhl_express.utils as provider_utils
 
 
 def parse_rate_response(
-    response: lib.Element, settings: provider_utils.Settings
+    _response: lib.Deserializable[lib.Element],
+    settings: provider_utils.Settings,
 ) -> typing.Tuple[typing.List[models.RateDetails], typing.List[models.Message]]:
-    quotes = lib.find_element("QtdShp", response, dhl_response.QtdShpType)
+    response = _response.deserialize()
+
+    messages = provider_error.parse_error_response(response, settings)
+    quotes: typing.List[dhl_response.QtdShpType] = lib.find_element(
+        "QtdShp", response, dhl_response.QtdShpType
+    )
     rates: typing.List[models.RateDetails] = [
-        _extract_quote(quote, settings)
+        _extract_quote(quote, settings, _response.ctx)
         for quote in quotes
         if (
             quote.ShippingCharge is not None
             and lib.to_decimal(quote.ShippingCharge) > 0
         )
     ]
 
-    return rates, provider_error.parse_error_response(response, settings)
+    return [_ for _ in rates if _ is not None], messages
 
 
 def _extract_quote(
     quote: dhl_response.QtdShpType,
     settings: provider_utils.Settings,
+    ctx: typing.Dict[str, typing.Any] = {},
 ) -> models.RateDetails:
-    service = provider_units.ShippingService.map(quote.GlobalProductCode)
+    is_document = ctx.get("is_document", False)
+    is_international = ctx.get("is_international", False)
+    service = provider_units.ShippingService.map(
+        quote.GlobalProductCode if is_international else quote.LocalProductCode,
+    )
+    invalid_service = (
+        not is_international and service.name_or_key.endswith("_nondoc")
+    ) or (is_international and not is_document and service.name_or_key.endswith("_doc"))
+
+    if invalid_service:
+        return None
+
     charges = [
         ("Base charge", quote.WeightCharge),
         *((s.LocalServiceTypeName, s.ChargeValue) for s in quote.QtdShpExChrg),
     ]
 
     delivery_date = lib.to_date(quote.DeliveryDate[0].DlvyDateTime, "%Y-%m-%d %H:%M:%S")
     pricing_date = lib.to_date(quote.PricingDate)
@@ -58,21 +76,21 @@
                 name=name,
                 amount=lib.to_decimal(amount),
                 currency=quote.CurrencyCode,
             )
             for name, amount in charges
             if amount
         ],
-        meta=dict(service_name=(service.name or quote.ProductShortName)),
+        meta=dict(service_name=(service.name or quote.LocalProductName)),
     )
 
 
 def rate_request(
     payload: models.RateRequest, settings: provider_utils.Settings
-) -> lib.Serializable[dhl.DCTRequest]:
+) -> lib.Serializable:
     packages = lib.to_packages(
         payload.parcels,
         provider_units.PackagePresets,
         required=["weight"],
         package_option_type=provider_units.ShippingOption,
     )
     is_international = payload.shipper.country_code != payload.recipient.country_code
@@ -82,35 +100,39 @@
     ):
         raise errors.OriginNotServicedError(payload.shipper.country_code)
 
     if not is_international and payload.shipper.country_code in ["CA"]:
         raise errors.DestinationNotServicedError(payload.shipper.country_code)
 
     is_document = all([parcel.is_document for parcel in payload.parcels])
-    is_dutiable = not is_document  # parcel and not document only so it is dutiable.
+    is_dutiable = is_international and not is_document
     services = lib.to_services(
         payload.services,
         is_document=is_document,
         is_international=is_international,
         origin_country=payload.shipper.country_code,
         is_envelope=("envelope" in (packages.package_type or "")),
         initializer=provider_units.shipping_services_initializer,
     )
     options = lib.to_shipping_options(
         payload.options,
-        is_international=is_international,
         is_dutiable=is_dutiable,
         package_options=packages.options,
+        shipper_country=payload.shipper.country_code,
         initializer=provider_units.shipping_options_initializer,
     )
 
     weight_unit, dim_unit = (
         provider_units.COUNTRY_PREFERED_UNITS.get(payload.shipper.country_code)
         or packages.compatible_units
     )
+    currency = (
+        options.currency.state
+        or units.CountryCurrency[payload.shipper.country_code].value
+    )
 
     request = dhl.DCTRequest(
         GetQuote=dhl.GetQuoteType(
             Request=settings.Request(
                 MetaData=dhl.MetaData(SoftwareName="3PV", SoftwareVersion=1.0)
             ),
             From=dhl.DCTFrom(
@@ -153,17 +175,15 @@
                     ]
                 ),
                 NumberOfPieces=len(packages),
                 ShipmentWeight=packages.weight[weight_unit.name],
                 Volume=None,
                 PaymentAccountNumber=lib.text(settings.account_number),
                 InsuredCurrency=(
-                    options.currency.state
-                    if options.dhl_shipment_insurance.state
-                    else None
+                    currency if options.dhl_shipment_insurance.state else None
                 ),
                 InsuredValue=options.dhl_shipment_insurance.state,
                 PaymentType=None,
                 AcctPickupCloseTime=None,
                 QtdShp=(
                     [
                         dhl.QtdShpType(
@@ -176,41 +196,42 @@
                                 ]
                                 if any(options.items())
                                 else None
                             ),
                         )
                         for svc in services
                     ]
-                    if any(services)
+                    if any(options.items())
                     else None
                 ),
             ),
             Dutiable=(
                 dhl_global.DCTDutiable(
                     DeclaredValue=(options.declared_value.state or 1.0),
-                    DeclaredCurrency=(
-                        options.currency.state
-                        or units.CountryCurrency[payload.shipper.country_code].value
-                    ),
+                    DeclaredCurrency=currency,
                 )
                 if is_dutiable
                 else None
             ),
         ),
     )
 
-    return lib.Serializable(request, _request_serializer)
+    return lib.Serializable(
+        request,
+        _request_serializer,
+        dict(is_international=is_international, is_document=is_document),
+    )
 
 
 def _request_serializer(request: dhl.DCTRequest) -> str:
     namespacedef_ = (
         'xmlns:p="http://www.dhl.com" '
         'xmlns:p1="http://www.dhl.com/datatypes" '
         'xmlns:p2="http://www.dhl.com/DCTRequestdatatypes" '
         'xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" '
         'xsi:schemaLocation="http://www.dhl.com DCT-req.xsd"'
     )
     return lib.to_xml(
         request,
         name_="p:DCTRequest",
         namespacedef_=namespacedef_,
-    ).replace('schemaVersion="2"', 'schemaVersion="2.0"')
+    ).replace('schemaVersion="3"', 'schemaVersion="3.0"')
```

## karrio/providers/dhl_express/shipment.py

```diff
@@ -10,16 +10,18 @@
 import karrio.core.errors as errors
 import karrio.providers.dhl_express.error as provider_error
 import karrio.providers.dhl_express.units as provider_units
 import karrio.providers.dhl_express.utils as provider_utils
 
 
 def parse_shipment_response(
-    response: lib.Element, settings: provider_utils.Settings
+    _response: lib.Deserializable[lib.Element],
+    settings: provider_utils.Settings,
 ) -> typing.Tuple[models.ShipmentDetails, typing.List[models.Message]]:
+    response = _response.deserialize()
     air_way_bill = lib.find_element("AirwayBillNumber", response, first=True)
 
     return (
         _extract_shipment(response, settings) if air_way_bill is not None else None,
         provider_error.parse_error_response(response, settings),
     )
 
@@ -57,35 +59,35 @@
             carrier_tracking_link=settings.tracking_url.format(tracking_number),
         ),
     )
 
 
 def shipment_request(
     payload: models.ShipmentRequest, settings: provider_utils.Settings
-) -> lib.Serializable[dhl.ShipmentRequest]:
+) -> lib.Serializable:
     if any(settings.account_country_code or "") and (
         payload.shipper.country_code != settings.account_country_code
     ):
         raise errors.OriginNotServicedError(payload.shipper.country_code)
 
     shipper = lib.to_address(payload.shipper)
     recipient = lib.to_address(payload.recipient)
     packages = lib.to_packages(
         payload.parcels,
         provider_units.PackagePresets,
         required=["weight"],
+        max_weight=units.Weight(300, "KG"),
         package_option_type=provider_units.ShippingOption,
     )
     product = provider_units.ShippingService.map(payload.service).value_or_key
 
     weight_unit, dim_unit = (
         provider_units.COUNTRY_PREFERED_UNITS.get(payload.shipper.country_code)
         or packages.compatible_units
     )
-
     package_type = provider_units.PackageType.map(packages.package_type).value
     label_format, label_template = provider_units.LabelType[
         payload.label_type or "PDF_6x4"
     ].value
     payment = payload.payment or models.Payment(
         paid_by="sender",
         account_number=settings.account_number,
@@ -93,26 +95,32 @@
     customs = lib.to_customs_info(
         payload.customs,
         shipper=payload.shipper,
         recipient=payload.recipient,
         weight_unit=weight_unit.value,
     )
     is_document = all(p.parcel.is_document for p in packages)
-    is_dutiable = is_document is False and customs.duty is not None
+    is_international = shipper.country_code != recipient.country_code
+    is_dutiable = is_international and not is_document
     options = lib.to_shipping_options(
         payload.options,
         is_dutiable=is_dutiable,
         package_options=packages.options,
         shipper_country=payload.shipper.country_code,
         initializer=provider_units.shipping_options_initializer,
     )
 
     duty = customs.duty or models.Duty(paid_by="sender")
     content = packages[0].parcel.content or customs.content_description or "N/A"
     reference = payload.reference or getattr(payload, "id", None)
+    currency = (
+        options.currency.state
+        or units.CountryCurrency.map(payload.shipper.country_code).value
+        or settings.default_currency
+    )
 
     request = dhl.ShipmentRequest(
         schemaVersion="10.0",
         Request=settings.Request(
             MetaData=dhl.MetaData(SoftwareName="3PV", SoftwareVersion="10.0")
         ),
         RegionCode=provider_units.CountryRegion[shipper.country_code].value,
@@ -137,15 +145,15 @@
             CountryCode=recipient.country_code,
             CountryName=recipient.country_name,
             Contact=dhl.Contact(
                 PersonName=recipient.person_name,
                 PhoneNumber=recipient.phone_number or "0000",
                 Email=recipient.email,
             ),
-            Suburb=recipient.suburb,
+            Suburb=None,
             StreetName=recipient.street_name,
             BuildingName=None,
             StreetNumber=recipient.street_number,
             RegistrationNumbers=None,
             BusinessPartyTypeCode=None,
         ),
         Commodity=(
@@ -160,22 +168,22 @@
             else None
         ),
         Dutiable=(
             dhl_global.Dutiable(
                 DeclaredValue=(
                     duty.declared_value or options.declared_value.state or 1.0
                 ),
-                DeclaredCurrency=(duty.currency or options.currency.state or "USD"),
+                DeclaredCurrency=(duty.currency or currency),
                 ScheduleB=None,
                 ExportLicense=customs.options.license_number.state,
                 ShipperEIN=(
                     customs.options.ein.state or customs.duty_billing_address.tax_id
                 ),
                 ShipperIDType=None,
-                TermsOfTrade=customs.incoterm,
+                TermsOfTrade=customs.incoterm or "DDP",
                 CommerceLicensed=None,
                 Filing=None,
             )
             if is_dutiable
             else None
         ),
         UseDHLInvoice=("Y" if is_dutiable else None),
@@ -195,32 +203,14 @@
                     customs.content_type or "other"
                 ].value,
                 SedNumber=None,
                 SedNumberType=None,
                 MxStateCode=None,
                 InvoiceNumber=(customs.invoice or "0000000"),
                 InvoiceDate=(customs.invoice_date or time.strftime("%Y-%m-%d")),
-                BillToCompanyName=customs.duty_billing_address.company_name or "N/A",
-                BillToContactName=customs.duty_billing_address.person_name or "N/A",
-                BillToAddressLine1=lib.text(
-                    customs.duty_billing_address.street_number,
-                    customs.duty_billing_address.address_line1,
-                ),
-                BillToAddressLine2=lib.text(customs.duty_billing_address.address_line2),
-                BillToCity=customs.duty_billing_address.city,
-                BillToPostcode=customs.duty_billing_address.postal_code,
-                BillToSuburb=None,
-                BillToCountryCode=customs.duty_billing_address.country_code,
-                BillToCountryName=customs.duty_billing_address.country_name,
-                BillToPhoneNumber=(
-                    customs.duty_billing_address.phone_number or "0000000000"
-                ),
-                BillToPhoneNumberExtn=None,
-                BillToFaxNumber=None,
-                BillToFederalTaxID=customs.duty_billing_address.federal_tax_id,
                 Remarks=customs.content_description,
                 DestinationPort=None,
                 TermsOfPayment=None,
                 PayerGSTVAT=customs.duty_billing_address.state_tax_id,
                 SignatureImage=None,
                 ReceiverReference=None,
                 ExporterId=None,
@@ -350,15 +340,15 @@
             GlobalProductCode=product,
             LocalProductCode=product,
             Date=(options.shipment_date.state or time.strftime("%Y-%m-%d")),
             Contents=content,
             DimensionUnit=provider_units.DimensionUnit[dim_unit.name].value,
             PackageType=package_type,
             IsDutiable=("Y" if is_dutiable else "N"),
-            CurrencyCode=options.currency.state or "USD",
+            CurrencyCode=currency,
             CustData=getattr(payload, "id", None),
             ShipmentCharges=(
                 options.cash_on_delivery.state
                 if options.cash_on_delivery.state
                 else None
             ),
             ParentShipmentIdentificationNumber=None,
@@ -382,51 +372,53 @@
             CountryCode=shipper.country_code,
             CountryName=shipper.country_name,
             Contact=dhl.Contact(
                 PersonName=shipper.person_name,
                 PhoneNumber=shipper.phone_number or "0000",
                 Email=shipper.email,
             ),
-            Suburb=shipper.suburb,
+            Suburb=None,
             StreetName=shipper.street_name,
             BuildingName=None,
             StreetNumber=shipper.street_number,
             RegistrationNumbers=None,
             BusinessPartyTypeCode=None,
         ),
         SpecialService=[
             dhl.SpecialService(
-                SpecialServiceType=option.code,
-                ChargeValue=lib.to_money(option.state),
+                SpecialServiceType=svc.code,
+                ChargeValue=lib.to_money(svc.state),
                 CurrencyCode=(
-                    options.currency.state or "USD"
-                    if lib.to_money(option.state) is not None
-                    else None
+                    currency if lib.to_money(svc.state) is not None else None
                 ),
             )
-            for _, option in options.items()
+            for _, svc in options.items()
         ],
         Notification=(
             dhl.Notification(
                 EmailAddress=options.email_notification_to.state or recipient.email
             )
-            if options.email_notification.state
-            and any([options.email_notification_to.state, recipient.email])
+            if (
+                options.email_notification.state
+                and any([options.email_notification_to.state, recipient.email])
+            )
             else None
         ),
         Place=None,
         EProcShip=None,
         Airwaybill=None,
         DocImages=(
             dhl.DocImages(
                 DocImage=[
                     dhl.DocImage(
-                        Type=doc["doc_type"],
-                        Image=doc["doc_file"],
-                        ImageFormat=doc["doc_format"],
+                        Image=base64.b64decode(doc["doc_file"]),
+                        ImageFormat=doc.get("doc_format") or "PDF",
+                        Type=provider_units.UploadDocumentType.map(
+                            doc.get("doc_type") or "CIN"
+                        ).value_or_key,
                     )
                     for doc in options.doc_files.state
                 ]
             )
             if (
                 options.dhl_paperless_trade.state and any(options.doc_files.state or [])
             )
@@ -443,23 +435,25 @@
         GetPriceEstimate="Y",
         SinglePieceImage="N",
         ShipmentIdentificationNumber=None,
         UseOwnShipmentIdentificationNumber="N",
         Importer=None,
     )
 
-    return lib.Serializable(request, _request_serializer)
-
-
-def _request_serializer(request: dhl.ShipmentRequest) -> str:
-    xml_str = lib.to_xml(
+    return lib.Serializable(
         request,
-        name_="req:ShipmentRequest",
-        namespacedef_=(
-            'xsi:schemaLocation="http://www.dhl.com '
-            'ship-val-global-req.xsd" '
-            'xmlns:req="http://www.dhl.com" '
-            'xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"'
+        lambda _: (
+            lib.to_xml(
+                _,
+                name_="req:ShipmentRequest",
+                namespacedef_=(
+                    'xsi:schemaLocation="http://www.dhl.com '
+                    'ship-val-global-req.xsd" '
+                    'xmlns:req="http://www.dhl.com" '
+                    'xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"'
+                ),
+            )
+            .replace('schemaVersion="10"', 'schemaVersion="10.0"')
+            .replace("<Image>b'", "<Image>")
+            .replace("'</Image>", "</Image>")
         ),
-    ).replace('schemaVersion="10"', 'schemaVersion="10.0"')
-
-    return xml_str
+    )
```

## karrio/providers/dhl_express/tracking.py

```diff
@@ -5,17 +5,18 @@
 import karrio.core.models as models
 import karrio.providers.dhl_express.error as error
 import karrio.providers.dhl_express.utils as provider_utils
 import karrio.providers.dhl_express.units as provider_units
 
 
 def parse_tracking_response(
-    response: lib.Element,
+    _response: lib.Deserializable[lib.Element],
     settings: provider_utils.Settings,
 ) -> typing.Tuple[typing.List[models.TrackingDetails], typing.List[models.Message]]:
+    response = _response.deserialize()
     nodes = lib.find_element("AWBInfo", response)
 
     tracking_details = [
         _extract_tracking(node, settings)
         for node in nodes
         if len(lib.find_element("ShipmentInfo", node)) > 0
     ]
@@ -34,19 +35,28 @@
     estimated_delivery = lib.fdate(
         info.findtext("EstDlvyDate"), "%Y-%m-%d %H:%M:%S %Z%z"
     )
     events: typing.List[dhl.ShipmentEvent] = lib.find_element(
         "ShipmentEvent", info, dhl.ShipmentEvent
     )
     delivered = any(e.ServiceEvent.EventCode == "OK" for e in events)
+    status = next(
+        (
+            status.name
+            for status in list(provider_units.TrackingStatus)
+            if events[-1].ServiceEvent.EventCode in status.value
+        ),
+        provider_units.TrackingStatus.in_transit.name,
+    )
 
     return models.TrackingDetails(
         carrier_name=settings.carrier_name,
         carrier_id=settings.carrier_id,
         tracking_number=tracking_number,
+        status=status,
         events=[
             models.TrackingEvent(
                 date=lib.fdate(e.Date),
                 time=lib.ftime(e.Time),
                 code=e.ServiceEvent.EventCode,
                 location=e.ServiceArea.Description,
                 description=lib.text(e.ServiceEvent.Description, e.Signatory),
@@ -66,15 +76,15 @@
         ),
     )
 
 
 def tracking_request(
     payload: models.TrackingRequest,
     settings: provider_utils.Settings,
-) -> lib.Serializable[tracking.KnownTrackingRequest]:
+) -> lib.Serializable:
     options = lib.units.Options(payload.options or {})
 
     request = tracking.KnownTrackingRequest(
         Request=settings.Request(),
         LanguageCode=options.language_code.state or "en",
         LevelOfDetails=options.level_of_details.state or "ALL_CHECK_POINTS",
         AWBNumber=payload.tracking_numbers,
```

## karrio/providers/dhl_express/units.py

```diff
@@ -199,14 +199,32 @@
 class DeliveryType(lib.Enum):
     door_to_door = "DD"
     door_to_airport = "DA"
     airport_to_airport = "AA"
     door_to_door_c = "DC"
 
 
+class UploadDocumentType(lib.Enum):
+    HWB = "HWB"
+    INV = "INV"
+    PNV = "PNV"
+    COO = "COO"
+    NAF = "NAF"
+    CIN = "CIN"
+    DCL = "DCL"
+
+    """ Unified Packaging type mapping """
+
+    certificate_of_origin = COO
+    commercial_invoice = CIN
+    pro_forma_invoice = PNV
+    packing_list = DCL
+    other = INV
+
+
 class DCTPackageType(lib.Enum):
     dhl_flyer_smalls = "FLY"
     dhl_parcels_conveyables = "COY"
     dhl_non_conveyables = "NCY"
     dhl_pallets = "PAL"
     dhl_double_pallets = "DBL"
     dhl_box = "BOX"
@@ -263,84 +281,83 @@
     medium_box = dhl_jumbo_box
     large_box = dhl_jumbo_parcel
     your_packaging = dhl_your_packaging
 
 
 class ShippingService(lib.Enum):
     dhl_logistics_services = "0"
-    dhl_domestic_express_12_00_doc = "1"
-    dhl_b2c_doc = "2"
-    dhl_b2c_nondoc = "3"
+    dhl_domestic_express_12_00 = "1"
+    dhl_express_choice = "2"
+    dhl_express_choice_nondoc = "3"
     dhl_jetline = "4"
     dhl_sprintline = "5"
-    dhl_express_easy_doc = "7"
+    dhl_air_capacity_sales = "6"
+    dhl_express_easy = "7"
     dhl_express_easy_nondoc = "8"
-    dhl_europack_doc = "9"
-    dhl_auto_reversals = "A"
-    dhl_breakbulk_express_doc = "B"
-    dhl_medical_express_doc = "C"
+    dhl_parcel_product = "9"
+    dhl_accounting = "A"
+    dhl_breakbulk_express = "B"
+    dhl_medical_express = "C"
     dhl_express_worldwide_doc = "D"
     dhl_express_9_00_nondoc = "E"
     dhl_freight_worldwide_nondoc = "F"
-    dhl_domestic_economy_select_doc = "G"
+    dhl_economy_select_domestic = "G"
     dhl_economy_select_nondoc = "H"
-    dhl_domestic_express_9_00_doc = "I"
+    dhl_express_domestic_9_00 = "I"
     dhl_jumbo_box_nondoc = "J"
-    dhl_express_9_00_doc = "K"
-    dhl_express_10_30_doc = "L"
+    dhl_express_9_00 = "K"
+    dhl_express_10_30 = "L"
     dhl_express_10_30_nondoc = "M"
-    dhl_domestic_express_doc = "N"
-    dhl_domestic_express_10_30_doc = "O"
+    dhl_express_domestic = "N"
+    dhl_express_domestic_10_30 = "O"
     dhl_express_worldwide_nondoc = "P"
     dhl_medical_express_nondoc = "Q"
-    dhl_globalmail_business_doc = "R"
-    dhl_same_day_doc = "S"
-    dhl_express_12_00_doc = "T"
-    dhl_express_worldwide_ecx_doc = "U"
-    dhl_europack_nondoc = "V"
-    dhl_economy_select_doc = "W"
-    dhl_express_envelope_doc = "X"
+    dhl_globalmail = "R"
+    dhl_same_day = "S"
+    dhl_express_12_00 = "T"
+    dhl_express_worldwide = "U"
+    dhl_parcel_product_nondoc = "V"
+    dhl_economy_select = "W"
+    dhl_express_envelope = "X"
     dhl_express_12_00_nondoc = "Y"
     dhl_destination_charges = "Z"
     dhl_express_all = None
 
 
 def shipping_services_initializer(
     services: typing.List[str],
     is_international: bool = True,
     is_document: bool = False,
     is_envelope: bool = False,
     origin_country: str = None,
-) -> typing.List[str]:
-    """
-    Apply default product codes to the list of products.
-    """
-    products = list(set(services))
-    no_service_provided = (
-        any([ShippingService.map(_).key is not None for _ in products]) is False
+) -> lib.units.Services:
+    """Apply default product codes to the list of products."""
+    _region = CountryRegion.map(origin_country).value
+    _services = list(set(services))
+    _no_service_provided = (
+        any([ShippingService.map(_).key is not None for _ in _services]) is False
     )
-    region = CountryRegion.map(origin_country).value
 
-    if no_service_provided and region == "AM":
+    if _no_service_provided and _region == "AM":
         if is_international and is_document:
-            products.append("dhl_express_worldwide_doc")
+            _services.append("dhl_express_worldwide_doc")
 
         if is_international and (is_document is False):
-            products.append("dhl_express_worldwide_nondoc")
+            _services.append("dhl_express_worldwide_nondoc")
 
         if (is_international is False) and (is_document and is_envelope):
-            products.append("dhl_express_envelope_doc")
+            _services.append("dhl_express_envelope_doc")
 
         if (is_international is False) and is_document and (is_envelope is False):
-            products.append("dhl_domestic_express_doc")
+            _services.append("dhl_domestic_express_doc")
 
-    elif region != "AM":
-        products = ["dhl_express_all"]
+    elif _region != "AM":
+        _services = ["dhl_express_all"]
 
-    return lib.units.Services(list(set(products)), ShippingService)
+    return lib.units.Services(_services, ShippingService)
 
 
 class ShippingOption(lib.Enum):
     dhl_logistics_services = lib.OptionEnum("0A", bool)
     dhl_mailroom_management = lib.OptionEnum("0B", bool)
     dhl_pallet_administration = lib.OptionEnum("0C", bool)
     dhl_warehousing = lib.OptionEnum("0D", bool)
@@ -569,27 +586,25 @@
     """ Unified Option type mapping """
     insurance = dhl_shipment_insurance
     cash_on_delivery = dhl_cash_on_delivery
 
 
 def shipping_options_initializer(
     options: dict,
-    is_international: bool = True,
-    is_dutiable: bool = True,
+    is_dutiable: bool = False,
     package_options: lib.units.Options = None,
     shipper_country: str = "",
 ) -> lib.units.Options:
     """
     Apply default values to the given options.
     """
     _options = options.copy()
 
     if (
-        is_international
-        and is_dutiable
+        is_dutiable
         and ShippingOption.dhl_paperless_trade.name not in options
         and shipper_country not in UNSUPPORTED_PAPERLESS_COUNTRIES
     ):
         _options.update({ShippingOption.dhl_paperless_trade.name: True})
 
     if package_options is not None:
         _options.update(package_options.content)
@@ -598,14 +613,23 @@
         return key in ShippingOption  # type: ignore
 
     return lib.units.ShippingOptions(
         _options, ShippingOption, items_filter=items_filter
     )
 
 
+class TrackingStatus(lib.Enum):
+    on_hold = ["BA", "HP", "OH"]
+    delivered = ["OK"]
+    in_transit = [""]
+    delivery_failed = ["CM", "DM", "DP", "DS", "NH", "RD", "RT", "SS", "ST"]
+    delivery_delayed = ["IR", "MD", "TD", "UD"]
+    out_for_delivery = ["WC"]
+
+
 class CountryRegion(lib.Enum):
     AD = "EU"
     AE = "AP"
     AF = "AP"
     AG = "AM"
     AI = "AM"
     AL = "AP"
```

## karrio/providers/dhl_express/utils.py

```diff
@@ -1,13 +1,15 @@
+import dhl_express_lib.datatypes_global_v62 as dhl
 import time
-from dhl_express_lib.datatypes_global_v62 import ServiceHeader, Request
-from karrio.core import Settings as BaseSettings
+import typing
+import karrio.core as core
+import karrio.core.units as units
 
 
-class Settings(BaseSettings):
+class Settings(core.Settings):
     """DHL connection settings."""
 
     site_id: str
     password: str
     account_number: str = None
     account_country_code: str = None
     metadata: dict = {}
@@ -26,26 +28,28 @@
             else "https://xmlpi-ea.dhl.com/XMLShippingServlet"
         )
 
     @property
     def tracking_url(self):
         return "https://www.dhl.com/ca-en/home/tracking/tracking-parcel.html?submit=1&tracking-id={}"
 
-    def Request(self, **kwargs) -> Request:
-        return Request(
-            ServiceHeader=ServiceHeader(
+    @property
+    def default_currency(self) -> typing.Optional[str]:
+        return units.CountryCurrency.map(self.account_country_code).value or "USD"
+
+    def Request(self, **kwargs) -> dhl.Request:
+        return dhl.Request(
+            ServiceHeader=dhl.ServiceHeader(
                 MessageReference="1234567890123456789012345678901",
                 MessageTime=time.strftime("%Y-%m-%dT%H:%M:%S"),
                 SiteID=self.site_id,
                 Password=self.password,
             ),
             **kwargs,
         )
 
 
 def reformat_time(tag: str, xml_str: str) -> str:
-    """
-    Change time format from 00:00:00 to 00:00
-    """
+    """Change time format from 00:00:00 to 00:00"""
     parts = xml_str.split(tag)
     subs = parts[1].split(":")
     return f"{parts[0]}{tag}{subs[0]}:{subs[1]}</{tag}{parts[2]}"
```

## karrio/providers/dhl_express/pickup/cancel.py

```diff
@@ -1,68 +1,67 @@
+import dhl_express_lib.cancel_pickup_global_req_3_0 as dhl
 import time
-from typing import Tuple, List
-from dhl_express_lib.cancel_pickup_global_req_3_0 import CancelPURequest, MetaData
-from karrio.core.utils import XP, Serializable
-from karrio.core.models import (
-    PickupCancelRequest,
-    Message,
-    ConfirmationDetails,
-)
-from karrio.providers.dhl_express.utils import Settings, reformat_time
-from karrio.providers.dhl_express.error import parse_error_response
-from karrio.providers.dhl_express.units import CountryRegion
+import typing
+import karrio.lib as lib
+import karrio.core.models as models
+import karrio.providers.dhl_express.units as provider_units
+import karrio.providers.dhl_express.error as provider_error
+import karrio.providers.dhl_express.utils as provider_utils
 
 
 def parse_pickup_cancel_response(
-    response, settings
-) -> Tuple[ConfirmationDetails, List[Message]]:
-    successful = (
-        len(response.xpath(".//*[local-name() = $name]", name="ConfirmationNumber")) > 0
-    )
+    _response: lib.Deserializable[lib.Element],
+    settings: provider_utils.Settings,
+) -> typing.Tuple[models.ConfirmationDetails, typing.List[models.Message]]:
+    response = _response.deserialize()
+    successful = len(lib.find_element("ConfirmationNumber", response)) > 0
     cancellation = (
-        ConfirmationDetails(
+        models.ConfirmationDetails(
             carrier_name=settings.carrier_name,
             carrier_id=settings.carrier_id,
             success=successful,
             operation="Cancel Pickup",
         )
         if successful
         else None
     )
 
-    return cancellation, parse_error_response(response, settings)
+    return cancellation, provider_error.parse_error_response(response, settings)
 
 
 def pickup_cancel_request(
-    payload: PickupCancelRequest, settings: Settings
-) -> Serializable[CancelPURequest]:
-
-    request = CancelPURequest(
+    payload: models.PickupCancelRequest,
+    settings: provider_utils.Settings,
+) -> lib.Serializable:
+    request = dhl.CancelPURequest(
         Request=settings.Request(
-            MetaData=MetaData(SoftwareName="XMLPI", SoftwareVersion=1.0)
+            MetaData=dhl.MetaData(SoftwareName="XMLPI", SoftwareVersion=1.0)
         ),
         schemaVersion=3.0,
         RegionCode=(
-            CountryRegion[payload.address.country_code].value
+            provider_units.CountryRegion[payload.address.country_code].value
             if payload.address is not None and payload.address.country_code is not None
             else "AM"
         ),
         ConfirmationNumber=payload.confirmation_number,
         RequestorName=payload.address.person_name,
         CountryCode=payload.address.country_code,
         Reason="006",
         PickupDate=payload.pickup_date,
         CancelTime=time.strftime("%H:%M:%S"),
     )
 
-    return Serializable(request, _request_serializer)
-
-
-def _request_serializer(request: CancelPURequest) -> str:
-    xml_str = XP.export(
+    return lib.Serializable(
         request,
-        name_="req:CancelPURequest",
-        namespacedef_='xmlns:req="http://www.dhl.com" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.dhl.com cancel-pickup-global-req.xsd"',
-    ).replace('schemaVersion="3"', 'schemaVersion="3.0"')
-
-    xml_str = reformat_time("CancelTime", xml_str)
-    return xml_str
+        lambda _: provider_utils.reformat_time(
+            "CancelTime",
+            lib.to_xml(
+                _,
+                name_="req:CancelPURequest",
+                namespacedef_=(
+                    'xmlns:req="http://www.dhl.com" '
+                    'xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" '
+                    'xsi:schemaLocation="http://www.dhl.com cancel-pickup-global-req.xsd"'
+                ),
+            ).replace('schemaVersion="3"', 'schemaVersion="3.0"'),
+        ),
+    )
```

## karrio/providers/dhl_express/pickup/create.py

```diff
@@ -28,19 +28,19 @@
     WeightUnit as DHLWeightUnit,
 )
 from karrio.providers.dhl_express.utils import Settings, reformat_time
 from karrio.providers.dhl_express.error import parse_error_response
 
 
 def parse_pickup_response(
-    response, settings: Settings
+    _response: lib.Deserializable[lib.Element],
+    settings: Settings,
 ) -> Tuple[PickupDetails, List[Message]]:
-    successful = (
-        len(response.xpath(".//*[local-name() = $name]", name="ConfirmationNumber")) > 0
-    )
+    response = _response.deserialize()
+    successful = len(lib.find_element("ConfirmationNumber", response)) > 0
     pickup = _extract_pickup(response, settings) if successful else None
     return pickup, parse_error_response(response, settings)
 
 
 def _extract_pickup(response: Element, settings: Settings) -> PickupDetails:
     pickup = BookPUResponse()
     pickup.build(response)
@@ -60,17 +60,15 @@
         pickup_date=DF.fdate(pickup.NextPickupDate),
         pickup_charge=pickup_charge,
         ready_time=DF.ftime(pickup.ReadyByTime),
         closing_time=DF.ftime(pickup.CallInTime),
     )
 
 
-def pickup_request(
-    payload: PickupRequest, settings: Settings
-) -> Serializable[BookPURequest]:
+def pickup_request(payload: PickupRequest, settings: Settings) -> Serializable:
     packages = Packages(payload.parcels)
     address = lib.to_address(payload.address)
 
     request = BookPURequest(
         Request=settings.Request(
             MetaData=MetaData(SoftwareName="XMLPI", SoftwareVersion=3.0)
         ),
```

## karrio/providers/dhl_express/pickup/update.py

```diff
@@ -17,26 +17,28 @@
 )
 from karrio.core.models import (
     Message,
     PickupDetails,
     ChargeDetails,
     PickupUpdateRequest,
 )
-from karrio.core.units import WeightUnit, Weight, Packages
+from karrio.core.units import Packages
 from karrio.providers.dhl_express.units import (
     CountryRegion,
     WeightUnit as DHLWeightUnit,
 )
 from karrio.providers.dhl_express.utils import Settings, reformat_time
 from karrio.providers.dhl_express.error import parse_error_response
+import karrio.lib as lib
 
 
 def parse_pickup_update_response(
-    response, settings: Settings
+    _response: lib.Deserializable[lib.Element], settings: Settings
 ) -> Tuple[PickupDetails, List[Message]]:
+    response = _response.deserialize()
     successful = (
         len(response.xpath(".//*[local-name() = $name]", name="ConfirmationNumber")) > 0
     )
     pickup = _extract_pickup(response, settings) if successful else None
     return pickup, parse_error_response(response, settings)
 
 
@@ -65,15 +67,15 @@
         ready_time=DF.ftime(pickup.ReadyByTime),
         closing_time=DF.ftime(pickup.CallInTime),
     )
 
 
 def pickup_update_request(
     payload: PickupUpdateRequest, settings: Settings
-) -> Serializable[ModifyPURequest]:
+) -> Serializable:
     packages = Packages(payload.parcels)
 
     request = ModifyPURequest(
         Request=settings.Request(
             MetaData=MetaData(SoftwareName="XMLPI", SoftwareVersion=1.0)
         ),
         schemaVersion=3.0,
```

## Comparing `karrio.dhl_express-2023.3.4.dist-info/METADATA` & `karrio.dhl_express-2023.4.dist-info/METADATA`

 * *Files 12% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: karrio.dhl-express
-Version: 2023.3.4
+Version: 2023.4
 Summary: Karrio - DHL Express Shipping Extension
 Home-page: https://github.com/karrioapi/karrio
 Author: karrio
 Author-email: hello@karrio.io
 License: Apache-2.0
 Platform: UNKNOWN
 Classifier: Intended Audience :: Developers
```

