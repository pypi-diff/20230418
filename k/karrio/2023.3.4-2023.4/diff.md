# Comparing `tmp/karrio-2023.3.4-py3-none-any.whl.zip` & `tmp/karrio-2023.4-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,53 +1,53 @@
-Zip file size: 156722 bytes, number of entries: 51
+Zip file size: 157814 bytes, number of entries: 51
 -rw-rw-r--  2.0 unx     3149 b- defN 22-Nov-15 19:21 karrio/__init__.py
--rw-rw-r--  2.0 unx    17459 b- defN 23-Mar-29 10:26 karrio/lib.py
--rw-rw-r--  2.0 unx     4673 b- defN 23-Mar-03 13:50 karrio/references.py
+-rw-rw-r--  2.0 unx    18075 b- defN 23-Apr-15 10:27 karrio/lib.py
+-rw-rw-r--  2.0 unx     4969 b- defN 23-Apr-15 10:18 karrio/references.py
 -rw-rw-r--  2.0 unx        0 b- defN 23-Mar-03 13:50 karrio/addons/__init__.py
 -rw-rw-r--  2.0 unx    10316 b- defN 23-Mar-03 13:50 karrio/addons/label.py
 -rw-rw-r--  2.0 unx     7016 b- defN 23-Mar-03 13:50 karrio/addons/renderer.py
 -rw-rw-r--  2.0 unx    91400 b- defN 23-Mar-03 13:50 karrio/addons/fonts/Oswald-Regular.ttf
 -rw-rw-r--  2.0 unx    91700 b- defN 23-Mar-03 13:50 karrio/addons/fonts/Oswald-SemiBold.ttf
 -rw-rw-r--  2.0 unx      127 b- defN 22-Nov-15 19:21 karrio/api/__init__.py
 -rw-rw-r--  2.0 unx     4955 b- defN 23-Mar-27 07:55 karrio/api/gateway.py
--rw-rw-r--  2.0 unx    14594 b- defN 23-Jan-04 00:29 karrio/api/interface.py
+-rw-rw-r--  2.0 unx    16054 b- defN 23-Apr-17 22:03 karrio/api/interface.py
 -rw-rw-r--  2.0 unx    13472 b- defN 22-Nov-15 19:21 karrio/api/mapper.py
 -rw-rw-r--  2.0 unx     6320 b- defN 22-Nov-15 19:21 karrio/api/proxy.py
 -rw-rw-r--  2.0 unx       71 b- defN 22-Nov-15 19:21 karrio/core/__init__.py
 -rw-rw-r--  2.0 unx     3006 b- defN 22-Nov-15 19:21 karrio/core/errors.py
--rw-rw-r--  2.0 unx     1029 b- defN 22-Nov-15 19:21 karrio/core/metadata.py
--rw-rw-r--  2.0 unx    11098 b- defN 23-Mar-27 07:55 karrio/core/models.py
--rw-rw-r--  2.0 unx      518 b- defN 22-Nov-15 19:21 karrio/core/settings.py
--rw-rw-r--  2.0 unx    55580 b- defN 23-Mar-28 21:43 karrio/core/units.py
+-rw-rw-r--  2.0 unx     1081 b- defN 23-Apr-15 10:13 karrio/core/metadata.py
+-rw-rw-r--  2.0 unx    11152 b- defN 23-Apr-17 22:12 karrio/core/models.py
+-rw-rw-r--  2.0 unx      753 b- defN 23-Apr-15 10:50 karrio/core/settings.py
+-rw-rw-r--  2.0 unx    57529 b- defN 23-Apr-15 10:57 karrio/core/units.py
 -rw-rw-r--  2.0 unx      739 b- defN 23-Mar-27 07:55 karrio/core/utils/__init__.py
 -rw-rw-r--  2.0 unx     1734 b- defN 23-Mar-27 07:55 karrio/core/utils/caching.py
 -rw-rw-r--  2.0 unx     2311 b- defN 22-Nov-15 19:21 karrio/core/utils/datetime.py
 -rw-rw-r--  2.0 unx     2312 b- defN 23-Mar-02 21:11 karrio/core/utils/dict.py
 -rw-rw-r--  2.0 unx     4420 b- defN 23-Mar-15 03:59 karrio/core/utils/enum.py
--rw-rw-r--  2.0 unx     7593 b- defN 23-Mar-18 11:05 karrio/core/utils/helpers.py
+-rw-rw-r--  2.0 unx     8518 b- defN 23-Apr-10 05:55 karrio/core/utils/helpers.py
 -rw-rw-r--  2.0 unx      434 b- defN 22-Nov-15 19:21 karrio/core/utils/log.py
 -rw-rw-r--  2.0 unx     1176 b- defN 22-Nov-15 19:21 karrio/core/utils/number.py
 -rw-rw-r--  2.0 unx     1253 b- defN 23-Mar-27 07:55 karrio/core/utils/pipeline.py
--rw-rw-r--  2.0 unx      890 b- defN 23-Mar-27 07:55 karrio/core/utils/serializable.py
+-rw-rw-r--  2.0 unx      916 b- defN 23-Apr-01 13:32 karrio/core/utils/serializable.py
 -rw-rw-r--  2.0 unx     5274 b- defN 22-Nov-15 19:21 karrio/core/utils/soap.py
 -rw-rw-r--  2.0 unx      762 b- defN 22-Nov-15 19:21 karrio/core/utils/string.py
 -rw-rw-r--  2.0 unx     1462 b- defN 23-Mar-17 22:30 karrio/core/utils/tracing.py
 -rw-rw-r--  2.0 unx     4887 b- defN 23-Mar-27 07:55 karrio/core/utils/transformer.py
--rw-rw-r--  2.0 unx     5493 b- defN 23-Mar-29 10:21 karrio/core/utils/xml.py
+-rw-rw-r--  2.0 unx     5493 b- defN 23-Mar-29 20:04 karrio/core/utils/xml.py
 -rw-rw-r--  2.0 unx      129 b- defN 22-Nov-15 19:21 karrio/mappers/__init__.py
 -rw-rw-r--  2.0 unx      131 b- defN 22-Nov-15 19:21 karrio/providers/__init__.py
 -rw-rw-r--  2.0 unx       81 b- defN 22-Nov-15 19:21 karrio/universal/__init__.py
 -rw-rw-r--  2.0 unx       81 b- defN 22-Nov-15 19:21 karrio/universal/mappers/__init__.py
--rw-rw-r--  2.0 unx    10686 b- defN 23-Mar-27 16:49 karrio/universal/mappers/rating_proxy.py
--rw-rw-r--  2.0 unx     1952 b- defN 23-Mar-03 13:50 karrio/universal/mappers/shipping_proxy.py
+-rw-rw-r--  2.0 unx    10634 b- defN 23-Apr-01 13:30 karrio/universal/mappers/rating_proxy.py
+-rw-rw-r--  2.0 unx     1935 b- defN 23-Apr-01 13:30 karrio/universal/mappers/shipping_proxy.py
 -rw-rw-r--  2.0 unx       81 b- defN 22-Nov-15 19:21 karrio/universal/providers/__init__.py
 -rw-rw-r--  2.0 unx      139 b- defN 22-Nov-15 19:21 karrio/universal/providers/rating/__init__.py
--rw-rw-r--  2.0 unx      808 b- defN 23-Mar-27 07:55 karrio/universal/providers/rating/rate.py
+-rw-rw-r--  2.0 unx      861 b- defN 23-Apr-01 15:40 karrio/universal/providers/rating/rate.py
 -rw-rw-r--  2.0 unx      558 b- defN 23-Mar-27 16:45 karrio/universal/providers/rating/utils.py
 -rw-rw-r--  2.0 unx      188 b- defN 23-Mar-03 13:50 karrio/universal/providers/shipping/__init__.py
--rw-rw-r--  2.0 unx     1468 b- defN 23-Mar-03 13:50 karrio/universal/providers/shipping/shipment.py
+-rw-rw-r--  2.0 unx     1512 b- defN 23-Apr-01 15:40 karrio/universal/providers/shipping/shipment.py
 -rw-rw-r--  2.0 unx      593 b- defN 23-Mar-03 13:50 karrio/universal/providers/shipping/utils.py
--rw-rw-r--  2.0 unx     4705 b- defN 23-Mar-29 13:35 karrio-2023.3.4.dist-info/METADATA
--rw-rw-r--  2.0 unx       92 b- defN 23-Mar-29 13:35 karrio-2023.3.4.dist-info/WHEEL
--rw-rw-r--  2.0 unx        7 b- defN 23-Mar-29 13:35 karrio-2023.3.4.dist-info/top_level.txt
--rw-rw-r--  2.0 unx     4322 b- defN 23-Mar-29 13:35 karrio-2023.3.4.dist-info/RECORD
-51 files, 403244 bytes uncompressed, 149846 bytes compressed:  62.8%
+-rw-rw-r--  2.0 unx     4703 b- defN 23-Apr-18 07:10 karrio-2023.4.dist-info/METADATA
+-rw-rw-r--  2.0 unx       92 b- defN 23-Apr-18 07:10 karrio-2023.4.dist-info/WHEEL
+-rw-rw-r--  2.0 unx        7 b- defN 23-Apr-18 07:10 karrio-2023.4.dist-info/top_level.txt
+-rw-rw-r--  2.0 unx     4314 b- defN 23-Apr-18 07:10 karrio-2023.4.dist-info/RECORD
+51 files, 408875 bytes uncompressed, 150954 bytes compressed:  63.1%
```

## zipnote {}

```diff
@@ -135,20 +135,20 @@
 
 Filename: karrio/universal/providers/shipping/shipment.py
 Comment: 
 
 Filename: karrio/universal/providers/shipping/utils.py
 Comment: 
 
-Filename: karrio-2023.3.4.dist-info/METADATA
+Filename: karrio-2023.4.dist-info/METADATA
 Comment: 
 
-Filename: karrio-2023.3.4.dist-info/WHEEL
+Filename: karrio-2023.4.dist-info/WHEEL
 Comment: 
 
-Filename: karrio-2023.3.4.dist-info/top_level.txt
+Filename: karrio-2023.4.dist-info/top_level.txt
 Comment: 
 
-Filename: karrio-2023.3.4.dist-info/RECORD
+Filename: karrio-2023.4.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## karrio/lib.py

```diff
@@ -364,15 +364,19 @@
     options: dict,
     initializer: typing.Optional[typing.Callable[[dict], units.ShippingOptions]] = None,
     **kwargs,
 ) -> units.ShippingOptions:
     if initializer is not None:
         return initializer(options, **kwargs)
 
-    return units.ShippingOptions(options)
+    return units.ShippingOptions(
+        options,
+        option_type=kwargs.get("option_type"),
+        items_filter=kwargs.get("items_filter"),
+    )
 
 
 def to_services(
     services: typing.List[str],
     service_type: typing.Type[utils.Enum] = None,
     initializer: typing.Optional[
         typing.Callable[[typing.List[str]], units.Services]
@@ -418,14 +422,24 @@
     return units.Options(
         options,
         option_type=option_type,
         base_option_type=units.DocumentUploadOption,
     )
 
 
+def to_connection_config(
+    options: dict,
+    option_type: typing.Optional[typing.Type[utils.Enum]] = None,
+) -> units.ConnectionConfigOptions:
+    return units.ConnectionConfigOptions(
+        options,
+        option_type=option_type,
+    )
+
+
 # -----------------------------------------------------------
 # Address utility functions.
 # -----------------------------------------------------------
 
 
 def to_zip4(
     value: typing.Optional[str],
@@ -573,16 +587,17 @@
 # image and document processing utility functions.
 # -----------------------------------------------------------
 
 
 def image_to_pdf(
     image_str: str,
     rotate: int = None,
+    resize: dict = None,
 ) -> str:
-    return utils.image_to_pdf(image_str, rotate=rotate)
+    return utils.image_to_pdf(image_str, rotate=rotate, resize=resize)
 
 
 def bundle_pdfs(
     base64_strings: typing.List[str],
 ) -> utils.PdfMerger:
     return utils.bundle_pdfs(base64_strings)
 
@@ -595,14 +610,24 @@
 
 def bundle_zpls(
     base64_strings: typing.List[str],
 ) -> str:
     return utils.bundle_zpls(base64_strings)
 
 
+def zpl_to_pdf(
+    zpl_str: str,
+    width: int,
+    height: int,
+    dpmm: int = 12,
+) -> str:
+    """Return a PDF base64 string from a ZPL string."""
+    return utils.zpl_to_pdf(zpl_str, width, height, dpmm=dpmm)
+
+
 def bundle_base64(
     base64_strings: typing.List[str],
     format: str = "PDF",
 ) -> str:
     return utils.bundle_base64(base64_strings, format=format)
```

## karrio/references.py

```diff
@@ -74,14 +74,19 @@
         if mapper.get("services") is not None
     }
     options = {
         key: {c.name: dict(code=c.value.code) for c in list(mapper["options"])}  # type: ignore
         for key, mapper in PROVIDERS_DATA.items()
         if mapper.get("options") is not None
     }
+    connection_configs = {
+        key: {c.name: dict(code=c.value.code) for c in list(mapper["connection_configs"])}  # type: ignore
+        for key, mapper in PROVIDERS_DATA.items()
+        if mapper.get("connection_configs") is not None
+    }
 
     REFERENCES = {
         "countries": {c.name: c.value for c in list(units.Country)},
         "currencies": {c.name: c.value for c in list(units.Currency)},
         "weight_units": {c.name: c.value for c in list(units.WeightUnit)},
         "dimension_units": {c.name: c.value for c in list(units.DimensionUnit)},
         "states": {
@@ -99,14 +104,15 @@
         "carrier_hubs": {
             carrier_name: metadata.label
             for carrier_name, metadata in PROVIDERS.items()
             if metadata.is_hub
         },
         "services": services,
         "options": options,
+        "connection_configs": connection_configs,
         "carrier_capabilities": {
             key: detect_capabilities(detect_proxy_methods(mapper["Proxy"]))
             for key, mapper in PROVIDERS_DATA.items()
             if mapper.get("Proxy") is not None
         },
         "packaging_types": {
             key: {c.name: c.value for c in list(mapper["packaging_types"])}  # type: ignore
```

## karrio/api/interface.py

```diff
@@ -77,14 +77,35 @@
 
     if any(errors):
         return False, IDeserialize(lambda: (None, errors))  # type: ignore
 
     return True, None
 
 
+def filter_rates(rates: typing.List[models.RateDetails], gateway: gateway.Gateway):
+    """Filter rates by gateway
+
+    Args:
+        rates (List[models.Rate]): the rates to filter
+        gateways (List[gateway.Gateway]): the gateways to filter by
+
+    Returns:
+        List[models.Rate]: the filtered rates
+    """
+    restricted_services = (
+        gateway.settings.connection_config.shipping_services.state or []
+    )
+
+    return [
+        rate
+        for rate in rates
+        if (not any(restricted_services) or rate.service in restricted_services)
+    ]
+
+
 @attr.s(auto_attribs=True)
 class IDeserialize:
     """A lazy deserializer type class"""
 
     deserialize: typing.Callable[[typing.Any], S]
 
     def parse(self):
@@ -286,15 +307,37 @@
 
             deserializable_collection: typing.List[
                 IDeserialize
             ] = lib.run_asynchronously(lambda g: fail_safe(g)(process)(g), gateways)
 
             def flatten(*args):
                 responses = [p.parse() for p in deserializable_collection]
-                flattened_rates = sum((r for r, _ in responses if r is not None), [])
+                flattened_rates = sum(
+                    (
+                        (
+                            (lambda gateway: filter_rates(rates, gateway))(
+                                # find the gateway that matches the carrier_id of the rates
+                                next(
+                                    (
+                                        g
+                                        for g in gateways
+                                        if (
+                                            g.settings.carrier_id == rates[0].carrier_id
+                                        )
+                                    )
+                                )
+                            )
+                            if len(rates) > 0
+                            else rates
+                        )
+                        for rates, _ in responses
+                        if rates is not None
+                    ),
+                    [],
+                )
                 messages = sum((m for _, m in responses), [])
                 return flattened_rates, messages
 
             return IDeserialize(flatten)
 
         return IRequestFromMany(action)
```

## karrio/core/metadata.py

```diff
@@ -19,18 +19,19 @@
 
     # Integrations
     Mapper: Type[Mapper]
     Proxy: Type[Proxy]
     Settings: Type[Settings]
 
     # Data Units
-    services: Optional[Type[Enum]] = None
     options: Optional[Type[Enum]] = None
+    services: Optional[Type[Enum]] = None
     package_presets: Optional[Type[Enum]] = None
     packaging_types: Optional[Type[Enum]] = None
+    connection_configs: Optional[Type[Enum]] = None
     service_levels: Optional[List[ServiceLevel]] = None
 
     id: Optional[str] = None
     is_hub: Optional[bool] = False
     hub_carriers: Optional[Dict[str, str]] = None
 
     def __getitem__(self, item):
```

## karrio/core/models.py

```diff
@@ -300,20 +300,21 @@
     package_weight_unit: str = None
     shipment_package_count: str = None
     shipment_pickup_date: str = None
     shipment_delivery_date: str = None
     shipment_service: str = None
     shipment_origin_country: str = None
     shipment_origin_postal_code: str = None
-    shipment_destication_country: str = None
+    shipment_destination_country: str = None
     shipment_destination_postal_code: str = None
     shipping_date: str = None
     signed_by: str = None
     source: str = None
 
+
 @attr.s(auto_attribs=True)
 class TrackingDetails:
     """Karrio unified tracking details data type."""
 
     carrier_name: str
     carrier_id: str
     tracking_number: str
@@ -326,14 +327,17 @@
 
 
 @attr.s(auto_attribs=True)
 class Documents:
     """Karrio unified shipment details data type."""
 
     label: str
+    zpl_label: str = None
+    pdf_label: str = None
+
     invoice: str = None
 
 
 @attr.s(auto_attribs=True)
 class ShipmentDetails:
     """Karrio unified shipment details data type."""
```

## karrio/core/settings.py

```diff
@@ -1,26 +1,35 @@
 """Karrio Settings abstract class definition"""
 
+import abc
 import attr
-from typing import Optional
-from abc import ABC
+import typing
 
 
 @attr.s(auto_attribs=True)
-class Settings(ABC):
-    """
-    Unified API carrier Connection settings (Interface)
-    """
+class Settings(abc.ABC):
+    """Unified API carrier Connection settings (Interface)"""
 
     carrier_id: str
-    id: str = None
-    test_mode: bool = False
     account_country_code: str = None
+    test_mode: bool = False
     metadata: dict = {}
+    config: dict = {}
+    id: str = None
+
+    @property
+    def carrier_name(self) -> typing.Optional[str]:
+        return None
 
     @property
-    def server_url(self) -> Optional[str]:
+    def server_url(self) -> typing.Optional[str]:
         return None
 
     @property
-    def carrier_name(self) -> Optional[str]:
+    def tracking_url(self) -> typing.Optional[str]:
         return None
+
+    @property
+    def connection_config(self):
+        import karrio.lib as lib
+
+        return lib.to_connection_config(self.config or {})
```

## karrio/core/units.py

```diff
@@ -135,14 +135,19 @@
 
 class MeasurementOptionsType(typing.NamedTuple):
     min_in: typing.Optional[float] = None
     min_cm: typing.Optional[float] = None
     min_lb: typing.Optional[float] = None
     min_kg: typing.Optional[float] = None
     min_oz: typing.Optional[float] = None
+    max_in: typing.Optional[float] = None
+    max_cm: typing.Optional[float] = None
+    max_lb: typing.Optional[float] = None
+    max_kg: typing.Optional[float] = None
+    max_oz: typing.Optional[float] = None
     quant: typing.Optional[float] = None
 
 
 class CarrierCapabilities(utils.Enum):
     pickup = "pickup"
     rating = "rating"
     shipping = "shipping"
@@ -424,14 +429,18 @@
     def __iter__(self) -> typing.Iterator[Product]:
         return iter(self._items)
 
     @property
     def quantity(self):
         return sum((item.quantity for item in self._items), 0)
 
+    @property
+    def value_amount(self):
+        return sum((item.value_amount or 0.0 for item in self._items), 0.0)
+
 
 class Package:
     """The parcel common processing helper"""
 
     def __init__(
         self,
         parcel: models.Parcel,
@@ -826,19 +835,21 @@
 
 class ShippingOption(utils.Enum):
     """universal shipment options (special services)"""
 
     currency = utils.OptionEnum("currency")
     insurance = utils.OptionEnum("insurance", float)
     cash_on_delivery = utils.OptionEnum("COD", float)
+    shipment_note = utils.OptionEnum("shipment_note")
     shipment_date = utils.OptionEnum("shipment_date")
     dangerous_good = utils.OptionEnum("dangerous_good", bool)
     declared_value = utils.OptionEnum("declared_value", float)
     paperless_trade = utils.OptionEnum("paperless_trade", bool)
     hold_at_location = utils.OptionEnum("hold_at_location", bool)
+    sms_notification = utils.OptionEnum("email_notification", bool)
     email_notification = utils.OptionEnum("email_notification", bool)
     email_notification_to = utils.OptionEnum("email_notification_to")
     signature_confirmation = utils.OptionEnum("signature_confirmation", bool)
     doc_files = utils.OptionEnum("doc_files", utils.DP.to_dict)
     doc_references = utils.OptionEnum("doc_references", utils.DP.to_dict)
 
 
@@ -872,14 +883,18 @@
     def email_notification(self) -> utils.OptionEnum:
         if ShippingOption.email_notification.name in self:
             return self[ShippingOption.email_notification.name]
 
         return ShippingOption.email_notification.value(True)
 
     @property
+    def sms_notification(self) -> utils.OptionEnum:
+        return self[ShippingOption.sms_notification.name]
+
+    @property
     def email_notification_to(self) -> utils.OptionEnum:
         return self[ShippingOption.email_notification_to.name]
 
     @property
     def shipment_date(self) -> utils.OptionEnum:
         return self[ShippingOption.shipment_date.name]
 
@@ -899,14 +914,18 @@
     def doc_files(self) -> utils.OptionEnum:
         return self[ShippingOption.doc_files.name]
 
     @property
     def doc_references(self) -> utils.OptionEnum:
         return self[ShippingOption.doc_references.name]
 
+    @property
+    def shipment_note(self) -> utils.OptionEnum:
+        return self[ShippingOption.shipment_note.name]
+
 
 class CustomsOption(utils.Enum):
     """common shipment customs identifiers"""
 
     aes = utils.OptionEnum("aes")
     eel_pfc = utils.OptionEnum("eel_pfc")
     nip_number = utils.OptionEnum("eori_number")
@@ -990,14 +1009,51 @@
 
     origin_postal_code = utils.OptionEnum("origin_postal_code")
     origin_country_code = utils.OptionEnum("origin_country_code")
     destination_postal_code = utils.OptionEnum("destination_postal_code")
     destination_country_code = utils.OptionEnum("destination_country_code")
 
 
+class ConnectionConfigOption(utils.Enum):
+    """common shipment document upload options"""
+
+    label_type = utils.OptionEnum("label_type")
+    language_code = utils.OptionEnum("language_code")
+    default_currency = utils.OptionEnum("default_currency")
+    shipping_options = utils.OptionEnum("shipping_options", list)
+    shipping_services = utils.OptionEnum("shipping_services", list)
+
+
+class ConnectionConfigOptions(Options):
+    """The options common processing helper"""
+
+    def __init__(self, *args, **kwargs):
+        super().__init__(*args, **kwargs, base_option_type=ConnectionConfigOption)
+
+    @property
+    def label_type(self) -> utils.OptionEnum:
+        return self[ConnectionConfigOption.label_type.name]
+
+    @property
+    def language_code(self) -> utils.OptionEnum:
+        return self[ConnectionConfigOption.language_code.name]
+
+    @property
+    def default_currency(self) -> utils.OptionEnum:
+        return self[ConnectionConfigOption.default_currency.name]
+
+    @property
+    def shipping_options(self) -> utils.OptionEnum:
+        return self[ConnectionConfigOption.shipping_options.name]
+
+    @property
+    def shipping_services(self) -> utils.OptionEnum:
+        return self[ConnectionConfigOption.shipping_services.name]
+
+
 class Services:
     """The services common processing helper"""
 
     def __init__(
         self, services: typing.Iterable, service_type: typing.Type[utils.Enum]
     ):
         self._services = [service_type[s] for s in services if s in service_type]
```

## karrio/core/utils/helpers.py

```diff
@@ -40,25 +40,36 @@
     content = base64.b64decode(encoded_file, **kwargs)
     buffer = io.BytesIO()
     buffer.write(content)
 
     return buffer
 
 
-def image_to_pdf(image_str: str, rotate: int = None) -> str:
+def image_to_pdf(image_str: str, rotate: int = None, resize: dict = None) -> str:
     buffer = to_buffer(image_str)
     _image = Image.open(buffer)
+
     image = (
-        _image.rotate(rotate, Image.NEAREST, expand = True)
+        _image.rotate(rotate, Image.NEAREST, expand=True)
         if rotate is not None
         else _image
     )
 
+    if resize is not None:
+        img = image.copy()
+        wpercent = resize["width"] / float(img.size[0])
+        hsize = int((float(img.size[1]) * float(wpercent)))
+        image = img.resize((resize["width"], hsize), Image.Resampling.LANCZOS)
+
+    if resize is not None:
+        img = image.copy()
+        image = img.resize((resize["width"], resize["height"]), Image.ANTIALIAS)
+
     new_buffer = io.BytesIO()
-    image.save(new_buffer, format="PDF")
+    image.save(new_buffer, format="PDF", dpi=(300, 300))
 
     return base64.b64encode(new_buffer.getvalue()).decode("utf-8")
 
 
 def bundle_pdfs(base64_strings: List[str]) -> PdfMerger:
     merger = PdfMerger(strict=False)
 
@@ -112,19 +123,34 @@
     else:
         image = bundle_imgs(base64_strings)
         image.save(result, format)
 
     return base64.b64encode(result.getvalue()).decode("utf-8")
 
 
+def zpl_to_pdf(zpl_str: str, width: int, height: int, dpmm: int = 12) -> str:
+    """Return a PDF base64 string from a ZPL string."""
+    import karrio.lib as lib
+
+    data = lib.to_json(dict(file=base64.b64decode(zpl_str).decode("utf-8")))
+    doc = request(
+        url=f"http://api.labelary.com/v1/printers/{dpmm}dpmm/labels/{width}x{height}/",
+        data=data,
+        headers={"Accept": "application/pdf"},
+        decoder=lambda b: base64.encodebytes(b).decode("utf-8"),
+    )
+
+    return doc
+
+
 def decode_bytes(byte):
     return (
-        failsafe(lambda: byte.decode("utf-8")) or
-        failsafe(lambda: byte.decode("ISO-8859-1")) or
-        byte.decode("utf-8")
+        failsafe(lambda: byte.decode("utf-8"))
+        or failsafe(lambda: byte.decode("ISO-8859-1"))
+        or byte.decode("utf-8")
     )
 
 
 def process_request(
     request_id: str,
     trace: Callable[[Any, str], Any] = None,
     **kwargs,
```

## karrio/core/utils/serializable.py

```diff
@@ -1,41 +1,41 @@
 import attr
+import typing
 import logging
-from typing import Any, Callable, Generic, TypeVar
 
 from karrio.core.utils.helpers import identity
 
 logger = logging.getLogger(__name__)
 
 XML_str = str
-T = TypeVar("T")
+T = typing.TypeVar("T")
 
 
 @attr.s(auto_attribs=True)
-class Serializable(Generic[T]):
-    value: T
-    _serializer: Callable[[T], Any] = identity
+class Serializable(typing.Generic[T]):
+    value: typing.Any
+    _serializer: typing.Callable[[typing.Any], T] = identity
     _ctx: dict = {}
 
-    def serialize(self) -> Any:
+    def serialize(self) -> T:
         serialized_value = self._serializer(self.value)
         logger.debug(serialized_value)
         return serialized_value
 
     @property
     def ctx(self) -> dict:
         return self._ctx
 
 
 @attr.s(auto_attribs=True)
-class Deserializable(Generic[T]):
-    value: T
-    _deserializer: Callable[[T], Any] = identity
+class Deserializable(typing.Generic[T]):
+    value: typing.Any
+    _deserializer: typing.Callable[[typing.Any], T] = identity
     _ctx: dict = {}
 
-    def deserialize(self) -> Any:
+    def deserialize(self) -> T:
         logger.debug(self.value)
         return self._deserializer(self.value)
 
     @property
     def ctx(self) -> dict:
         return self._ctx
```

## karrio/universal/mappers/rating_proxy.py

```diff
@@ -17,15 +17,15 @@
 
     def trace(self, *args, **kwargs):
         return self.tracer.with_metadata(dict(connection=self.settings))(
             *args, **kwargs
         )
 
     def get_rates(
-        self, request: utils.Serializable[models.RateRequest]
+        self, request: utils.Serializable
     ) -> utils.Deserializable[typing.List[typing.Tuple[str, PackageRates]]]:
         _request = request.serialize()
 
         shipper = lib.to_address(_request.shipper)
         recipient = lib.to_address(_request.recipient)
         packages = lib.to_packages(_request.parcels)
         has_origin = any(
@@ -140,20 +140,18 @@
 
         # resolve matching zone
         selected_zone: typing.Optional[models.ServiceZone] = None
 
         for zone in service.zones or []:
             # Check Location inclusion
             _cover_supported_cities = (
-                zone.cities is not None
-                and recipient.city in zone.cities
+                zone.cities is not None and recipient.city in zone.cities
             ) or not any(zone.cities or [])
             _cover_supported_countries = (
-                zone.cities is not None
-                and recipient.country_code in zone.country_codes
+                zone.cities is not None and recipient.country_code in zone.country_codes
             ) or not any(zone.country_codes or [])
 
             # Check if weight and dimensions fit restrictions
             _match_zone_min_weight_requirements = (
                 zone.min_weight is not None
                 and package.weight[service.weight_unit]
                 >= units.Weight(zone.min_weight, service.weight_unit).value
```

## karrio/universal/mappers/shipping_proxy.py

```diff
@@ -10,15 +10,15 @@
 
 
 @attr.s(auto_attribs=True)
 class ShippingMixinProxy:
     settings: ShippingMixinSettings
 
     def create_shipment(
-        self, request: lib.Serializable[ShipmentRequest]
+        self, request: lib.Serializable
     ) -> lib.Deserializable[
         typing.Tuple[typing.List[typing.Tuple[str, ServiceLabel]], typing.List[Message]]
     ]:
         response = generate_service_label(request.serialize(), self.settings)
 
         return lib.Deserializable(response)
```

## karrio/universal/providers/rating/rate.py

```diff
@@ -1,26 +1,27 @@
 import typing
 import karrio.lib as lib
 import karrio.core.models as models
 import karrio.universal.providers.rating.utils as utils
 
+ResponseType = typing.List[typing.Tuple[str, utils.PackageRates]]
+
 
 def parse_rate_response(
-    responses: typing.List[typing.Tuple[str, utils.PackageRates]], _
+    _response: lib.Deserializable[ResponseType], _
 ) -> typing.Tuple[typing.List[models.RateDetails], typing.List[models.Message]]:
+    responses = _response.deserialize()
     package_rates: typing.List[typing.Tuple[str, typing.List[models.RateDetails]]] = []
     messages: typing.List[models.Message] = []
 
-    for _ref, _response in responses:
-        _rates, _messages = _response
+    for _ref, _res in responses:
+        _rates, _messages = _res
         messages += _messages
         package_rates += [(_ref, _rates)]
 
     rates = lib.to_multi_piece_rates(package_rates)
 
     return rates, messages
 
 
-def rate_request(
-    payload: models.RateRequest, _
-) -> lib.Serializable[models.RateRequest]:
+def rate_request(payload: models.RateRequest, _) -> lib.Serializable:
     return lib.Serializable(payload)
```

## karrio/universal/providers/shipping/shipment.py

```diff
@@ -5,21 +5,22 @@
     ShipmentRequest,
     ShipmentDetails,
     Message,
 )
 from karrio.universal.providers.shipping.utils import ShippingMixinSettings
 from karrio.core.models import ServiceLabel
 from karrio.core.utils.transformer import to_multi_piece_shipment
+import karrio.lib as lib
 
 
 def parse_shipment_response(
-    response: Tuple[List[Tuple[str, ServiceLabel]], List[Message]],
+    _response: lib.Deserializable[Tuple[List[Tuple[str, ServiceLabel]], List[Message]]],
     settings: ShippingMixinSettings,
 ) -> Tuple[ShipmentDetails, List[Message]]:
-    service_labels, errors = response
+    service_labels, errors = _response.deserialize()
     shipment = to_multi_piece_shipment(
         [
             (package_ref, _extract_details(service_label, settings))
             for package_ref, service_label in service_labels
         ]
     )
 
@@ -36,9 +37,9 @@
         tracking_number=service_label.tracking_number,
         shipment_identifier=service_label.tracking_number,
         meta=dict(service_name=service_label.service_name),
         docs=Documents(label=service_label.label),
     )
 
 
-def shipment_request(payload: ShipmentRequest, _) -> Serializable[ShipmentRequest]:
+def shipment_request(payload: ShipmentRequest, _) -> Serializable:
     return Serializable(payload)
```

## Comparing `karrio-2023.3.4.dist-info/METADATA` & `karrio-2023.4.dist-info/METADATA`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: karrio
-Version: 2023.3.4
+Version: 2023.4
 Summary: Multi-carrier shipping API integration with python
 Home-page: https://github.com/karrioapi/karrio
 Author: karrio
 Author-email: hello@karrio.io
 License: Apache-2.0
 Platform: UNKNOWN
 Classifier: Intended Audience :: Developers
```

### html2text {}

```diff
@@ -1,8 +1,8 @@
-Metadata-Version: 2.1 Name: karrio Version: 2023.3.4 Summary: Multi-carrier
+Metadata-Version: 2.1 Name: karrio Version: 2023.4 Summary: Multi-carrier
 shipping API integration with python Home-page: https://github.com/karrioapi/
 karrio Author: karrio Author-email: hello@karrio.io License: Apache-2.0
 Platform: UNKNOWN Classifier: Intended Audience :: Developers Classifier:
 Operating System :: OS Independent Classifier: Programming Language :: Python
 :: 3 Description-Content-Type: text/markdown Requires-Dist: Pillow Requires-
 Dist: PyPDF2 Requires-Dist: jstruct Requires-Dist: lxml Requires-Dist: lxml-
 stubs Requires-Dist: phonenumbers Requires-Dist: py-soap Requires-Dist: python-
```

## Comparing `karrio-2023.3.4.dist-info/RECORD` & `karrio-2023.4.dist-info/RECORD`

 * *Files 6% similar despite different names*

```diff
@@ -1,51 +1,51 @@
 karrio/__init__.py,sha256=MGaZGiMfGOpYY5gTQaOT-FgpyAmRoBio8dfXl1IcRWA,3149
-karrio/lib.py,sha256=yx-UwnCef4jhhSkYVZVjgTmY0LUnWNLlR9Kl50r9V-o,17459
-karrio/references.py,sha256=0z-b2U2Z8ghhvC-hH6XpMhiVKrGcizyq5FTD4G1XsRg,4673
+karrio/lib.py,sha256=jeFbDvSONXTG5cd6Sw-7FyskKzWfrDcYKlIt1L9rFq8,18075
+karrio/references.py,sha256=Re-PHb3QyhFkqCGTuKyQjIFxpa30b9vaRqA5TVjwr1E,4969
 karrio/addons/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 karrio/addons/label.py,sha256=WwC1o97Ztyj3kRNTlAkHmYh4It7dC7l8bsC3fc-5yMA,10316
 karrio/addons/renderer.py,sha256=tLO1ZWrYExBOyLVv29v-1FWtASrevZlG2OCgQFf8lqk,7016
 karrio/addons/fonts/Oswald-Regular.ttf,sha256=JkY5cy9a34D6weSp7z8OtY5Yta6tB4UAh2Yt7euhGxI,91400
 karrio/addons/fonts/Oswald-SemiBold.ttf,sha256=s4enQAb3fl-rF7yrZAHO8P99AVqUjiJ3DS873v-lidA,91700
 karrio/api/__init__.py,sha256=fJbOJLRIdrVlUi2BM-JtagKdm05ADc9naRMtx6rZ0V4,127
 karrio/api/gateway.py,sha256=9E30taInhrN7-VGeZz3NKcbKEwhy7h9grB_nZ8dlkQM,4955
-karrio/api/interface.py,sha256=hsk4ekSEOq-jyqukVPkPPcV_Sw6ZewbaugEWZ2ETS0k,14594
+karrio/api/interface.py,sha256=9vt5IZO0bZBYpeyFrxHe1XVLbR75gygdPowAY6DoJnE,16054
 karrio/api/mapper.py,sha256=OjLH2b6_NRcVNnJDb3hZypY6FfHuTHiMlAJgYnWpkzM,13472
 karrio/api/proxy.py,sha256=Mx5tpcL0L_02lIZ84AvnEfroVu5Qi22iz7AVueX4YjI,6320
 karrio/core/__init__.py,sha256=BboTt3huAYrsqcTcaq1lFX5O4uKiIi2cpWEXp68ItMo,71
 karrio/core/errors.py,sha256=iMwiwCwK0eiYzk5KJ9Qu86JMWpymw1zDCvmqY67ghSw,3006
-karrio/core/metadata.py,sha256=kJUov6vdVZVrNaRF-J0RP4Papb8hZifAVY97TxcYQO0,1029
-karrio/core/models.py,sha256=M7o--xOHsDWlkQgcnBuGQeIiFfUxlJH_PTWEb7PKMS4,11098
-karrio/core/settings.py,sha256=mjL6vtKZnjK7ITcmkxvmOZHshHc7LDuhseF5wAojt_4,518
-karrio/core/units.py,sha256=TNkub7bMrsrIy1dVn-FrH1bYkNGqtcifaVKsactesw8,55580
+karrio/core/metadata.py,sha256=vs4doqUjxDSRbDulbdBeTAyFUIZ8MdjsRP74YjtdNEY,1081
+karrio/core/models.py,sha256=FaUyZ3SmkANPC4CfXKw6T8O4YAnXpvLmSM9GaxF9YaE,11152
+karrio/core/settings.py,sha256=1d-w-U5nODMxsbmR0B4CdgggvYCzsgtSipP7GUWmFkI,753
+karrio/core/units.py,sha256=upyiW7PG2QyNxdiMtjJfH632IrHTh5qc4XNNLHQJCA0,57529
 karrio/core/utils/__init__.py,sha256=NPxAugvQ4lhWOngITOagexXrsTQqlJQ0gyaXc9iBivg,739
 karrio/core/utils/caching.py,sha256=zx0R1XAWPuA0q2hz5xUw0-OLZhHd7haS41uO_Prg8Ng,1734
 karrio/core/utils/datetime.py,sha256=aFMqLB_AdRGM0By2TO8mYce-UlqExf_J2s2eLNtDClY,2311
 karrio/core/utils/dict.py,sha256=fUsyMwRduh3qJ6D6Vf4LUVcljEqDHJVn8Av9x4rUadg,2312
 karrio/core/utils/enum.py,sha256=qCrqP49wXyypfQ7rw4kFGjJ6rawptOxq_RPwqaz09dk,4420
-karrio/core/utils/helpers.py,sha256=wqrMYUX2_JpQbXBd0eLnmE1R3I0qKDbGJ2EoR0Wv4wc,7593
+karrio/core/utils/helpers.py,sha256=I3oMOPl4oeOyR8qQLlt1jVL59-uxnE8dBoWlfuqP658,8518
 karrio/core/utils/log.py,sha256=G0JqUqNiS7JwkFMurtHtbxa42miAs28dPfNZZdlZid4,434
 karrio/core/utils/number.py,sha256=z455Zbx5V92Ofo8PEaC_UEfmVEwnb-nq7fIoSeApz4o,1176
 karrio/core/utils/pipeline.py,sha256=6wXdsUGW7ZVqhpsEzreBnS6dHSCU5XgClOaBgKfJyh8,1253
-karrio/core/utils/serializable.py,sha256=0dAy0wWnzur4HE0WS9vB9BWB4GNE3WndeR4Q8K5NPtw,890
+karrio/core/utils/serializable.py,sha256=iaeiVeiCqnpIhX0danUPfsixVWcYkhb3NkYlfQaFuJA,916
 karrio/core/utils/soap.py,sha256=g8AzymGypJris0liiK-zwsjeoCPlIJ8r25WSBlSHqqs,5274
 karrio/core/utils/string.py,sha256=l2CL4rn7Tls26oH_IgAsiQh80grG39Tj4NKY4CtcCsU,762
 karrio/core/utils/tracing.py,sha256=84dmmpEPs_iBC3JaFv4f9vbC0VgR6KW4HZEYIrdt084,1462
 karrio/core/utils/transformer.py,sha256=lJuErv4jvWU93DYQZi6Dla585SaIphZU1-BhqUWe-O4,4887
 karrio/core/utils/xml.py,sha256=eMPbMVHvCMEDgUMuicB2-EQnzsxWTkNJ7RW7o9MKIc0,5493
 karrio/mappers/__init__.py,sha256=i5qDwqYoTmFscV1rwxIOo19JiRzyfTWJd9Jx0qEvUmo,129
 karrio/providers/__init__.py,sha256=02HsiVGylnZLoB_OE-7kJTvF500-CpOe-WWkOkqRUno,131
 karrio/universal/__init__.py,sha256=bpT73UG7mZL_JjEqMwbYx6q69jA8J5Jcoul1LcDokhA,81
 karrio/universal/mappers/__init__.py,sha256=bpT73UG7mZL_JjEqMwbYx6q69jA8J5Jcoul1LcDokhA,81
-karrio/universal/mappers/rating_proxy.py,sha256=j3NQ4HZWfhX1FEZokSEEcoHbo66ixrZqklmhQGzMb0c,10686
-karrio/universal/mappers/shipping_proxy.py,sha256=DaUJD_6djKezfm9wz4zg3ZF24zCFMM7J8z9onXDiUc0,1952
+karrio/universal/mappers/rating_proxy.py,sha256=la0cAsbhuXzSFYdzi8tJalC4kT79FvZu_N99VMGTktU,10634
+karrio/universal/mappers/shipping_proxy.py,sha256=-hEXZ0R3-Ps6MSRAGpE_IlWsa0gKr6xJjIz4NuoeXQ8,1935
 karrio/universal/providers/__init__.py,sha256=bpT73UG7mZL_JjEqMwbYx6q69jA8J5Jcoul1LcDokhA,81
 karrio/universal/providers/rating/__init__.py,sha256=3f8u1FS7OF9OZUGauBSt4B1ad0dmqIsmFaG3pWu7Sck,139
-karrio/universal/providers/rating/rate.py,sha256=sXH3uIs_1H1herLKMMKARGINUXCoBvYF41ZeV6FxWlI,808
+karrio/universal/providers/rating/rate.py,sha256=5M79YhIX-XMnm44kezFEoY5vE9d-WWjGAaBnE7MOmJI,861
 karrio/universal/providers/rating/utils.py,sha256=WVyJWdxCdKM1YlhTHVFxEMyac0FKIGHEkYXWEgJUzYA,558
 karrio/universal/providers/shipping/__init__.py,sha256=JRcfJWSeDSjO2g2fRnLgBurBXn01nVpdi21ShxLpG34,188
-karrio/universal/providers/shipping/shipment.py,sha256=FwpIAaRMLhwINNRGSRTCcSB0xmPS2yGGbGHNAf4O8Cg,1468
+karrio/universal/providers/shipping/shipment.py,sha256=t7PO4uSzD1ZL3q3UZWHAPD3UUZUKXReQvED8mVKUe1A,1512
 karrio/universal/providers/shipping/utils.py,sha256=1LuO31RMhpUls6-h5xhWkfky4G7tdWmGKmRhLkj-e98,593
-karrio-2023.3.4.dist-info/METADATA,sha256=K-ximGrFsQtHCJ6kvK9hWefXw4uluhHLB2KDXvF6jsE,4705
-karrio-2023.3.4.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
-karrio-2023.3.4.dist-info/top_level.txt,sha256=mfkVZXzNuVRmA7NRlck_Ub-C8Zgtqxbx3gX1Rq_W-i0,7
-karrio-2023.3.4.dist-info/RECORD,,
+karrio-2023.4.dist-info/METADATA,sha256=dhVsyoub0aSABLGIyUP5-4BrtsGzMnBW11zS-YsHUA0,4703
+karrio-2023.4.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
+karrio-2023.4.dist-info/top_level.txt,sha256=mfkVZXzNuVRmA7NRlck_Ub-C8Zgtqxbx3gX1Rq_W-i0,7
+karrio-2023.4.dist-info/RECORD,,
```

