# Comparing `tmp/karrio.canadapost-2023.3-py3-none-any.whl.zip` & `tmp/karrio.canadapost-2023.4-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,25 +1,25 @@
-Zip file size: 22797 bytes, number of entries: 23
--rw-rw-r--  2.0 unx      525 b- defN 22-Nov-15 19:21 karrio/mappers/canadapost/__init__.py
--rw-rw-r--  2.0 unx     3534 b- defN 22-Nov-15 19:21 karrio/mappers/canadapost/mapper.py
--rw-rw-r--  2.0 unx    10416 b- defN 22-Nov-15 19:21 karrio/mappers/canadapost/proxy.py
--rw-rw-r--  2.0 unx      488 b- defN 22-Nov-15 19:21 karrio/mappers/canadapost/settings.py
+Zip file size: 23140 bytes, number of entries: 23
+-rw-rw-r--  2.0 unx      572 b- defN 23-Apr-15 11:05 karrio/mappers/canadapost/__init__.py
+-rw-rw-r--  2.0 unx     3357 b- defN 23-Apr-01 13:34 karrio/mappers/canadapost/mapper.py
+-rw-rw-r--  2.0 unx    10326 b- defN 23-Apr-01 13:38 karrio/mappers/canadapost/proxy.py
+-rw-rw-r--  2.0 unx      510 b- defN 23-Apr-15 06:44 karrio/mappers/canadapost/settings.py
 -rw-rw-r--  2.0 unx      688 b- defN 22-Nov-15 19:21 karrio/providers/canadapost/__init__.py
 -rw-rw-r--  2.0 unx     1304 b- defN 23-Feb-18 18:30 karrio/providers/canadapost/error.py
--rw-rw-r--  2.0 unx     6206 b- defN 22-Nov-18 03:17 karrio/providers/canadapost/rate.py
--rw-rw-r--  2.0 unx     2733 b- defN 23-Mar-25 11:42 karrio/providers/canadapost/tracking.py
--rw-rw-r--  2.0 unx     7856 b- defN 23-Mar-25 13:55 karrio/providers/canadapost/units.py
--rw-rw-r--  2.0 unx     1130 b- defN 23-Mar-25 12:44 karrio/providers/canadapost/utils.py
+-rw-rw-r--  2.0 unx     6253 b- defN 23-Apr-01 15:18 karrio/providers/canadapost/rate.py
+-rw-rw-r--  2.0 unx     2769 b- defN 23-Apr-01 15:18 karrio/providers/canadapost/tracking.py
+-rw-rw-r--  2.0 unx     8116 b- defN 23-Apr-15 10:53 karrio/providers/canadapost/units.py
+-rw-rw-r--  2.0 unx     1447 b- defN 23-Apr-15 11:08 karrio/providers/canadapost/utils.py
 -rw-rw-r--  2.0 unx      304 b- defN 22-Nov-15 19:21 karrio/providers/canadapost/pickup/__init__.py
--rw-rw-r--  2.0 unx      921 b- defN 22-Nov-15 19:21 karrio/providers/canadapost/pickup/cancel.py
--rw-rw-r--  2.0 unx     7282 b- defN 23-Mar-25 14:18 karrio/providers/canadapost/pickup/create.py
--rw-rw-r--  2.0 unx     1503 b- defN 22-Nov-15 19:21 karrio/providers/canadapost/pickup/update.py
+-rw-rw-r--  2.0 unx     1001 b- defN 23-Apr-01 15:18 karrio/providers/canadapost/pickup/cancel.py
+-rw-rw-r--  2.0 unx     7056 b- defN 23-Apr-01 15:53 karrio/providers/canadapost/pickup/create.py
+-rw-rw-r--  2.0 unx     1675 b- defN 23-Apr-01 15:18 karrio/providers/canadapost/pickup/update.py
 -rw-rw-r--  2.0 unx      236 b- defN 22-Nov-15 19:21 karrio/providers/canadapost/shipment/__init__.py
--rw-rw-r--  2.0 unx     2220 b- defN 22-Nov-15 19:21 karrio/providers/canadapost/shipment/cancel.py
--rw-rw-r--  2.0 unx    10608 b- defN 23-Mar-25 15:38 karrio/providers/canadapost/shipment/contract.py
--rw-rw-r--  2.0 unx     2003 b- defN 22-Nov-15 19:21 karrio/providers/canadapost/shipment/create.py
--rw-rw-r--  2.0 unx     8114 b- defN 23-Mar-25 14:21 karrio/providers/canadapost/shipment/non_contract.py
--rw-rw-r--  2.0 unx     1014 b- defN 23-Mar-27 07:12 karrio.canadapost-2023.3.dist-info/METADATA
--rw-rw-r--  2.0 unx       92 b- defN 23-Mar-27 07:12 karrio.canadapost-2023.3.dist-info/WHEEL
--rw-rw-r--  2.0 unx        7 b- defN 23-Mar-27 07:12 karrio.canadapost-2023.3.dist-info/top_level.txt
--rw-rw-r--  2.0 unx     2202 b- defN 23-Mar-27 07:12 karrio.canadapost-2023.3.dist-info/RECORD
-23 files, 71386 bytes uncompressed, 19119 bytes compressed:  73.2%
+-rw-rw-r--  2.0 unx     2467 b- defN 23-Apr-01 15:18 karrio/providers/canadapost/shipment/cancel.py
+-rw-rw-r--  2.0 unx    10735 b- defN 23-Apr-15 10:53 karrio/providers/canadapost/shipment/contract.py
+-rw-rw-r--  2.0 unx     2135 b- defN 23-Apr-01 15:18 karrio/providers/canadapost/shipment/create.py
+-rw-rw-r--  2.0 unx     8228 b- defN 23-Apr-01 15:57 karrio/providers/canadapost/shipment/non_contract.py
+-rw-rw-r--  2.0 unx     1014 b- defN 23-Apr-18 07:09 karrio.canadapost-2023.4.dist-info/METADATA
+-rw-rw-r--  2.0 unx       92 b- defN 23-Apr-18 07:09 karrio.canadapost-2023.4.dist-info/WHEEL
+-rw-rw-r--  2.0 unx        7 b- defN 23-Apr-18 07:09 karrio.canadapost-2023.4.dist-info/top_level.txt
+-rw-rw-r--  2.0 unx     2203 b- defN 23-Apr-18 07:09 karrio.canadapost-2023.4.dist-info/RECORD
+23 files, 72495 bytes uncompressed, 19462 bytes compressed:  73.2%
```

## zipnote {}

```diff
@@ -51,20 +51,20 @@
 
 Filename: karrio/providers/canadapost/shipment/create.py
 Comment: 
 
 Filename: karrio/providers/canadapost/shipment/non_contract.py
 Comment: 
 
-Filename: karrio.canadapost-2023.3.dist-info/METADATA
+Filename: karrio.canadapost-2023.4.dist-info/METADATA
 Comment: 
 
-Filename: karrio.canadapost-2023.3.dist-info/WHEEL
+Filename: karrio.canadapost-2023.4.dist-info/WHEEL
 Comment: 
 
-Filename: karrio.canadapost-2023.3.dist-info/top_level.txt
+Filename: karrio.canadapost-2023.4.dist-info/top_level.txt
 Comment: 
 
-Filename: karrio.canadapost-2023.3.dist-info/RECORD
+Filename: karrio.canadapost-2023.4.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## karrio/mappers/canadapost/__init__.py

```diff
@@ -13,8 +13,9 @@
     Mapper=Mapper,
     Proxy=Proxy,
     Settings=Settings,
     # Data Units
     options=units.ShippingOption,
     package_presets=units.PackagePresets,
     services=units.ServiceType,
+    connection_configs=units.ConnectionConfig,
 )
```

## karrio/mappers/canadapost/mapper.py

```diff
@@ -5,15 +5,14 @@
     ShipmentCancelRequest,
     PickupUpdateRequest,
     PickupCancelRequest,
     ShipmentRequest,
     TrackingRequest,
     PickupRequest,
     RateRequest,
-
     ConfirmationDetails,
     TrackingDetails,
     ShipmentDetails,
     PickupDetails,
     RateDetails,
     Message,
 )
@@ -21,89 +20,82 @@
     parse_shipment_cancel_response,
     parse_pickup_update_response,
     parse_pickup_cancel_response,
     parse_shipment_response,
     parse_tracking_response,
     parse_pickup_response,
     parse_rate_response,
-
     shipment_cancel_request,
     pickup_update_request,
     pickup_cancel_request,
     tracking_request,
     shipment_request,
     pickup_request,
     rate_request,
 )
 from karrio.mappers.canadapost.settings import Settings
 
 
 class Mapper(BaseMapper):
     settings: Settings
 
-    def create_rate_request(
-        self, payload: RateRequest
-    ) -> Serializable:
+    def create_rate_request(self, payload: RateRequest) -> Serializable:
         return rate_request(payload, self.settings)
 
-    def create_tracking_request(
-        self, payload: TrackingRequest
-    ) -> Serializable:
+    def create_tracking_request(self, payload: TrackingRequest) -> Serializable:
         return tracking_request(payload, self.settings)
 
-    def create_shipment_request(
-        self, payload: ShipmentRequest
-    ) -> Serializable:
+    def create_shipment_request(self, payload: ShipmentRequest) -> Serializable:
         return shipment_request(payload, self.settings)
 
-    def create_pickup_request(
-        self, payload: PickupRequest
-    ) -> Serializable:
+    def create_pickup_request(self, payload: PickupRequest) -> Serializable:
         return pickup_request(payload, self.settings)
 
     def create_pickup_update_request(
         self, payload: PickupUpdateRequest
     ) -> Serializable:
         return pickup_update_request(payload, self.settings)
 
     def create_cancel_pickup_request(
         self, payload: PickupCancelRequest
     ) -> Serializable:
         return pickup_cancel_request(payload, self.settings)
 
-    def create_cancel_shipment_request(self, payload: ShipmentCancelRequest) -> Serializable[str]:
+    def create_cancel_shipment_request(
+        self, payload: ShipmentCancelRequest
+    ) -> Serializable:
         return shipment_cancel_request(payload, self.settings)
 
     def parse_cancel_pickup_response(
-        self, response: Deserializable[str]
+        self, response: Deserializable
     ) -> Tuple[ConfirmationDetails, List[Message]]:
-        return parse_pickup_cancel_response(response.deserialize(), self.settings)
+        return parse_pickup_cancel_response(response, self.settings)
 
     def parse_cancel_shipment_response(
         self, response: Deserializable
     ) -> Tuple[ConfirmationDetails, List[Message]]:
-        return parse_shipment_cancel_response(response.deserialize(), self.settings)
+        return parse_shipment_cancel_response(response, self.settings)
 
     def parse_pickup_response(
-        self, response: Deserializable[str]
+        self, response: Deserializable
     ) -> Tuple[PickupDetails, List[Message]]:
-        return parse_pickup_response(response.deserialize(), self.settings)
+        return parse_pickup_response(response, self.settings)
 
     def parse_pickup_update_response(
-        self, response: Deserializable[str]
+        self, response: Deserializable
     ) -> Tuple[PickupDetails, List[Message]]:
-        return parse_pickup_update_response(response.deserialize(), self.settings)
+        return parse_pickup_update_response(response, self.settings)
 
     def parse_rate_response(
-        self, response: Deserializable[str]
+        self, response: Deserializable
     ) -> Tuple[List[RateDetails], List[Message]]:
-        return parse_rate_response(response.deserialize(), self.settings)
+        return parse_rate_response(response, self.settings)
 
     def parse_shipment_response(
-        self, response: Deserializable[str]
+        self, response: Deserializable
     ) -> Tuple[ShipmentDetails, List[Message]]:
-        return parse_shipment_response(response.deserialize(), self.settings)
+        return parse_shipment_response(response, self.settings)
 
     def parse_tracking_response(
-        self, response: Deserializable[str]
+        self, response: Deserializable
     ) -> Tuple[List[TrackingDetails], List[Message]]:
-        return parse_tracking_response(response.deserialize(), self.settings)
+        return parse_tracking_response(response, self.settings)
```

## karrio/mappers/canadapost/proxy.py

```diff
@@ -15,15 +15,15 @@
 )
 from karrio.mappers.canadapost.settings import Settings
 
 
 class Proxy(BaseProxy):
     settings: Settings
 
-    def get_rates(self, request: Serializable[mailing_scenario]) -> Deserializable[str]:
+    def get_rates(self, request: Serializable) -> Deserializable:
         response = http(
             url=f"{self.settings.server_url}/rs/ship/price",
             data=request.serialize(),
             trace=self.trace_as("xml"),
             method="POST",
             headers={
                 "Content-Type": "application/vnd.cpc.ship.rate-v4+xml",
@@ -31,15 +31,15 @@
                 "Authorization": f"Basic {self.settings.authorization}",
                 "Accept-language": f"{self.settings.language}-CA",
             },
         )
 
         return Deserializable(response, XP.to_xml)
 
-    def get_tracking(self, request: Serializable[List[str]]) -> Deserializable[str]:
+    def get_tracking(self, request: Serializable) -> Deserializable:
         """
         get_tracking make parallel request for each pin
         """
         _throttle = 0.0
 
         def track(tracking_pin: str) -> str:
             nonlocal _throttle
@@ -57,15 +57,15 @@
                 },
             )
 
         response: List[str] = exec_async(track, request.serialize())
 
         return Deserializable(XP.bundle_xml(xml_strings=response), XP.to_xml)
 
-    def create_shipment(self, request: Serializable[Pipeline]) -> Deserializable[str]:
+    def create_shipment(self, request: Serializable) -> Deserializable:
         def _contract_shipment(job: Job):
             return http(
                 url=f"{self.settings.server_url}/rs/{self.settings.customer_number}/{self.settings.customer_number}/shipment",
                 data=job.data.serialize(),
                 trace=self.trace_as("xml"),
                 method="POST",
                 headers={
@@ -157,15 +157,15 @@
 
             return subprocess[job.id](job)
 
         pipeline: Pipeline = request.serialize()
         response = pipeline.apply(process)
         return Deserializable(XP.bundle_xml(response), XP.to_xml)
 
-    def schedule_pickup(self, request: Serializable[Pipeline]) -> Deserializable[str]:
+    def schedule_pickup(self, request: Serializable) -> Deserializable:
         def _availability(job: Job) -> str:
             return http(
                 url=f"{self.settings.server_url}/ad/pickup/pickupavailability/{job.data}",
                 trace=self.trace_as("xml"),
                 method="GET",
                 headers={
                     "Accept": "application/vnd.cpc.pickup+xml",
@@ -202,15 +202,15 @@
             return subprocess[job.id](job)
 
         pipeline: Pipeline = request.serialize()
         response = pipeline.apply(process)
 
         return Deserializable(XP.bundle_xml(response), XP.to_xml)
 
-    def modify_pickup(self, request: Serializable[dict]) -> Deserializable[str]:
+    def modify_pickup(self, request: Serializable) -> Deserializable:
         def _get_pickup(job: Job) -> str:
             return http(
                 url=f"{self.settings.server_url}{job.data.serialize()}",
                 trace=self.trace_as("xml"),
                 method="GET",
                 headers={
                     "Accept": "application/vnd.cpc.pickup+xml",
@@ -247,15 +247,15 @@
             return subprocess[job.id](job)
 
         pipeline: Pipeline = request.serialize()
         response = pipeline.apply(process)
 
         return Deserializable(XP.bundle_xml(response), XP.to_xml)
 
-    def cancel_pickup(self, request: Serializable[str]) -> Deserializable[str]:
+    def cancel_pickup(self, request: Serializable) -> Deserializable:
         pickuprequest = request.serialize()
         response = http(
             url=f"{self.settings.server_url}/enab/{self.settings.customer_number}/pickuprequest/{pickuprequest}",
             trace=self.trace_as("xml"),
             method="DELETE",
             headers={
                 "Accept": "application/vnd.cpc.pickuprequest+xml",
```

## karrio/mappers/canadapost/settings.py

```diff
@@ -15,7 +15,8 @@
     language: str = "en"
 
     id: str = None
     test_mode: bool = False
     carrier_id: str = "canadapost"
     account_country_code: str = "CA"
     metadata: dict = {}
+    config: dict = {}
```

## karrio/providers/canadapost/rate.py

```diff
@@ -18,16 +18,18 @@
 import karrio.core.models as models
 import karrio.providers.canadapost.error as provider_error
 import karrio.providers.canadapost.units as provider_units
 import karrio.providers.canadapost.utils as provider_utils
 
 
 def parse_rate_response(
-    response: lib.Element, settings: provider_utils.Settings
+    _response: lib.Deserializable[lib.Element],
+    settings: provider_utils.Settings,
 ) -> typing.Tuple[typing.List[models.RateDetails], typing.List[models.Message]]:
+    response = _response.deserialize()
     price_quotes = lib.find_element("price-quote", response)
     quotes: typing.List[models.RateDetails] = [
         _extract_quote(price_quote_node, settings) for price_quote_node in price_quotes
     ]
     return quotes, provider_error.parse_error_response(response, settings)
 
 
@@ -65,15 +67,15 @@
         meta=dict(service_name=(service.name or quote.service_name)),
     )
 
 
 def rate_request(
     payload: models.RateRequest,
     settings: provider_utils.Settings,
-) -> lib.Serializable[mailing_scenario]:
+) -> lib.Serializable:
     """Create the appropriate Canada Post rate request depending on the destination
 
     :param settings: Karrio carrier connection settings
     :param payload: Karrio unified API rate request data
     :return: a domestic or international Canada post compatible request
     :raises: an OriginNotServicedError when origin country is not serviced by the carrier
     """
```

## karrio/providers/canadapost/tracking.py

```diff
@@ -4,17 +4,18 @@
 import karrio.core.models as models
 import karrio.providers.canadapost.error as error
 import karrio.providers.canadapost.units as provider_units
 import karrio.providers.canadapost.utils as provider_utils
 
 
 def parse_tracking_response(
-    response: lib.Element,
+    _response: lib.Deserializable[lib.Element],
     settings: provider_utils.Settings,
 ) -> typing.Tuple[typing.List[models.TrackingDetails], typing.List[models.Message]]:
+    response = _response.deserialize()
     details = lib.find_element("tracking-detail", response)
     tracking_details: typing.List[models.TrackingDetails] = [
         _extract_tracking(node, settings)
         for node in details
         if len(lib.find_element("occurrence", node)) > 0
     ]
 
@@ -66,11 +67,9 @@
             shipment_delivery_date=estimated_delivery,
             shipment_service=details.service_name,
             signed_by=last_event.signatory_name,
         ),
     )
 
 
-def tracking_request(
-    payload: models.TrackingRequest, _
-) -> lib.Serializable[typing.List[str]]:
+def tracking_request(payload: models.TrackingRequest, _) -> lib.Serializable:
     return lib.Serializable(payload.tracking_numbers)
```

## karrio/providers/canadapost/units.py

```diff
@@ -75,14 +75,21 @@
 
     sender = account
     recipient = account
     third_party = supplier_account
     credit_card = card
 
 
+class ConnectionConfig(lib.Enum):
+    label_type = lib.OptionEnum("label_type")
+    cost_center = lib.OptionEnum("cost_center")
+    shipping_options = lib.OptionEnum("shipping_options", list)
+    shipping_services = lib.OptionEnum("shipping_services", list)
+
+
 class ServiceType(lib.Enum):
     canadapost_regular_parcel = "DOM.RP"
     canadapost_expedited_parcel = "DOM.EP"
     canadapost_xpresspost = "DOM.XP"
     canadapost_xpresspost_certified = "DOM.XP.CERT"
     canadapost_priority = "DOM.PC"
     canadapost_library_books = "DOM.LIB"
```

## karrio/providers/canadapost/utils.py

```diff
@@ -1,14 +1,15 @@
 """Karrio Canada post client settings."""
 
-from base64 import b64encode
-from karrio.core.settings import Settings as BaseSettings
+import base64
+import karrio.lib as lib
+import karrio.core.settings as settings
 
 
-class Settings(BaseSettings):
+class Settings(settings.Settings):
     """Canada post connection settings."""
 
     username: str
     password: str
     customer_number: str
     contract_id: str = None
     language: str = "en"
@@ -27,18 +28,31 @@
             "https://ct.soa-gw.canadapost.ca"
             if self.test_mode
             else "https://soa-gw.canadapost.ca"
         )
 
     @property
     def tracking_url(self):
-        return "https://www.canadapost-postescanada.ca/track-reperage/" + self.language + "#/resultList?searchFor={}"
+        return (
+            "https://www.canadapost-postescanada.ca/track-reperage/"
+            + self.language
+            + "#/resultList?searchFor={}"
+        )
 
     @property
     def authorization(self):
         pair = "%s:%s" % (self.username, self.password)
-        return b64encode(pair.encode("utf-8")).decode("ascii")
+        return base64.b64encode(pair.encode("utf-8")).decode("ascii")
+
+    @property
+    def connection_config(self) -> lib.units.Options:
+        from karrio.providers.canadapost.units import ConnectionConfig
+
+        return lib.to_connection_config(
+            self.config or {},
+            option_type=ConnectionConfig,
+        )
 
 
 def format_ca_postal_code(code: str = None) -> str:
     """Format canadian postal code."""
     return (code or "").replace(" ", "").upper()
```

## karrio/providers/canadapost/pickup/cancel.py

```diff
@@ -3,19 +3,21 @@
     PickupCancelRequest,
     Message,
     ConfirmationDetails,
 )
 from karrio.core.utils import Serializable, Element
 from karrio.providers.canadapost.error import parse_error_response
 from karrio.providers.canadapost.utils import Settings
+import karrio.lib as lib
 
 
 def parse_pickup_cancel_response(
-    response: Element, settings: Settings
+    _response: lib.Deserializable[Element], settings: Settings
 ) -> Tuple[ConfirmationDetails, List[Message]]:
+    response = _response.deserialize()
     errors = parse_error_response(response, settings)
     cancellation = (
         ConfirmationDetails(
             carrier_id=settings.carrier_id,
             carrier_name=settings.carrier_name,
             success=True,
             operation="Cancel Pickup",
@@ -23,9 +25,9 @@
         if len(errors) == 0
         else None
     )
 
     return cancellation, errors
 
 
-def pickup_cancel_request(payload: PickupCancelRequest, _) -> Serializable[str]:
+def pickup_cancel_request(payload: PickupCancelRequest, _) -> Serializable:
     return Serializable(payload.confirmation_number)
```

## karrio/providers/canadapost/pickup/create.py

```diff
@@ -17,15 +17,14 @@
 )
 import karrio.lib as lib
 from karrio.core.utils import (
     Serializable,
     Element,
     Job,
     Pipeline,
-    SF,
     DF,
     NF,
     XP,
 )
 from karrio.core.models import (
     PickupRequest,
     PickupDetails,
@@ -38,46 +37,34 @@
 from karrio.providers.canadapost.utils import Settings
 from karrio.providers.canadapost.error import parse_error_response
 
 PickupRequestDetails = Union[PickupRequestDetailsType, PickupRequestUpdateDetailsType]
 
 
 def parse_pickup_response(
-    response: Element, settings: Settings
+    _response: lib.Deserializable[Element], settings: Settings
 ) -> Tuple[PickupDetails, List[Message]]:
+    response = (
+        _response.deserialize() if hasattr(_response, "deserialize") else _response
+    )
     pickup = (
         _extract_pickup_details(response, settings)
-        if len(
-            response.xpath(".//*[local-name() = $name]", name="pickup-request-header")
-        )
-        > 0
+        if len(lib.find_element("pickup-request-header", response)) > 0
         else None
     )
     return pickup, parse_error_response(response, settings)
 
 
 def _extract_pickup_details(response: Element, settings: Settings) -> PickupDetails:
-    header = next(
-        (
-            XP.to_object(PickupRequestHeaderType, elt)
-            for elt in response.xpath(
-                ".//*[local-name() = $name]", name="pickup-request-header"
-            )
-        )
+    header = lib.find_element(
+        "pickup-request-header", response, PickupRequestHeaderType, first=True
     )
-    price = next(
-        (
-            XP.to_object(PickupRequestPriceType, elt)
-            for elt in response.xpath(
-                ".//*[local-name() = $name]", name="pickup-request-price"
-            )
-        ),
-        None,
+    price = lib.find_element(
+        "pickup-request-price", response, PickupRequestPriceType, first=True
     )
-
     price_amount = (
         sum(
             [
                 NF.decimal(price.hst_amount or 0.0),
                 NF.decimal(price.gst_amount or 0.0),
                 NF.decimal(price.due_amount or 0.0),
             ],
@@ -96,38 +83,36 @@
             name="Pickup fees", amount=NF.decimal(price_amount), currency="CAD"
         )
         if price is not None
         else None,
     )
 
 
-def pickup_request(
-    payload: PickupRequest, settings: Settings
-) -> Serializable[Pipeline]:
+def pickup_request(payload: PickupRequest, settings: Settings) -> Serializable:
     request: Pipeline = Pipeline(
         get_availability=lambda *_: _get_pickup_availability(payload),
         create_pickup=partial(_create_pickup, payload=payload, settings=settings),
     )
     return Serializable(request)
 
 
 def _create_pickup_request(
     payload: PickupRequest, settings: Settings, update: bool = False
-) -> Serializable[PickupRequestDetails]:
+) -> Serializable:
     """
     pickup_request create a serializable typed PickupRequestDetailsType
 
     Options:
         - five_ton_flag
         - loading_dock_flag
 
     :param update: bool
     :param payload: PickupRequest
     :param settings: Settings
-    :return: Serializable[PickupRequest]
+    :return: Serializable
     """
     RequestType = PickupRequestUpdateDetailsType if update else PickupRequestDetailsType
     packages = Packages(payload.parcels, PackagePresets, required=["weight"])
     heavy = any([p for p in packages if p.weight.KG > 23])
     location_details = dict(
         instruction=payload.instruction,
         five_ton_flag=payload.options.get("five_ton_flag"),
```

## karrio/providers/canadapost/pickup/update.py

```diff
@@ -1,38 +1,53 @@
+import karrio.lib as lib
 from typing import cast, Tuple, List
 from functools import partial
 from karrio.core.utils import Job, Pipeline, Serializable, Element
-from karrio.core.models import PickupRequest, PickupUpdateRequest, PickupDetails, Message
+from karrio.core.models import (
+    PickupRequest,
+    PickupUpdateRequest,
+    PickupDetails,
+    Message,
+)
 
 from karrio.providers.canadapost.utils import Settings
 from karrio.providers.canadapost.pickup.create import (
     parse_pickup_response,
-
     _create_pickup_request,
     _get_pickup,
 )
 
 
-def parse_pickup_update_response(response: Element, settings: Settings) -> Tuple[PickupDetails, List[Message]]:
+def parse_pickup_update_response(
+    _response: lib.Deserializable[Element], settings: Settings
+) -> Tuple[PickupDetails, List[Message]]:
+    response = _response.deserialize()
     return parse_pickup_response(response, settings)
 
 
-def pickup_update_request(payload: PickupUpdateRequest, settings: Settings) -> Serializable[Pipeline]:
+def pickup_update_request(
+    payload: PickupUpdateRequest, settings: Settings
+) -> Serializable:
     request: Pipeline = Pipeline(
         update_pickup=lambda *_: _update_pickup(payload, settings),
         get_pickup=partial(_get_pickup, payload=payload, settings=settings),
     )
     return Serializable(request)
 
 
 def _update_pickup(payload: PickupUpdateRequest, settings: Settings) -> Job:
-    data = Serializable(dict(
-        confirmation_number=payload.confirmation_number,
-        data=_create_pickup_request(cast(PickupRequest, payload), settings, update=True),
-    ), _update_request_serializer)
+    data = Serializable(
+        dict(
+            confirmation_number=payload.confirmation_number,
+            data=_create_pickup_request(
+                cast(PickupRequest, payload), settings, update=True
+            ),
+        ),
+        _update_request_serializer,
+    )
     fallback = "" if data is None else ""
 
     return Job(id="update_pickup", data=data, fallback=fallback)
 
 
 def _update_request_serializer(request: dict) -> dict:
     pickuprequest = request["confirmation_number"]
```

## karrio/providers/canadapost/shipment/cancel.py

```diff
@@ -1,63 +1,73 @@
+import karrio.lib as lib
 from typing import List, Tuple
 from canadapost_lib.shipment import ShipmentRefundRequestType, ShipmentInfoType
-from karrio.core.models import (
-    ShipmentCancelRequest,
-    ConfirmationDetails,
-    Message
-)
+from karrio.core.models import ShipmentCancelRequest, ConfirmationDetails, Message
 from karrio.core.utils import (
     Element,
     Serializable,
     Pipeline,
     Job,
     XP,
 )
 from karrio.providers.canadapost.error import parse_error_response
 from karrio.providers.canadapost.utils import Settings
 
 
-def parse_shipment_cancel_response(response: Element, settings: Settings) -> Tuple[ConfirmationDetails, List[Message]]:
+def parse_shipment_cancel_response(
+    _response: lib.Deserializable[Element], settings: Settings
+) -> Tuple[ConfirmationDetails, List[Message]]:
+    response = _response.deserialize()
     errors = parse_error_response(response, settings)
     success = len(errors) == 0
-    confirmation: ConfirmationDetails = ConfirmationDetails(
-        carrier_id=settings.carrier_id,
-        carrier_name=settings.carrier_name,
-        success=success,
-        operation="Cancel Shipment",
-    ) if success else None
+    confirmation: ConfirmationDetails = (
+        ConfirmationDetails(
+            carrier_id=settings.carrier_id,
+            carrier_name=settings.carrier_name,
+            success=success,
+            operation="Cancel Shipment",
+        )
+        if success
+        else None
+    )
 
     return confirmation, errors
 
 
-def shipment_cancel_request(payload: ShipmentCancelRequest, _) -> Serializable[Pipeline]:
+def shipment_cancel_request(payload: ShipmentCancelRequest, _) -> Serializable:
     identifier = Serializable(payload.shipment_identifier)
 
     def _refund_if_submitted(shipment_details: str):
         shipment = XP.to_object(ShipmentInfoType, XP.to_xml(shipment_details))
-        transmitted = shipment.shipment_status == 'transmitted'
-        data = dict(
-            id=payload.shipment_identifier,
-            payload=Serializable(
-                ShipmentRefundRequestType(email=payload.options.get('email')),
-                lambda request: XP.export(
-                    request, name_='shipment-refund-request', namespacedef_='xmlns="http://www.canadapost.ca/ws/shipment-v8"'
-                )
+        transmitted = shipment.shipment_status == "transmitted"
+        data = (
+            dict(
+                id=payload.shipment_identifier,
+                payload=Serializable(
+                    ShipmentRefundRequestType(email=payload.options.get("email")),
+                    lambda request: XP.export(
+                        request,
+                        name_="shipment-refund-request",
+                        namespacedef_='xmlns="http://www.canadapost.ca/ws/shipment-v8"',
+                    ),
+                ),
             )
-        ) if transmitted else None
+            if transmitted
+            else None
+        )
 
         return Job(id="refund", data=data, fallback=shipment_details)
 
     def _cancel_other_wise(previous_job_response: str):
         response: Element = XP.to_xml(previous_job_response)
-        refunded = (response.tag == 'shipment-refund-request-info')
+        refunded = response.tag == "shipment-refund-request-info"
         data = identifier if not refunded else None
 
         return Job(id="cancel", data=data)
 
     request: Pipeline = Pipeline(
         info=lambda *_: Job(id="info", data=identifier),
         refund=_refund_if_submitted,
-        cancel=_cancel_other_wise
+        cancel=_cancel_other_wise,
     )
 
     return Serializable(request)
```

## karrio/providers/canadapost/shipment/contract.py

```diff
@@ -26,16 +26,20 @@
 import karrio.core.models as models
 import karrio.providers.canadapost.error as provider_error
 import karrio.providers.canadapost.units as provider_units
 import karrio.providers.canadapost.utils as provider_utils
 
 
 def parse_shipment_response(
-    response: lib.Element, settings: provider_utils.Settings
+    _response: lib.Deserializable[lib.Element],
+    settings: provider_utils.Settings,
 ) -> typing.Tuple[models.ShipmentDetails, typing.List[models.Message]]:
+    response = (
+        _response.deserialize() if hasattr(_response, "deserialize") else _response
+    )
     shipment = (
         _extract_shipment(response, settings)
         if len(lib.find_element("shipment-id", response)) > 0
         else None
     )
     return shipment, provider_error.parse_error_response(response, settings)
 
@@ -60,15 +64,15 @@
         ),
     )
 
 
 def shipment_request(
     payload: models.ShipmentRequest,
     settings: provider_utils.Settings,
-) -> lib.Serializable[ShipmentType]:
+) -> lib.Serializable:
     service = provider_units.ServiceType.map(payload.service).value_or_key
     package = lib.to_packages(
         payload.parcels,
         provider_units.PackagePresets,
         required=["weight"],
         package_option_type=provider_units.ShippingOption,
     ).single
@@ -228,15 +232,15 @@
                 )
                 if payload.customs is not None
                 else None
             ),
             references=ReferencesType(
                 cost_centre=(
                     options.canadapost_cost_center.state
-                    or settings.metadata.get("cost-center")
+                    or settings.connection_config.cost_center.state
                     or payload.reference
                 ),
                 customer_ref_1=payload.reference,
                 customer_ref_2=None,
             ),
             settlement_info=SettlementInfoType(
                 paid_by_customer=getattr(
```

## karrio/providers/canadapost/shipment/create.py

```diff
@@ -1,26 +1,31 @@
 from functools import partial
 from typing import Tuple, List
 
+import karrio.lib as lib
 from karrio.core.utils import Element, XP, Serializable
 from karrio.core.utils.pipeline import Pipeline, Job
 from karrio.core.models import ShipmentRequest, ShipmentDetails, Message
 
 from karrio.providers.canadapost.utils import Settings
 import karrio.providers.canadapost.shipment.contract as contract
 import karrio.providers.canadapost.shipment.non_contract as non_contract
 
 
-def parse_shipment_response(response: Element, settings: Settings) -> Tuple[ShipmentDetails, List[Message]]:
+def parse_shipment_response(
+    _response: lib.Deserializable[Element],
+    settings: Settings,
+) -> Tuple[ShipmentDetails, List[Message]]:
+    response = _response.deserialize()
     if settings.contract_id is None or settings.contract_id == "":
         return non_contract.parse_shipment_response(response, settings)
     return contract.parse_shipment_response(response, settings)
 
 
-def shipment_request(payload: ShipmentRequest, settings: Settings) -> Serializable[Pipeline]:
+def shipment_request(payload: ShipmentRequest, settings: Settings) -> Serializable:
     requests: Pipeline = Pipeline(
         create_shipment=lambda *_: _create_shipment(payload, settings),
         retrieve_label=partial(_get_shipment_label),
     )
     return Serializable(requests)
 
 
@@ -36,13 +41,17 @@
 
 
 def _get_shipment_label(shipement_response: str) -> Job:
     response = XP.to_xml(shipement_response)
     has_errors = len(response.xpath(".//*[local-name() = $name]", name="message")) > 0
     links = response.xpath(".//*[local-name() = $name]", name="link")
     href, media = next(
-        ((link.get("href"), link.get("media-type")) for link in links if link.get("rel") == "label"),
+        (
+            (link.get("href"), link.get("media-type"))
+            for link in links
+            if link.get("rel") == "label"
+        ),
         (None, None),
     )
     data = None if has_errors else dict(href=href, media=media)
 
     return Job(id="shipment_label", data=data, fallback="")
```

## karrio/providers/canadapost/shipment/non_contract.py

```diff
@@ -5,19 +5,21 @@
 import karrio.core.models as models
 import karrio.providers.canadapost.error as provider_error
 import karrio.providers.canadapost.units as provider_units
 import karrio.providers.canadapost.utils as provider_utils
 
 
 def parse_shipment_response(
-    response: lib.Element, settings: provider_utils.Settings
+    _response: lib.Deserializable[lib.Element],
+    settings: provider_utils.Settings,
 ) -> typing.Tuple[models.ShipmentDetails, typing.List[models.Message]]:
+    response = _response.deserialize()
     shipment = (
         _extract_shipment(response, settings)
-        if len(lib.find_elements("shipment-id", response)) > 0
+        if len(lib.find_element("shipment-id", response)) > 0
         else None
     )
     return shipment, provider_error.parse_error_response(response, settings)
 
 
 def _extract_shipment(
     response: lib.Element, settings: provider_utils.Settings
@@ -37,17 +39,15 @@
         docs=models.Documents(label=label),
         meta=dict(
             carrier_tracking_link=settings.tracking_url.format(info.tracking_pin),
         ),
     )
 
 
-def shipment_request(
-    payload: models.ShipmentRequest, _
-) -> lib.Serializable[canadapost.NonContractShipmentType]:
+def shipment_request(payload: models.ShipmentRequest, _) -> lib.Serializable:
     service = provider_units.ServiceType.map(payload.service).value_or_key
     customs = lib.to_customs_info(payload.customs)
     package = lib.to_packages(
         payload.parcels,
         provider_units.PackagePresets,
         required=["weight"],
         package_option_type=provider_units.ShippingOption,
@@ -67,30 +67,34 @@
         delivery_spec=canadapost.DeliverySpecType(
             service_code=service,
             sender=canadapost.SenderType(
                 name=payload.shipper.person_name,
                 company=payload.shipper.company_name,
                 contact_phone=payload.shipper.phone_number,
                 address_details=canadapost.DomesticAddressDetailsType(
-                    address_line_1=lib.text(payload.shipper.street_number, payload.shipper.address_line1),
+                    address_line_1=lib.text(
+                        payload.shipper.street_number, payload.shipper.address_line1
+                    ),
                     address_line_2=lib.text(payload.shipper.address_line2),
                     city=payload.shipper.city,
                     prov_state=payload.shipper.state_code,
                     postal_zip_code=provider_utils.format_ca_postal_code(
                         payload.shipper.postal_code
                     ),
                 ),
             ),
             destination=canadapost.DestinationType(
                 name=payload.recipient.person_name,
                 company=payload.recipient.company_name,
                 additional_address_info=None,
                 client_voice_number=payload.recipient.phone_number,
                 address_details=canadapost.DestinationAddressDetailsType(
-                    address_line_1=lib.text(payload.recipient.street_number, payload.recipient.address_line1),
+                    address_line_1=lib.text(
+                        payload.recipient.street_number, payload.recipient.address_line1
+                    ),
                     address_line_2=lib.text(payload.recipient.address_line2),
                     city=payload.recipient.city,
                     prov_state=payload.recipient.state_code,
                     country_code=payload.recipient.country_code,
                     postal_zip_code=provider_utils.format_ca_postal_code(
                         payload.recipient.postal_code
                     ),
```

## Comparing `karrio.canadapost-2023.3.dist-info/METADATA` & `karrio.canadapost-2023.4.dist-info/METADATA`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: karrio.canadapost
-Version: 2023.3
+Version: 2023.4
 Summary: Karrio - Canada Post Shipping Extension
 Home-page: https://github.com/karrioapi/karrio
 Author: karrio
 Author-email: hello@karrio.io
 License: Apache-2.0
 Platform: UNKNOWN
 Classifier: Intended Audience :: Developers
```

## Comparing `karrio.canadapost-2023.3.dist-info/RECORD` & `karrio.canadapost-2023.4.dist-info/RECORD`

 * *Files 13% similar despite different names*

```diff
@@ -1,23 +1,23 @@
-karrio/mappers/canadapost/__init__.py,sha256=Aceyc08gkcRYcOLe0Bx2Z4FGaA8GNQybPe0XUJaKhlg,525
-karrio/mappers/canadapost/mapper.py,sha256=OHjk5FiKmtnXbb7ldxFW7LWkLe8Pr9OiGUB7EJgEo1I,3534
-karrio/mappers/canadapost/proxy.py,sha256=DHUI4pEzj_Mg2k2VxD8Qwup1CzUhCV2kkvcWY_84dps,10416
-karrio/mappers/canadapost/settings.py,sha256=V3FzAWUKco2iQrU__KC-ZGmXjDCRC7x05qeG2X_IelY,488
+karrio/mappers/canadapost/__init__.py,sha256=hNFl2YQ_uPnU4o9z0ijVC50tHMYLGy8wDQC-QVcZv-0,572
+karrio/mappers/canadapost/mapper.py,sha256=7qJcrL4Y4EUlzm90ze-MOK8LNJ1NZLIFuM9P_4uGXnQ,3357
+karrio/mappers/canadapost/proxy.py,sha256=dJ7l6R_gqiRNcS9oXitKjJ4WEgOes_P2mDEvjl3aeSY,10326
+karrio/mappers/canadapost/settings.py,sha256=oJd4dxBErIjO9E9dseG7CFdw0Z6It4OgbPzRSuZIhlU,510
 karrio/providers/canadapost/__init__.py,sha256=VPGPLfVtfjRnwrUlQVnR8rmkp1fMIPmDIxiqhOvDKpg,688
 karrio/providers/canadapost/error.py,sha256=DTGhD7NRllKDQ55SMnH4-O1z6jLY_9AyZVvcWN5v6VQ,1304
-karrio/providers/canadapost/rate.py,sha256=Willjd3Xz0Jhc_bcAZxx3y34NTAq4CMXSeSxYAJxlSI,6206
-karrio/providers/canadapost/tracking.py,sha256=JTmU_BrXkVt-tIz6TIzajhqmiSbeKyXyAiktF6Yh3lI,2733
-karrio/providers/canadapost/units.py,sha256=RGmIfrI4dFvBxHgGa-dzVnVFaq7gejkpzyci0JmzmUI,7856
-karrio/providers/canadapost/utils.py,sha256=lNkoy2nkPJAdkpAvR_QBJ9Chw5PvykXbP-zVjWOsq5k,1130
+karrio/providers/canadapost/rate.py,sha256=aWEVyNSfPmvDFuKJbmQGgx6gBT6flavZOO0iWYWAYZ0,6253
+karrio/providers/canadapost/tracking.py,sha256=0hh8HalsKTWXwJVec-v7QoS-gSpyzBpGak3YDV6tRog,2769
+karrio/providers/canadapost/units.py,sha256=QOKO6nrU-MkqPoi5rs2xkQa_vKFU98f3GNIPJ7Zdit4,8116
+karrio/providers/canadapost/utils.py,sha256=teT0hKrQs7_s7LgoL-RZagQv7ETCeZQ9NPp70U7HWGY,1447
 karrio/providers/canadapost/pickup/__init__.py,sha256=uLN8GzjaW1ezPty1NxIKKFouHwkMGeYsdK_yAg7OwxE,304
-karrio/providers/canadapost/pickup/cancel.py,sha256=SWS-gJIblIkR-atrc9pekpFTdeDBYSPiZkYEEgiYb-Q,921
-karrio/providers/canadapost/pickup/create.py,sha256=1yNPwfWbGy-MylbdUuz4UjK_UCRlwz4_i0HqBXhfMvg,7282
-karrio/providers/canadapost/pickup/update.py,sha256=OiSG8UuO2WwRo0cVD5BDJIZuawgftcGotQBYgSO_cO8,1503
+karrio/providers/canadapost/pickup/cancel.py,sha256=io3_KxVzwAkH1zcIc1ycPwf_Up16mI_pgT84BCu0P3k,1001
+karrio/providers/canadapost/pickup/create.py,sha256=oBdmlodve9cyaQMZVT1fwT6reuHjJ7ftKonFemriB6o,7056
+karrio/providers/canadapost/pickup/update.py,sha256=S0SfblN6LPkSl_1SyVmuELJIqOPEuKLFFzwYU3fs0K0,1675
 karrio/providers/canadapost/shipment/__init__.py,sha256=kITqJglgqlnoHrBdCr8iQXugr0PfZwaoTK9kiuYlkGQ,236
-karrio/providers/canadapost/shipment/cancel.py,sha256=IBN4wp2Oo9hyJiM51iKNLjDN5NV3p651TEhi0iqAlAw,2220
-karrio/providers/canadapost/shipment/contract.py,sha256=6f65WxseTYeTi1RhT520mW5jn_HE6YF5R9OdbvuraY4,10608
-karrio/providers/canadapost/shipment/create.py,sha256=15eA8YC0GD5fPCA5aIHgSUiNsBqcU5NlBvOyiZTGbaQ,2003
-karrio/providers/canadapost/shipment/non_contract.py,sha256=MhCtisl7pMR7sNgzNvojK0-2jPASpjwg0QMaxNFIlx0,8114
-karrio.canadapost-2023.3.dist-info/METADATA,sha256=dRXyhhVxCii_7gk8lcluTDTkTA5WtD_AJG_v8UTudK4,1014
-karrio.canadapost-2023.3.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
-karrio.canadapost-2023.3.dist-info/top_level.txt,sha256=mfkVZXzNuVRmA7NRlck_Ub-C8Zgtqxbx3gX1Rq_W-i0,7
-karrio.canadapost-2023.3.dist-info/RECORD,,
+karrio/providers/canadapost/shipment/cancel.py,sha256=swI8kAgTPwWIEvJHx4Y9FJRQTtHZD-SAhTIZkZSZ08w,2467
+karrio/providers/canadapost/shipment/contract.py,sha256=zhPgBC-GWCebipKCVkJSRbH0TeBEqwi6CjPJEjsoTb8,10735
+karrio/providers/canadapost/shipment/create.py,sha256=VV-FM-d0qjjT-RbMqVcDNvgOKSVrGKY3yGAH90-XtSU,2135
+karrio/providers/canadapost/shipment/non_contract.py,sha256=GTB5mLKMovUsL-aOJsLZ6QJgE4JmWdOpauccAR0V3SU,8228
+karrio.canadapost-2023.4.dist-info/METADATA,sha256=f26stDFL1wXddUnoJQUDCpvJFg5h6_lP2qyFDdOJPwA,1014
+karrio.canadapost-2023.4.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
+karrio.canadapost-2023.4.dist-info/top_level.txt,sha256=mfkVZXzNuVRmA7NRlck_Ub-C8Zgtqxbx3gX1Rq_W-i0,7
+karrio.canadapost-2023.4.dist-info/RECORD,,
```

