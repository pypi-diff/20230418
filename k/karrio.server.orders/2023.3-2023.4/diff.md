# Comparing `tmp/karrio.server.orders-2023.3-py3-none-any.whl.zip` & `tmp/karrio.server.orders-2023.4-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,41 +1,42 @@
-Zip file size: 28417 bytes, number of entries: 39
+Zip file size: 29399 bytes, number of entries: 40
 -rw-rw-r--  2.0 unx       81 b- defN 23-Mar-03 13:50 karrio/server/graph/schemas/__init__.py
 -rw-rw-r--  2.0 unx     1053 b- defN 23-Mar-03 13:50 karrio/server/graph/schemas/orders/__init__.py
 -rw-rw-r--  2.0 unx     2152 b- defN 23-Mar-06 05:06 karrio/server/graph/schemas/orders/inputs.py
 -rw-rw-r--  2.0 unx     2351 b- defN 23-Mar-03 13:50 karrio/server/graph/schemas/orders/mutations.py
--rw-rw-r--  2.0 unx     2720 b- defN 23-Mar-06 05:06 karrio/server/graph/schemas/orders/types.py
+-rw-rw-r--  2.0 unx     2726 b- defN 23-Apr-10 18:00 karrio/server/graph/schemas/orders/types.py
 -rw-rw-r--  2.0 unx        0 b- defN 23-Mar-03 13:50 karrio/server/orders/__init__.py
 -rw-rw-r--  2.0 unx       63 b- defN 23-Mar-03 13:50 karrio/server/orders/admin.py
 -rw-rw-r--  2.0 unx      351 b- defN 23-Mar-03 13:50 karrio/server/orders/apps.py
 -rw-rw-r--  2.0 unx     7941 b- defN 23-Mar-03 13:50 karrio/server/orders/filters.py
--rw-rw-r--  2.0 unx     3975 b- defN 23-Mar-03 13:50 karrio/server/orders/models.py
+-rw-rw-r--  2.0 unx     3889 b- defN 23-Apr-12 03:53 karrio/server/orders/models.py
 -rw-rw-r--  2.0 unx       95 b- defN 23-Mar-03 13:50 karrio/server/orders/router.py
--rw-rw-r--  2.0 unx     4505 b- defN 23-Mar-03 13:50 karrio/server/orders/signals.py
+-rw-rw-r--  2.0 unx     5310 b- defN 23-Apr-12 04:13 karrio/server/orders/signals.py
 -rw-rw-r--  2.0 unx      217 b- defN 23-Mar-03 13:50 karrio/server/orders/urls.py
--rw-rw-r--  2.0 unx     5672 b- defN 23-Mar-26 14:29 karrio/server/orders/views.py
+-rw-rw-r--  2.0 unx     5672 b- defN 23-Mar-27 07:55 karrio/server/orders/views.py
 -rw-rw-r--  2.0 unx     4879 b- defN 23-Mar-03 13:50 karrio/server/orders/migrations/0001_initial.py
 -rw-rw-r--  2.0 unx      214 b- defN 23-Mar-03 13:50 karrio/server/orders/migrations/0002_auto_20211231_2353.py
 -rw-rw-r--  2.0 unx      551 b- defN 23-Mar-03 13:50 karrio/server/orders/migrations/0003_alter_order_shipping_address.py
 -rw-rw-r--  2.0 unx      556 b- defN 23-Mar-03 13:50 karrio/server/orders/migrations/0004_alter_order_status.py
 -rw-rw-r--  2.0 unx      720 b- defN 23-Mar-03 13:50 karrio/server/orders/migrations/0005_auto_20220303_1153.py
 -rw-rw-r--  2.0 unx      556 b- defN 23-Mar-03 13:50 karrio/server/orders/migrations/0006_alter_order_shipping_to.py
 -rw-rw-r--  2.0 unx      525 b- defN 23-Mar-03 13:50 karrio/server/orders/migrations/0007_alter_order_line_items.py
 -rw-rw-r--  2.0 unx     1076 b- defN 23-Mar-03 13:50 karrio/server/orders/migrations/0008_alter_order_status.py
 -rw-rw-r--  2.0 unx     1078 b- defN 23-Mar-03 13:50 karrio/server/orders/migrations/0009_auto_20220321_1535.py
 -rw-rw-r--  2.0 unx      741 b- defN 23-Mar-03 13:50 karrio/server/orders/migrations/0010_auto_20220324_2031.py
 -rw-rw-r--  2.0 unx      575 b- defN 23-Mar-03 13:50 karrio/server/orders/migrations/0011_order_billing_address.py
 -rw-rw-r--  2.0 unx      382 b- defN 23-Mar-03 13:50 karrio/server/orders/migrations/0012_order_order_id_idx.py
 -rw-rw-r--  2.0 unx      621 b- defN 23-Mar-03 13:50 karrio/server/orders/migrations/0014_order_meta.py
 -rw-rw-r--  2.0 unx     1229 b- defN 23-Mar-03 13:50 karrio/server/orders/migrations/0015_remove_order_order_id_idx_alter_order_order_id_and_more.py
+-rw-rw-r--  2.0 unx     1425 b- defN 23-Apr-18 10:28 karrio/server/orders/migrations/0016_order_shipments.py
 -rw-rw-r--  2.0 unx        0 b- defN 23-Mar-03 13:50 karrio/server/orders/migrations/__init__.py
 -rw-rw-r--  2.0 unx      336 b- defN 23-Mar-03 13:50 karrio/server/orders/serializers/__init__.py
 -rw-rw-r--  2.0 unx     5387 b- defN 23-Mar-03 13:50 karrio/server/orders/serializers/base.py
 -rw-rw-r--  2.0 unx     6476 b- defN 23-Mar-03 13:50 karrio/server/orders/serializers/order.py
 -rw-rw-r--  2.0 unx      104 b- defN 23-Mar-03 13:50 karrio/server/orders/tests/__init__.py
--rw-rw-r--  2.0 unx    35792 b- defN 23-Mar-26 12:53 karrio/server/orders/tests/test_orders.py
+-rw-rw-r--  2.0 unx    35792 b- defN 23-Mar-27 07:55 karrio/server/orders/tests/test_orders.py
 -rw-rw-r--  2.0 unx      132 b- defN 23-Mar-03 13:50 karrio/server/settings/orders.py
--rw-rw-r--  2.0 unx      526 b- defN 23-Mar-27 07:16 karrio.server.orders-2023.3.dist-info/METADATA
--rw-rw-r--  2.0 unx       92 b- defN 23-Mar-27 07:16 karrio.server.orders-2023.3.dist-info/WHEEL
--rw-rw-r--  2.0 unx        7 b- defN 23-Mar-27 07:16 karrio.server.orders-2023.3.dist-info/top_level.txt
--rw-rw-r--  2.0 unx     3939 b- defN 23-Mar-27 07:16 karrio.server.orders-2023.3.dist-info/RECORD
-39 files, 97670 bytes uncompressed, 21827 bytes compressed:  77.7%
+-rw-rw-r--  2.0 unx      526 b- defN 23-Apr-18 10:32 karrio.server.orders-2023.4.dist-info/METADATA
+-rw-rw-r--  2.0 unx       92 b- defN 23-Apr-18 10:32 karrio.server.orders-2023.4.dist-info/WHEEL
+-rw-rw-r--  2.0 unx        7 b- defN 23-Apr-18 10:32 karrio.server.orders-2023.4.dist-info/top_level.txt
+-rw-rw-r--  2.0 unx     4051 b- defN 23-Apr-18 10:32 karrio.server.orders-2023.4.dist-info/RECORD
+40 files, 99932 bytes uncompressed, 22623 bytes compressed:  77.4%
```

## zipnote {}

```diff
@@ -78,14 +78,17 @@
 
 Filename: karrio/server/orders/migrations/0014_order_meta.py
 Comment: 
 
 Filename: karrio/server/orders/migrations/0015_remove_order_order_id_idx_alter_order_order_id_and_more.py
 Comment: 
 
+Filename: karrio/server/orders/migrations/0016_order_shipments.py
+Comment: 
+
 Filename: karrio/server/orders/migrations/__init__.py
 Comment: 
 
 Filename: karrio/server/orders/serializers/__init__.py
 Comment: 
 
 Filename: karrio/server/orders/serializers/base.py
@@ -99,20 +102,20 @@
 
 Filename: karrio/server/orders/tests/test_orders.py
 Comment: 
 
 Filename: karrio/server/settings/orders.py
 Comment: 
 
-Filename: karrio.server.orders-2023.3.dist-info/METADATA
+Filename: karrio.server.orders-2023.4.dist-info/METADATA
 Comment: 
 
-Filename: karrio.server.orders-2023.3.dist-info/WHEEL
+Filename: karrio.server.orders-2023.4.dist-info/WHEEL
 Comment: 
 
-Filename: karrio.server.orders-2023.3.dist-info/top_level.txt
+Filename: karrio.server.orders-2023.4.dist-info/top_level.txt
 Comment: 
 
-Filename: karrio.server.orders-2023.3.dist-info/RECORD
+Filename: karrio.server.orders-2023.4.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## karrio/server/graph/schemas/orders/types.py

```diff
@@ -52,15 +52,15 @@
 
     @strawberry.field
     def line_items(self: models.Order) -> typing.List[LineItemType]:
         return self.line_items.all()
 
     @strawberry.field
     def shipments(self: models.Order) -> typing.List[base.types.ShipmentType]:
-        return self.shipments
+        return self.shipments.all()
 
     @staticmethod
     @utils.authentication_required
     def resolve(info, id: str) -> typing.Optional["OrderType"]:
         return models.Order.access_by(info.context.request).filter(id=id).first()
 
     @staticmethod
```

## karrio/server/orders/models.py

```diff
@@ -45,14 +45,15 @@
                 "created_by",
                 "shipping_to",
                 "shipping_from",
                 "billing_address",
             )
             .prefetch_related(
                 "line_items",
+                "shipments",
             )
         )
 
 
 @register_model
 class Order(OwnedEntity):
     HIDDEN_PROPS = (*(("org",) if settings.MULTI_ORGANIZATIONS else tuple()),)
@@ -100,35 +101,30 @@
         null=True,
         on_delete=models.CASCADE,
         related_name="bill_to_order",
     )
     line_items = models.ManyToManyField(
         LineItem, related_name="commodity_order", through="OrderLineItemLink"
     )
+    shipments = models.ManyToManyField(
+        "manager.Shipment", related_name="shipment_order"
+    )
     options = models.JSONField(
         blank=True, null=True, default=partial(identity, value={})
     )
     metadata = models.JSONField(
         blank=True, null=True, default=partial(identity, value={})
     )
     meta = models.JSONField(blank=True, null=True, default=partial(identity, value={}))
     test_mode = models.BooleanField()
 
     @property
     def object_type(self):
         return "order"
 
-    # computed fields
-
-    @property
-    def shipments(self):
-        return manager.Shipment.objects.filter(
-            parcels__items__parent_id__in=self.line_items.values_list("id", flat=True)
-        ).distinct()
-
 
 """Models orders linking (for reverse OneToMany relations)"""
 
 
 class OrderLineItemLink(models.Model):
     order = models.ForeignKey(
         Order, on_delete=models.CASCADE, related_name="line_item_links"
```

## karrio/server/orders/signals.py

```diff
@@ -11,46 +11,46 @@
 import karrio.server.orders.models as models
 import karrio.server.events.tasks as tasks
 
 logger = logging.getLogger(__name__)
 
 
 def register_signals():
+    signals.m2m_changed.connect(
+        shipments_updated, sender=models.Order.shipments.through
+    )
     signals.post_delete.connect(commodity_mutated, sender=manager.Commodity)
     signals.post_save.connect(commodity_mutated, sender=manager.Commodity)
     signals.post_save.connect(shipment_updated, sender=manager.Shipment)
     signals.post_save.connect(order_updated, sender=models.Order)
 
     logger.info("karrio.order signals registered...")
 
 
 @utils.disable_for_loaddata
 def commodity_mutated(sender, instance, *args, **kwargs):
     """Commodity mutations (added or removed)"""
+    parent = utils.failsafe(lambda: instance.parent)
 
-    try:
-        parent = getattr(instance, "parent", None)
-    except Exception as e:
-        return
-
-    if parent is None:
+    if parent is None or parent.order is None:
         return
 
-    if parent.order is None:
-        return
+    order_shipments = manager.Shipment.objects.filter(
+        parcels__items__parent_id__in=parent.order.line_items.values_list(
+            "id", flat=True
+        )
+    ).distinct()
 
-    # Retrieve all orders associated with this commodity and update their status if needed
-    for order in models.Order.objects.filter(
-        line_items__id=instance.parent_id
-    ).distinct():
-        status = compute_order_status(order)
-        if status != order.status:
-            order.status = status
-            order.save(update_fields=["status"])
-            logger.info("commodity related order successfully updated")
+    for shipment in order_shipments:
+        if parent.order.shipments.filter(id=shipment.id).exists() == False:
+            parent.order.shipments.add(shipment)
+
+    for shipment in parent.order.shipments.all():
+        if order_shipments.filter(id=shipment.id).exists() == False:
+            parent.order.shipments.remove(shipment)
 
 
 @utils.disable_for_loaddata
 def shipment_updated(
     sender, instance, created, raw, using, update_fields, *args, **kwargs
 ):
     """Shipment related events:
@@ -58,19 +58,30 @@
     - shipment fulfilled (shipped)
     """
     if not instance.parcels.filter(
         items__parent__order_link__order__isnull=False
     ).exists():
         return
 
-    if instance.status != serializers.ShipmentStatus.draft.value:
-        # Retrieve all orders associated with this shipment and update their status if needed
-        for order in models.Order.objects.filter(
-            line_items__children__commodity_parcel__parcel_shipment__id=instance.id
-        ).distinct():
+    # Retrieve all orders associated with this shipment and update their status if needed
+    related_orders = models.Order.objects.filter(
+        line_items__children__commodity_parcel__parcel_shipment__id=instance.id
+    ).distinct()
+
+    if related_orders.exists():
+        instance.meta = {
+            **(instance.meta or {}),
+            "orders": [_.id for _ in related_orders],
+        }
+
+    for order in related_orders:
+        if order.shipments.filter(id=instance.id).exists() == False:
+            order.shipments.add(instance)
+
+        if instance.status != serializers.ShipmentStatus.draft.value:
             status = compute_order_status(order)
             if status != order.status:
                 order.status = status
                 order.save(update_fields=["status"])
                 logger.info("shipment related order successfully updated")
 
 
@@ -125,7 +136,20 @@
         ),
     )
 
     if settings.MULTI_ORGANIZATIONS and context["org_id"] is None:
         return
 
     tasks.notify_webhooks(event, data, event_at, context, schema=settings.schema)
+
+
+@utils.disable_for_loaddata
+def shipments_updated(
+    sender, instance, action, reverse, model, pk_set, *args, **kwargs
+):
+    """Order shipments updated"""
+
+    status = compute_order_status(instance)
+    if status != instance.status:
+        instance.status = status
+        instance.save(update_fields=["status"])
+        logger.info("shipment related order successfully updated")
```

## Comparing `karrio.server.orders-2023.3.dist-info/METADATA` & `karrio.server.orders-2023.4.dist-info/METADATA`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: karrio.server.orders
-Version: 2023.3
+Version: 2023.4
 Summary: Multi-carrier shipping API orders module
 Home-page: https://github.com/karrioapi/karrio
 Author: karrio
 Author-email: hello@karrio.io
 License: Apache-2.0
 Platform: UNKNOWN
 Classifier: Programming Language :: Python :: 3
```

## Comparing `karrio.server.orders-2023.3.dist-info/RECORD` & `karrio.server.orders-2023.4.dist-info/RECORD`

 * *Files 10% similar despite different names*

```diff
@@ -1,19 +1,19 @@
 karrio/server/graph/schemas/__init__.py,sha256=iOEMwnlORWezdO8-2vxBIPSR37D7JGjluZ8f55vzxls,81
 karrio/server/graph/schemas/orders/__init__.py,sha256=eLc00HWLsdR-3-sDnuFdLf8pzWohT_FP1GfjkJMoGfc,1053
 karrio/server/graph/schemas/orders/inputs.py,sha256=g9G81p5fBmFCZ9NoeqTho6YV66rY3Mmqb_dveF-Ryxo,2152
 karrio/server/graph/schemas/orders/mutations.py,sha256=dy3AfSX5om7rWQ2asAn7Eyl3qji1osCesdPruw3Ho1c,2351
-karrio/server/graph/schemas/orders/types.py,sha256=OVeImG7ZbSRbkvTx3vu7ADyDSr3hZlW4vuJEcFEDQ6w,2720
+karrio/server/graph/schemas/orders/types.py,sha256=CmupLGKqg2TePyfWcTZE5SdTCprBIMC8o5TYp28jHgA,2726
 karrio/server/orders/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 karrio/server/orders/admin.py,sha256=suMo4x8I3JBxAFBVIdE-5qnqZ6JAZV0FESABHOSc-vg,63
 karrio/server/orders/apps.py,sha256=2KMkNYxo3MgPNaUbQ95MJj9QtzHK1pxMIja75R_VDb0,351
 karrio/server/orders/filters.py,sha256=l3URf04c19lGKYdGB8z83N-d8BKptkt2QtTfDBHOV_U,7941
-karrio/server/orders/models.py,sha256=hEFCoReg-QmICdkJXWapkqKO5aVEHagn8tx3yZkMV_s,3975
+karrio/server/orders/models.py,sha256=PtAiCvHo_SMf-F0pGuIay2fz-qkDKiH_VpXhmYC0tXI,3889
 karrio/server/orders/router.py,sha256=IBUR7rfBkdEHQzWxYOPcVSM8NBp3fte9G6Q5BVTUNNw,95
-karrio/server/orders/signals.py,sha256=uTj6FltIFnZwQBS-QG-zBsqV41XpbwKDAKkOf0Uw_Fw,4505
+karrio/server/orders/signals.py,sha256=I8i9kXKAb0PIsMe45CWyjRhdOO1qIm1YL4A-otN16JY,5310
 karrio/server/orders/urls.py,sha256=eB6eD443FIoonYaiXqbAhZ6m4R_d43i8jBDYHzLZh2U,217
 karrio/server/orders/views.py,sha256=p-gn6NxNAdCBRq3mb3Lo4LnILH3niHTjCp75emDVOHk,5672
 karrio/server/orders/migrations/0001_initial.py,sha256=akZsw-codaJBf1qrDO5a4scnFjCW4ohfQ_12Un1UPHE,4879
 karrio/server/orders/migrations/0002_auto_20211231_2353.py,sha256=TJ3jVFQDgg5KSaO1TJo6WCuPEFSebnCh2Lv12m5Pdkw,214
 karrio/server/orders/migrations/0003_alter_order_shipping_address.py,sha256=wFqMYcpHEKv1_iweFjPgmYcxXGqOngOFO21rHYfDgH4,551
 karrio/server/orders/migrations/0004_alter_order_status.py,sha256=GjUvsNdalBPV55OaBAaI2rBxb31273dimED00kZ4FNc,556
 karrio/server/orders/migrations/0005_auto_20220303_1153.py,sha256=s5CLzN78TQlPArT951SOfavsD7Pe61Aat1YI4CfXSfo,720
@@ -22,18 +22,19 @@
 karrio/server/orders/migrations/0008_alter_order_status.py,sha256=J6vpb88mVSABKXWgfG2HbR6rrUlfYWbgk8XKRv6nyqE,1076
 karrio/server/orders/migrations/0009_auto_20220321_1535.py,sha256=5DuKsSmlAAtX3eHEWQMx0mu_4Vzc2zFYNaf150zH-VU,1078
 karrio/server/orders/migrations/0010_auto_20220324_2031.py,sha256=c0oKd-Vr7DmI-TfQmVeKYf0pSgjRdVb5SFx-4Cbc4VI,741
 karrio/server/orders/migrations/0011_order_billing_address.py,sha256=23Gpyq3S-BsH93Lcrl4mZWmoD0BCgq9z4IvOJDU5P8M,575
 karrio/server/orders/migrations/0012_order_order_id_idx.py,sha256=8-OS8NR6q6U9Dl98P8fk-lXunN3GmuvB3JdCq33FPHA,382
 karrio/server/orders/migrations/0014_order_meta.py,sha256=SapHDhOOr8mZgHE85pcGsWbZp6vDnHqvUeEHYeMYlsg,621
 karrio/server/orders/migrations/0015_remove_order_order_id_idx_alter_order_order_id_and_more.py,sha256=XIRVVx7lU8zoRJLefOHtS6ly5KaJSsreAnNzpEWT0_c,1229
+karrio/server/orders/migrations/0016_order_shipments.py,sha256=WNgnztF8uFGPwgZNXhkZXWlI0tFSsWkdnh_78RowTtA,1425
 karrio/server/orders/migrations/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 karrio/server/orders/serializers/__init__.py,sha256=yhdz1Ucrclj-16ZNMrXxqic1hHjlSP-geQyp8qjaqTI,336
 karrio/server/orders/serializers/base.py,sha256=zl1RCt-efgqf2VTd-ci6LScqgW-kfCKgELOOSPgm0SI,5387
 karrio/server/orders/serializers/order.py,sha256=TFeD1AiquGj3oxqoCpULH_kC0NqASbCAv7_IucBYntg,6476
 karrio/server/orders/tests/__init__.py,sha256=dBA1EI44zDE3oPnQoo_V2JikwQCNSJpAxcYx6i1-HKs,104
 karrio/server/orders/tests/test_orders.py,sha256=wHZgNA14o_CRt8Uh3U156LErVfuU4ovr4oiuHKZe07U,35792
 karrio/server/settings/orders.py,sha256=irTFpv5Ny2B4nRpdGneSIhGa0e1T_hKctoKfwRGckkQ,132
-karrio.server.orders-2023.3.dist-info/METADATA,sha256=eNQOE-NgGaBqFIWHE8Ym6BLWnoDqfLAtMQNU0Rrj4JU,526
-karrio.server.orders-2023.3.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
-karrio.server.orders-2023.3.dist-info/top_level.txt,sha256=mfkVZXzNuVRmA7NRlck_Ub-C8Zgtqxbx3gX1Rq_W-i0,7
-karrio.server.orders-2023.3.dist-info/RECORD,,
+karrio.server.orders-2023.4.dist-info/METADATA,sha256=92lKqXyc1Prw-mhFvMMIudiuXDToiDb2cWSKTqJlEQM,526
+karrio.server.orders-2023.4.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
+karrio.server.orders-2023.4.dist-info/top_level.txt,sha256=mfkVZXzNuVRmA7NRlck_Ub-C8Zgtqxbx3gX1Rq_W-i0,7
+karrio.server.orders-2023.4.dist-info/RECORD,,
```

