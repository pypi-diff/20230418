# Comparing `tmp/kaiju_auth-2.0.12-py3-none-any.whl.zip` & `tmp/kaiju_auth-2.0.13-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,21 +1,21 @@
-Zip file size: 23120 bytes, number of entries: 19
--rw-r--r--  2.0 unx       84 b- defN 23-Mar-14 12:28 kaiju_auth/__init__.py
--rw-r--r--  2.0 unx       77 b- defN 23-Mar-14 12:28 kaiju_auth/etc.py
--rw-r--r--  2.0 unx     3765 b- defN 23-Mar-14 12:28 kaiju_auth/fixtures.py
--rw-r--r--  2.0 unx     4560 b- defN 23-Mar-14 12:28 kaiju_auth/http.py
--rw-r--r--  2.0 unx     7626 b- defN 23-Mar-14 12:28 kaiju_auth/login.py
--rw-r--r--  2.0 unx      285 b- defN 23-Mar-14 12:28 kaiju_auth/services.py
--rw-r--r--  2.0 unx     1691 b- defN 23-Mar-14 12:28 kaiju_auth/sessions.py
--rw-r--r--  2.0 unx     2892 b- defN 23-Mar-14 12:28 kaiju_auth/tables.py
--rw-r--r--  2.0 unx    11513 b- defN 23-Mar-14 12:28 kaiju_auth/tokens.py
--rw-r--r--  2.0 unx    27693 b- defN 23-Mar-14 12:28 kaiju_auth/users.py
--rw-r--r--  2.0 unx       55 b- defN 23-Mar-14 12:28 kaiju_auth/permissions_gui/__init__.py
--rw-r--r--  2.0 unx     3051 b- defN 23-Mar-14 12:28 kaiju_auth/permissions_gui/models.py
--rw-r--r--  2.0 unx    17380 b- defN 23-Mar-14 12:28 kaiju_auth/permissions_gui/service.py
--rw-r--r--  2.0 unx     1151 b- defN 23-Mar-14 12:28 kaiju_auth/permissions_gui/validators.py
--rw-rw-rw-  2.0 unx      610 b- defN 23-Mar-14 12:28 kaiju_auth-2.0.12.dist-info/LICENSE
--rw-r--r--  2.0 unx     2900 b- defN 23-Mar-14 12:28 kaiju_auth-2.0.12.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 23-Mar-14 12:28 kaiju_auth-2.0.12.dist-info/WHEEL
--rw-r--r--  2.0 unx       11 b- defN 23-Mar-14 12:28 kaiju_auth-2.0.12.dist-info/top_level.txt
-?rw-rw-r--  2.0 unx     1551 b- defN 23-Mar-14 12:28 kaiju_auth-2.0.12.dist-info/RECORD
-19 files, 86987 bytes uncompressed, 20592 bytes compressed:  76.3%
+Zip file size: 23482 bytes, number of entries: 19
+-rw-r--r--  2.0 unx       84 b- defN 23-Apr-18 12:43 kaiju_auth/__init__.py
+-rw-r--r--  2.0 unx       77 b- defN 23-Apr-18 12:43 kaiju_auth/etc.py
+-rw-r--r--  2.0 unx     3765 b- defN 23-Apr-18 12:43 kaiju_auth/fixtures.py
+-rw-r--r--  2.0 unx     5848 b- defN 23-Apr-18 12:43 kaiju_auth/http.py
+-rw-r--r--  2.0 unx     7627 b- defN 23-Apr-18 12:43 kaiju_auth/login.py
+-rw-r--r--  2.0 unx      320 b- defN 23-Apr-18 12:43 kaiju_auth/services.py
+-rw-r--r--  2.0 unx     1811 b- defN 23-Apr-18 12:43 kaiju_auth/sessions.py
+-rw-r--r--  2.0 unx     2892 b- defN 23-Apr-18 12:43 kaiju_auth/tables.py
+-rw-r--r--  2.0 unx    11513 b- defN 23-Apr-18 12:43 kaiju_auth/tokens.py
+-rw-r--r--  2.0 unx    27693 b- defN 23-Apr-18 12:43 kaiju_auth/users.py
+-rw-r--r--  2.0 unx       55 b- defN 23-Apr-18 12:43 kaiju_auth/permissions_gui/__init__.py
+-rw-r--r--  2.0 unx     3051 b- defN 23-Apr-18 12:43 kaiju_auth/permissions_gui/models.py
+-rw-r--r--  2.0 unx    17380 b- defN 23-Apr-18 12:43 kaiju_auth/permissions_gui/service.py
+-rw-r--r--  2.0 unx     1151 b- defN 23-Apr-18 12:43 kaiju_auth/permissions_gui/validators.py
+-rw-rw-rw-  2.0 unx      610 b- defN 23-Apr-18 12:44 kaiju_auth-2.0.13.dist-info/LICENSE
+-rw-r--r--  2.0 unx     2900 b- defN 23-Apr-18 12:44 kaiju_auth-2.0.13.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 23-Apr-18 12:44 kaiju_auth-2.0.13.dist-info/WHEEL
+-rw-r--r--  2.0 unx       11 b- defN 23-Apr-18 12:44 kaiju_auth-2.0.13.dist-info/top_level.txt
+-rw-rw-r--  2.0 unx     1551 b- defN 23-Apr-18 12:44 kaiju_auth-2.0.13.dist-info/RECORD
+19 files, 88431 bytes uncompressed, 20954 bytes compressed:  76.3%
```

## zipnote {}

```diff
@@ -36,23 +36,23 @@
 
 Filename: kaiju_auth/permissions_gui/service.py
 Comment: 
 
 Filename: kaiju_auth/permissions_gui/validators.py
 Comment: 
 
-Filename: kaiju_auth-2.0.12.dist-info/LICENSE
+Filename: kaiju_auth-2.0.13.dist-info/LICENSE
 Comment: 
 
-Filename: kaiju_auth-2.0.12.dist-info/METADATA
+Filename: kaiju_auth-2.0.13.dist-info/METADATA
 Comment: 
 
-Filename: kaiju_auth-2.0.12.dist-info/WHEEL
+Filename: kaiju_auth-2.0.13.dist-info/WHEEL
 Comment: 
 
-Filename: kaiju_auth-2.0.12.dist-info/top_level.txt
+Filename: kaiju_auth-2.0.13.dist-info/top_level.txt
 Comment: 
 
-Filename: kaiju_auth-2.0.12.dist-info/RECORD
+Filename: kaiju_auth-2.0.13.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## kaiju_auth/__init__.py

```diff
@@ -1,4 +1,4 @@
 from .services import *
 
-__version__ = '2.0.12'
+__version__ = '2.0.13'
 __author__ = 'antonnidhoggr@me.com'
```

## kaiju_auth/http.py

```diff
@@ -1,84 +1,114 @@
 import asyncio
+import uuid
 from random import random
+from typing import TypedDict, Optional
 
+import jwt  # noqa pycharm?
 from aiohttp import web, WSMsgType  # noqa pycharm?
 
 from kaiju_tools.rpc.etc import JSONRPCHeaders
 from kaiju_tools.rpc.services import JSONRPCServer
 from kaiju_tools.rpc.client import RPCClientService as BaseRPCClientService
 
-from kaiju_auth.tokens import JWT
 from kaiju_auth.login import AuthService, TokenInfo
 from kaiju_auth.sessions import SessionService
 
 __all__ = ['auth_middleware', 'RPCClientService']
 
 
+class _TokenInfo(TypedDict):
+    token: str
+    iat: int
+    exp: int
+    user_id: Optional[uuid.UUID]
+
+
 class RPCClientService(BaseRPCClientService):
     """RPC client with token authentication and refresh."""
 
-    dt = 120.0
-    retry_interval = 5.0
+    dt = 60.0  #: interval between a new refresh request and access expiration
+    retry_interval = 5.0  #: retries between unsuccessful refresh requests
 
     def __init__(
         self, *args, username: str = None, password: str = None, auth_service_name=AuthService.service_name, **kws
     ):
         """Initialize."""
         super().__init__(*args, **kws)
         self._auth_service_name = auth_service_name
         self._username = username
         self._password = password
-        self._access = None
-        self._refresh = None
-        self._refresh_task = None
+        self._access: Optional[_TokenInfo] = None
+        self._refresh: Optional[_TokenInfo] = None
+        self._refresh_task: Optional[asyncio.Task] = None
 
     async def init(self):
+        """Initialize."""
         await super().init()
         if self._username and self._password:
-            tokens: TokenInfo = await self.call(
-                f'{self._auth_service_name}.jwt.get', dict(username=self._username, password=self._password)
-            )
-            self._access = JWT(jwt=tokens['access'])
-            self._refresh = JWT(jwt=tokens['refresh'])
-            self._username = None
-            self._password = None
-            self._schedule_next_token_refresh()
+            await self._get_tokens()
 
     async def close(self):
+        """Close refresh tasks."""
         if self._refresh_task:
             self._refresh_task.cancel()
             self._refresh_task = None
+        await super().close()
+
+    async def _get_tokens(self):
+        """Get access and refresh tokens."""
+        while 1:
+            try:
+                tokens: TokenInfo = await self.call(
+                    f'{self._auth_service_name}.jwt.get', dict(username=self._username, password=self._password)
+                )
+            except Exception as exc:
+                self.logger.error('Token refresh error', exc_info=exc)
+                await asyncio.sleep(self.retry_interval + 1.0 * random())
+            else:
+                break
+        self._set_token_info(tokens['access'], tokens['refresh'])
+        self._schedule_next_token_refresh()
 
     async def _refresh_tokens(self):
+        """Refresh existing tokens."""
         while 1:
             try:
                 tokens: TokenInfo = await self.call(
                     f'{self._auth_service_name}.jwt.refresh',
-                    dict(access=self._access.token, refresh=self._refresh.token),
-                    raise_exception=True,
+                    dict(access=self._access['token'], refresh=self._refresh['token']),
                 )
             except Exception as exc:
-                self.logger.error('Token refresh error.', exc_info=exc)
+                self.logger.error('Token refresh error: %s', exc, exc_info=exc)
                 await asyncio.sleep(self.retry_interval + 1.0 * random())
             else:
                 break
-        self._access = JWT(jwt=tokens['access'])
-        self._refresh = JWT(jwt=tokens['refresh'])
+        self._set_token_info(tokens['access'], tokens['refresh'])
         self._schedule_next_token_refresh()
 
+    def _set_token_info(self, access: str, refresh: str) -> None:
+        """Extract token information."""
+        data = jwt.decode(access, options={'verify_signature': False})
+        self._access = _TokenInfo(token=access, iat=data['iat'], exp=data['exp'], user_id=data['data'].get('id'))
+        data = jwt.decode(refresh, options={'verify_signature': False})
+        self._refresh = _TokenInfo(token=refresh, iat=data['iat'], exp=data['exp'], user_id=data['data'].get('id'))
+
     def _schedule_next_token_refresh(self):
-        dt = max(1, self._access.claims['exp'] - self._access.claims['iat'] - self.dt)
-        loop = asyncio.get_running_loop()
-        self._refresh_task = loop.call_at(loop.time() + dt, self._refresh_tokens)
+        dt = max(1.0, self._access['exp'] - self._access['iat'] - self.dt)
+        self._refresh_task = asyncio.create_task(self._refresh_after(dt))
+
+    async def _refresh_after(self, dt: float):
+        """Call refresh task later."""
+        await asyncio.sleep(dt)
+        await self._refresh_tokens()
 
-    def _set_headers(self, headers) -> dict:
-        headers = super()._set_headers(headers)
+    def _create_request_headers(self, *args, **kws) -> dict:
+        headers = super()._create_request_headers(*args, **kws)
         if self._access:
-            headers[JSONRPCHeaders.AUTHORIZATION] = f'Bearer {self._access.token}'
+            headers[JSONRPCHeaders.AUTHORIZATION] = f'Bearer {self._access["token"]}'
         return headers
 
 
 @web.middleware
 async def auth_middleware(request: web.Request, handler):
     """Authenticate a user / init session context."""
     app = request.app
@@ -107,12 +137,12 @@
     request['session'] = session
 
     response = await handler(request)
 
     if cookie_session:
         new_session_id = response.headers.get(JSONRPCHeaders.SESSION_ID_HEADER, '')
         if session_id != new_session_id:
-            response.set_cookie(session_cookie_key, new_session_id, secure=not request.app.debug, httponly=True)
+            response.set_cookie(session_cookie_key, new_session_id, secure=not request.app.debug, httponly=True)  # noqa
         if new_session_id:
             del response.headers[JSONRPCHeaders.SESSION_ID_HEADER]
 
     return response
```

## kaiju_auth/login.py

```diff
@@ -80,15 +80,15 @@
 
     @property
     def permissions(self) -> dict:
         return {
             'login': self.PermissionKeys.GLOBAL_GUEST_PERMISSION,
             'logout': self.PermissionKeys.GLOBAL_USER_PERMISSION,
             'jwt.get': self.PermissionKeys.GLOBAL_GUEST_PERMISSION,
-            'jwt.refresh': self.PermissionKeys.GLOBAL_USER_PERMISSION,
+            'jwt.refresh': self.PermissionKeys.GLOBAL_GUEST_PERMISSION,
         }
 
     async def auth_from_auth_string(self, auth_string: str) -> Session:
         """Authenticate user from auth header or string."""
         if auth_string.startswith('Bearer '):
             return await self.token_auth(auth_string.replace('Bearer ', '', 1))
         elif auth_string.startswith('Basic '):
```

## kaiju_auth/services.py

```diff
@@ -1,7 +1,8 @@
 from .tokens import KeystoreService, JWTService
 from .sessions import SessionService
 from .login import AuthService
 from .users import PermissionService, GroupService, UserService
+from .http import RPCClientService
 from .fixtures import UserFixtureService
 
 # from .permissions_gui import UserGUIService, GroupGUIService
```

## kaiju_auth/sessions.py

```diff
@@ -1,19 +1,21 @@
 from kaiju_db.services import DatabaseService, SQLService
 from kaiju_tools.rpc.sessions import BaseSessionService
+from kaiju_tools.rpc.abc import AbstractRPCCompatible
 from kaiju_auth.tables import sessions_table
 
 __all__ = ['SessionService']
 
 
-class SessionService(BaseSessionService, SQLService):
+class SessionService(BaseSessionService, SQLService, AbstractRPCCompatible):
     """Session store base class."""
 
     table = sessions_table
     session_key = 'session:{session_id}'
+    select_columns_blacklist = {'h_agent'}
 
     def __init__(self, app, *, database_service: DatabaseService = None, logger=None, **kws):
         """Initialize.
 
         :param app:
         :param database_service:
         :param cache_service:
```

## Comparing `kaiju_auth-2.0.12.dist-info/LICENSE` & `kaiju_auth-2.0.13.dist-info/LICENSE`

 * *Files identical despite different names*

## Comparing `kaiju_auth-2.0.12.dist-info/METADATA` & `kaiju_auth-2.0.13.dist-info/METADATA`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: kaiju-auth
-Version: 2.0.12
+Version: 2.0.13
 Summary: Authentication services.
 Home-page: https://gitlab.com/kaiju-python/kaiju-auth
 Author: antonnidhoggr@me.com
 Author-email: antonnidhoggr@me.com
 License: Apache Software License 2.0
 Classifier: Development Status :: 3 - Alpha
 Classifier: License :: OSI Approved :: Apache Software License
```

