# Comparing `tmp/karrio.ups-2023.3.3-py3-none-any.whl.zip` & `tmp/karrio.ups-2023.4-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,26 +1,26 @@
-Zip file size: 28857 bytes, number of entries: 24
--rw-rw-r--  2.0 unx      527 b- defN 22-Nov-15 19:21 karrio/mappers/ups/__init__.py
--rw-rw-r--  2.0 unx     4263 b- defN 22-Nov-15 19:21 karrio/mappers/ups/mapper.py
--rw-rw-r--  2.0 unx     4960 b- defN 23-Mar-27 07:55 karrio/mappers/ups/proxy.py
--rw-rw-r--  2.0 unx      490 b- defN 22-Nov-15 19:21 karrio/mappers/ups/settings.py
+Zip file size: 29271 bytes, number of entries: 24
+-rw-rw-r--  2.0 unx      574 b- defN 23-Apr-15 10:50 karrio/mappers/ups/__init__.py
+-rw-rw-r--  2.0 unx     3992 b- defN 23-Apr-01 13:34 karrio/mappers/ups/mapper.py
+-rw-rw-r--  2.0 unx     4701 b- defN 23-Apr-10 02:51 karrio/mappers/ups/proxy.py
+-rw-rw-r--  2.0 unx      512 b- defN 23-Apr-15 06:44 karrio/mappers/ups/settings.py
 -rw-rw-r--  2.0 unx      819 b- defN 22-Nov-15 19:21 karrio/providers/ups/__init__.py
--rw-rw-r--  2.0 unx     1882 b- defN 22-Nov-15 19:21 karrio/providers/ups/address.py
--rw-rw-r--  2.0 unx     3332 b- defN 23-Mar-27 07:55 karrio/providers/ups/document.py
+-rw-rw-r--  2.0 unx     1843 b- defN 23-Apr-01 15:18 karrio/providers/ups/address.py
+-rw-rw-r--  2.0 unx     3380 b- defN 23-Apr-01 15:19 karrio/providers/ups/document.py
 -rw-rw-r--  2.0 unx     2554 b- defN 23-Mar-27 07:55 karrio/providers/ups/error.py
--rw-rw-r--  2.0 unx    15838 b- defN 23-Mar-27 07:55 karrio/providers/ups/rate.py
--rw-rw-r--  2.0 unx     4280 b- defN 23-Mar-27 22:00 karrio/providers/ups/tracking.py
--rw-rw-r--  2.0 unx    16034 b- defN 23-Mar-27 07:55 karrio/providers/ups/units.py
--rw-rw-r--  2.0 unx     2459 b- defN 23-Mar-27 07:55 karrio/providers/ups/utils.py
+-rw-rw-r--  2.0 unx    15829 b- defN 23-Apr-01 16:13 karrio/providers/ups/rate.py
+-rw-rw-r--  2.0 unx     4309 b- defN 23-Apr-01 15:19 karrio/providers/ups/tracking.py
+-rw-rw-r--  2.0 unx    16310 b- defN 23-Apr-15 10:50 karrio/providers/ups/units.py
+-rw-rw-r--  2.0 unx     2709 b- defN 23-Apr-15 10:50 karrio/providers/ups/utils.py
 -rw-rw-r--  2.0 unx      309 b- defN 22-Nov-15 19:21 karrio/providers/ups/pickup/__init__.py
--rw-rw-r--  2.0 unx     1701 b- defN 22-Nov-15 19:21 karrio/providers/ups/pickup/cancel.py
--rw-rw-r--  2.0 unx     5689 b- defN 23-Mar-27 07:55 karrio/providers/ups/pickup/create.py
--rw-rw-r--  2.0 unx     2301 b- defN 23-Mar-06 05:06 karrio/providers/ups/pickup/rate.py
--rw-rw-r--  2.0 unx     1938 b- defN 22-Nov-15 19:21 karrio/providers/ups/pickup/update.py
+-rw-rw-r--  2.0 unx     1716 b- defN 23-Apr-01 15:18 karrio/providers/ups/pickup/cancel.py
+-rw-rw-r--  2.0 unx     5693 b- defN 23-Apr-01 15:18 karrio/providers/ups/pickup/create.py
+-rw-rw-r--  2.0 unx     2285 b- defN 23-Apr-01 13:36 karrio/providers/ups/pickup/rate.py
+-rw-rw-r--  2.0 unx     1918 b- defN 23-Apr-01 13:35 karrio/providers/ups/pickup/update.py
 -rw-rw-r--  2.0 unx      222 b- defN 22-Nov-15 19:21 karrio/providers/ups/shipment/__init__.py
--rw-rw-r--  2.0 unx     2674 b- defN 23-Mar-18 11:05 karrio/providers/ups/shipment/cancel.py
--rw-rw-r--  2.0 unx    28768 b- defN 23-Mar-27 21:49 karrio/providers/ups/shipment/create.py
--rw-rw-r--  2.0 unx      951 b- defN 23-Mar-27 22:04 karrio.ups-2023.3.3.dist-info/METADATA
--rw-rw-r--  2.0 unx       92 b- defN 23-Mar-27 22:04 karrio.ups-2023.3.3.dist-info/WHEEL
--rw-rw-r--  2.0 unx        7 b- defN 23-Mar-27 22:04 karrio.ups-2023.3.3.dist-info/top_level.txt
--rw-rw-r--  2.0 unx     2119 b- defN 23-Mar-27 22:04 karrio.ups-2023.3.3.dist-info/RECORD
-24 files, 104209 bytes uncompressed, 25385 bytes compressed:  75.6%
+-rw-rw-r--  2.0 unx     2659 b- defN 23-Apr-01 15:18 karrio/providers/ups/shipment/cancel.py
+-rw-rw-r--  2.0 unx    30434 b- defN 23-Apr-18 05:38 karrio/providers/ups/shipment/create.py
+-rw-rw-r--  2.0 unx      949 b- defN 23-Apr-18 07:10 karrio.ups-2023.4.dist-info/METADATA
+-rw-rw-r--  2.0 unx       92 b- defN 23-Apr-18 07:10 karrio.ups-2023.4.dist-info/WHEEL
+-rw-rw-r--  2.0 unx        7 b- defN 23-Apr-18 07:10 karrio.ups-2023.4.dist-info/top_level.txt
+-rw-rw-r--  2.0 unx     2111 b- defN 23-Apr-18 07:10 karrio.ups-2023.4.dist-info/RECORD
+24 files, 105927 bytes uncompressed, 25815 bytes compressed:  75.6%
```

## zipnote {}

```diff
@@ -54,20 +54,20 @@
 
 Filename: karrio/providers/ups/shipment/cancel.py
 Comment: 
 
 Filename: karrio/providers/ups/shipment/create.py
 Comment: 
 
-Filename: karrio.ups-2023.3.3.dist-info/METADATA
+Filename: karrio.ups-2023.4.dist-info/METADATA
 Comment: 
 
-Filename: karrio.ups-2023.3.3.dist-info/WHEEL
+Filename: karrio.ups-2023.4.dist-info/WHEEL
 Comment: 
 
-Filename: karrio.ups-2023.3.3.dist-info/top_level.txt
+Filename: karrio.ups-2023.4.dist-info/top_level.txt
 Comment: 
 
-Filename: karrio.ups-2023.3.3.dist-info/RECORD
+Filename: karrio.ups-2023.4.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## karrio/mappers/ups/__init__.py

```diff
@@ -14,8 +14,9 @@
     Proxy=Proxy,
     Settings=Settings,
     # Data Units
     options=units.ShippingOption,
     package_presets=units.PackagePresets,
     packaging_types=units.PackagingType,
     services=units.ShippingService,
+    connection_configs=units.ConnectionConfig,
 )
```

## karrio/mappers/ups/mapper.py

```diff
@@ -38,70 +38,60 @@
     def create_cancel_pickup_request(
         self, payload: models.PickupCancelRequest
     ) -> lib.Serializable:
         return provider.pickup_cancel_request(payload, self.settings)
 
     def create_cancel_shipment_request(
         self, payload: models.ShipmentCancelRequest
-    ) -> lib.Serializable[str]:
+    ) -> lib.Serializable:
         return provider.shipment_cancel_request(payload, self.settings)
 
     def create_document_upload_request(
         self, payload: models.DocumentUploadRequest
     ) -> lib.Serializable:
         return provider.document_upload_request(payload, self.settings)
 
     def parse_address_validation_response(
         self, response: lib.Deserializable
     ) -> typing.Tuple[models.AddressValidationDetails, typing.List[models.Message]]:
-        return provider.parse_address_validation_response(
-            response.deserialize(), self.settings
-        )
+        return provider.parse_address_validation_response(response, self.settings)
 
     def parse_cancel_pickup_response(
-        self, response: lib.Deserializable[str]
+        self, response: lib.Deserializable
     ) -> typing.Tuple[models.ConfirmationDetails, typing.List[models.Message]]:
-        return provider.parse_pickup_cancel_response(
-            response.deserialize(), self.settings
-        )
+        return provider.parse_pickup_cancel_response(response, self.settings)
 
     def parse_cancel_shipment_response(
         self, response: lib.Deserializable
     ) -> typing.Tuple[models.ConfirmationDetails, typing.List[models.Message]]:
-        return provider.parse_shipment_cancel_response(
-            response.deserialize(), self.settings
-        )
+        return provider.parse_shipment_cancel_response(response, self.settings)
 
     def parse_pickup_response(
-        self, response: lib.Deserializable[str]
+        self, response: lib.Deserializable
     ) -> typing.Tuple[models.PickupDetails, typing.List[models.Message]]:
-        return provider.parse_pickup_response(response.deserialize(), self.settings)
+        return provider.parse_pickup_response(response, self.settings)
 
     def parse_pickup_update_response(
-        self, response: lib.Deserializable[str]
+        self, response: lib.Deserializable
     ) -> typing.Tuple[models.PickupDetails, typing.List[models.Message]]:
-        return provider.parse_pickup_update_response(
-            response.deserialize(), self.settings
-        )
+        return provider.parse_pickup_update_response(response, self.settings)
 
     def parse_rate_response(
-        self, response: lib.Deserializable[str]
+        self, response: lib.Deserializable
     ) -> typing.Tuple[typing.List[models.RateDetails], typing.List[models.Message]]:
-        return provider.parse_rate_response(response.deserialize(), self.settings)
+        return provider.parse_rate_response(response, self.settings)
 
     def parse_shipment_response(
-        self, response: lib.Deserializable[str]
+        self, response: lib.Deserializable
     ) -> typing.Tuple[models.ShipmentDetails, typing.List[models.Message]]:
-        return provider.parse_shipment_response(response.deserialize(), self.settings)
+        return provider.parse_shipment_response(response, self.settings)
 
     def parse_tracking_response(
-        self, response: lib.Deserializable[str]
+        self, response: lib.Deserializable
     ) -> typing.Tuple[typing.List[models.TrackingDetails], typing.List[models.Message]]:
-        return provider.parse_tracking_response(response.deserialize(), self.settings)
+        return provider.parse_tracking_response(response, self.settings)
 
     def parse_document_upload_response(
         self,
         response: lib.Deserializable,
     ) -> typing.Tuple[models.DocumentUploadDetails, typing.List[models.Message]]:
-        return provider.parse_document_upload_response(
-            response.deserialize(), self.settings
-        )
+        return provider.parse_document_upload_response(response, self.settings)
```

## karrio/mappers/ups/proxy.py

```diff
@@ -3,86 +3,73 @@
 import karrio.api.proxy as proxy
 from karrio.mappers.ups.settings import Settings
 
 
 class Proxy(proxy.Proxy):
     settings: Settings
 
-    def _send_request(self, path: str, request: lib.Serializable[typing.Any]) -> str:
+    def _send_request(self, path: str, request: lib.Serializable) -> str:
         return lib.request(
             url=f"{self.settings.server_url}{path}",
             data=request.serialize(),
             trace=self.trace_as("xml"),
             method="POST",
             headers={"Content-Type": "application/xml"},
         )
 
-    def validate_address(self, request: lib.Serializable) -> lib.Deserializable[str]:
+    def validate_address(self, request: lib.Serializable) -> lib.Deserializable:
         response = self._send_request("/webservices/AV", request)
 
         return lib.Deserializable(response, lib.to_element)
 
-    def get_rates(
-        self, request: lib.Serializable[lib.Envelope]
-    ) -> lib.Deserializable[str]:
+    def get_rates(self, request: lib.Serializable) -> lib.Deserializable:
         response = self._send_request("/webservices/Rate", request)
 
-        return lib.Deserializable(
-            (response, request.ctx),
-            lambda res: (lib.to_element(res[0]), res[1]),
-        )
+        return lib.Deserializable(response, lib.to_element, request.ctx)
 
-    def create_shipment(
-        self, request: lib.Serializable[lib.Envelope]
-    ) -> lib.Deserializable[str]:
+    def create_shipment(self, request: lib.Serializable) -> lib.Deserializable:
         response = self._send_request("/webservices/Ship", request)
 
-        return lib.Deserializable(response, lib.to_element)
+        return lib.Deserializable(response, lib.to_element, request.ctx)
 
-    def cancel_shipment(self, request: lib.Serializable) -> lib.Deserializable[str]:
+    def cancel_shipment(self, request: lib.Serializable) -> lib.Deserializable:
         response = self._send_request("/webservices/Void", request)
 
         return lib.Deserializable(response, lib.to_element)
 
-    def schedule_pickup(
-        self, request: lib.Serializable[lib.Pipeline]
-    ) -> lib.Deserializable[str]:
+    def schedule_pickup(self, request: lib.Serializable) -> lib.Deserializable:
         def process(job: lib.Job):
             if job.data is None:
                 return job.fallback
 
             return self._send_request("/webservices/Pickup", job.data)
 
         pipeline: lib.Pipeline = request.serialize()
         response = pipeline.apply(process)
         return lib.Deserializable(response, lib.to_element)
 
-    def modify_pickup(
-        self, request: lib.Serializable[lib.Pipeline]
-    ) -> lib.Deserializable[str]:
+    def modify_pickup(self, request: lib.Serializable) -> lib.Deserializable:
         def process(job: lib.Job):
             if job.data is None:
                 return job.fallback
 
             return self._send_request("/webservices/Pickup", job.data)
 
         pipeline: lib.Pipeline = request.serialize()
         response = pipeline.apply(process)
 
         return lib.Deserializable(response, lib.to_element)
 
-    def cancel_pickup(
-        self, request: lib.Serializable[lib.Envelope]
-    ) -> lib.Deserializable[str]:
+    def cancel_pickup(self, request: lib.Serializable) -> lib.Deserializable:
         response = self._send_request("/webservices/Pickup", request)
 
         return lib.Deserializable(response, lib.to_element)
 
     def get_tracking(
-        self, request: lib.Serializable[typing.List[str]]
+        self, request: lib.Serializable
     ) -> lib.Deserializable[typing.List[typing.Tuple[str, dict]]]:
         """
         get_tracking makes background requests for each tracking number
         """
 
         def _get_tracking(tracking_number: str):
             return tracking_number, lib.request(
```

## karrio/mappers/ups/settings.py

```diff
@@ -10,11 +10,12 @@
 
     username: str  # type:ignore
     password: str  # type:ignore
     access_license_number: str  # type:ignore
     account_number: str = None
     account_country_code: str = None
     metadata: dict = {}
+    config: dict = {}
 
     id: str = None
     test_mode: bool = False
     carrier_id: str = "ups"
```

## karrio/providers/ups/address.py

```diff
@@ -9,44 +9,37 @@
 from karrio.core.models import (
     AddressValidationRequest,
     Message,
     AddressValidationDetails,
 )
 from karrio.providers.ups.utils import Settings
 from karrio.providers.ups.error import parse_error_response
+import karrio.lib as lib
 
 
 def parse_address_validation_response(
-    response: Element, settings: Settings
+    _response: lib.Deserializable[Element], settings: Settings
 ) -> Tuple[AddressValidationDetails, List[Message]]:
-    status = XP.to_object(
-        Response,
-        next(
-            iter(response.xpath(".//*[local-name() = $name]", name="Response")),
-            None,
-        ),
-    )
+    response = _response.deserialize()
+    status = XP.to_object(Response, lib.find_element("Response", response, first=True))
     success = status is not None and status.ResponseStatusCode == "1"
     validation_details = (
         AddressValidationDetails(
             carrier_id=settings.carrier_id,
             carrier_name=settings.carrier_name,
             success=success,
         )
         if success
         else None
     )
 
     return validation_details, parse_error_response(response, settings)
 
 
-def address_validation_request(
-    payload: AddressValidationRequest, _
-) -> Serializable[UPSAddressValidationRequest]:
-
+def address_validation_request(payload: AddressValidationRequest, _) -> Serializable:
     request = UPSAddressValidationRequest(
         Request=RequestType(
             TransactionReference=None,
             RequestAction="AV",
         ),
         Address=AddressType(
             City=payload.address.city,
@@ -56,9 +49,8 @@
         ),
     )
 
     return Serializable(request, _request_serializer)
 
 
 def _request_serializer(request: UPSAddressValidationRequest) -> str:
-
     return XP.export(request, namespacedef_='xml:lang="en-US"')
```

## karrio/providers/ups/document.py

```diff
@@ -7,17 +7,18 @@
 import karrio.core.models as models
 import karrio.providers.ups.error as error
 import karrio.providers.ups.units as provider_units
 import karrio.providers.ups.utils as provider_utils
 
 
 def parse_document_upload_response(
-    responses: typing.List[typing.Tuple[str, dict]],
+    _responses: lib.Deserializable[typing.List[typing.Tuple[str, dict]]],
     settings: provider_utils.Settings,
 ) -> typing.Tuple[models.DocumentUploadDetails, typing.List[models.Message]]:
+    responses = _responses.deserialize()
     raw_documents = [
         (name, result["UploadResponse"]["FormsHistoryDocumentID"])
         for name, result in responses
         if (
             "Fault" not in result
             and "UploadResponse" in result
             and result["UploadResponse"].get("FormsHistoryDocumentID") is not None
@@ -55,15 +56,15 @@
         meta=dict(),
     )
 
 
 def document_upload_request(
     payload: models.DocumentUploadRequest,
     settings: provider_utils.Settings,
-) -> lib.Serializable[lib.Envelope]:
+) -> lib.Serializable:
     document_files = lib.to_document_files(payload.document_files)
     options = lib.to_upload_options(payload.options)
 
     request = [
         ups.DocumentUploadRequestType(
             UPSSecurity=ups.UPSSecurityType(
                 UsernameToken=ups.UsernameTokenType(
```

## karrio/providers/ups/rate.py

```diff
@@ -1,26 +1,25 @@
 import ups_lib.rate_web_service_schema as ups
 import time
 import typing
-import functools
 import karrio.lib as lib
 import karrio.core.models as models
 import karrio.providers.ups.error as provider_error
 import karrio.providers.ups.units as provider_units
 import karrio.providers.ups.utils as provider_utils
 
 
 def parse_rate_response(
-    result: typing.Tuple[lib.Element, dict],
+    _response: lib.Deserializable[lib.Element],
     settings: provider_utils.Settings,
 ) -> typing.Tuple[typing.List[models.RateDetails], typing.List[models.Message]]:
-    response, ctx = result
+    response = _response.deserialize()
     messages = provider_error.parse_error_response(response, settings)
     rates = [
-        _extract_details(node, settings, ctx)
+        _extract_details(node, settings, _response.ctx)
         for node in lib.find_element("RatedShipment", response)
     ]
 
     return rates, messages
 
 
 def _extract_details(
@@ -88,15 +87,15 @@
         meta=dict(service_name=service.name_or_key),
     )
 
 
 def rate_request(
     payload: models.RateRequest,
     settings: provider_utils.Settings,
-) -> lib.Serializable[ups.RateRequest]:
+) -> lib.Serializable:
     shipper = lib.to_address(payload.shipper)
     recipient = lib.to_address(payload.recipient)
     packages = lib.to_packages(payload.parcels, provider_units.PackagePresets)
     is_document = all([parcel.is_document for parcel in payload.parcels])
     service = lib.to_services(payload.services, provider_units.ServiceCode).first
     options = lib.to_shipping_options(
         payload.options,
```

## karrio/providers/ups/tracking.py

```diff
@@ -4,17 +4,18 @@
 import karrio.core.models as models
 import karrio.providers.ups.error as error
 import karrio.providers.ups.utils as provider_utils
 import karrio.providers.ups.units as provider_units
 
 
 def parse_tracking_response(
-    responses: typing.List[typing.Tuple[str, dict]],
+    _responses: lib.Deserializable[typing.List[typing.Tuple[str, dict]]],
     settings: provider_utils.Settings,
 ) -> typing.Tuple[typing.List[models.TrackingDetails], typing.List[models.Message]]:
+    responses = _responses.deserialize()
     packages = [
         result["trackResponse"]["shipment"][0]
         for _, result in responses
         if "trackResponse" in result
         and result["trackResponse"]["shipment"][0].get("package") is not None
     ]
     messages: typing.List[models.Message] = error.parse_rest_error_response(
@@ -88,24 +89,22 @@
             package_weight_unit=getattr(package.weight, "unitOfMeasurement", None),
             shipment_origin_country=(
                 getattr(origin.address, "country", None) if origin else None
             ),
             shipment_origin_postal_code=(
                 getattr(origin.address, "postalCode", None) if origin else None
             ),
-            shipment_destication_country=(
+            shipment_destination_country=(
                 getattr(destination.address, "country", None) if origin else None
             ),
             shipment_destination_postal_code=(
                 getattr(destination.address, "postalCode", None) if origin else None
             ),
             customer_name=(
                 destination.attentionName or destination.name if destination else None
             ),
         ),
     )
 
 
-def tracking_request(
-    payload: models.TrackingRequest, _
-) -> lib.Serializable[typing.List[lib.Envelope]]:
+def tracking_request(payload: models.TrackingRequest, _) -> lib.Serializable:
     return lib.Serializable(payload.tracking_numbers)
```

## karrio/providers/ups/units.py

```diff
@@ -105,14 +105,21 @@
     tube = ups_tube
     pallet = ups_pallet
     small_box = ups_small_express_box
     medium_box = ups_medium_express_box
     your_packaging = ups_customer_supplied_package
 
 
+class ConnectionConfig(utils.Enum):
+    label_type = utils.OptionEnum("label_type")
+    enforce_zpl = utils.OptionEnum("enforce_zpl", bool)
+    shipping_options = utils.OptionEnum("shipping_options", list)
+    shipping_services = utils.OptionEnum("shipping_services", list)
+
+
 class ServiceCode(utils.Enum):
     ups_express = "07"
     ups_standard = "11"
     ups_worldwide_expedited = "08"
     ups_worldwide_express_plus = "54"
     ups_worldwide_saver = "65"
```

## karrio/providers/ups/utils.py

```diff
@@ -10,14 +10,15 @@
 
     username: str
     password: str
     access_license_number: str
     account_number: str = None
     account_country_code: str = None
     metadata: dict = {}
+    config: dict = {}
 
     id: str = None
 
     @property
     def carrier_name(self):
         return "ups"
 
@@ -39,24 +40,31 @@
                 AccessLicenseNumber=self.access_license_number
             ),
         )
 
     @property
     def default_currency(self) -> typing.Optional[str]:
         if self.account_country_code in SUPPORTED_COUNTRY_CURRENCY:
-            return units.CountryCurrency.map(
-                self.account_country_code
-            ).value
+            return units.CountryCurrency.map(self.account_country_code).value
 
         return "USD"
 
     @property
     def tracking_url(self):
         return "https://www.ups.com/track?loc=en_US&requester=QUIC&tracknum={}/trackdetails"
 
+    @property
+    def connection_config(self) -> lib.units.Options:
+        from karrio.providers.ups.units import ConnectionConfig
+
+        return lib.to_connection_config(
+            self.config or {},
+            option_type=ConnectionConfig,
+        )
+
 
 def default_request_serializer(
     prefix: str,
     namespace: str,
 ) -> typing.Callable[[lib.Envelope], str]:
     def serializer(envelope: lib.Envelope):
         namespace_ = (
```

## karrio/providers/ups/pickup/cancel.py

```diff
@@ -8,25 +8,25 @@
 from karrio.core.models import (
     PickupCancelRequest,
     ConfirmationDetails,
     Message,
 )
 from karrio.providers.ups.utils import Settings, default_request_serializer
 from karrio.providers.ups.error import parse_error_response
+import karrio.lib as lib
 
 
 def parse_pickup_cancel_response(
-    response: Element, settings: Settings
+    _response: lib.Deserializable[Element],
+    settings: Settings,
 ) -> Tuple[ConfirmationDetails, List[Message]]:
+    response = _response.deserialize()
     status = XP.to_object(
         CodeDescriptionType,
-        next(
-            iter(response.xpath(".//*[local-name() = $name]", name="ResponseStatus")),
-            None,
-        ),
+        lib.find_element("ResponseStatus", response, first=True),
     )
     success = status is not None and status.Code == "1"
     cancellation = (
         ConfirmationDetails(
             carrier_id=settings.carrier_id,
             carrier_name=settings.carrier_name,
             success=success,
@@ -37,16 +37,15 @@
     )
 
     return cancellation, parse_error_response(response, settings)
 
 
 def pickup_cancel_request(
     payload: PickupCancelRequest, settings: Settings
-) -> Serializable[Envelope]:
-
+) -> Serializable:
     request = create_envelope(
         header_content=settings.Security,
         body_content=UPSPickupCancelRequest(
             Request=RequestType(), CancelBy="02", PRN=payload.confirmation_number
         ),
     )
```

## karrio/providers/ups/pickup/create.py

```diff
@@ -12,15 +12,14 @@
     RateResultType,
     AccountType,
 )
 from karrio.core.units import Packages
 from karrio.core.utils import (
     Serializable,
     create_envelope,
-    Envelope,
     Element,
     Job,
     Pipeline,
     NF,
     XP,
     DF,
     SF,
@@ -35,16 +34,17 @@
 from karrio.providers.ups.pickup.rate import pickup_rate_request
 from karrio.providers.ups.error import parse_error_response
 from karrio.providers.ups.units import PackagePresets, WeightUnit
 from karrio.providers.ups.utils import Settings, default_request_serializer
 
 
 def parse_pickup_response(
-    response: Element, settings: Settings
+    _response: lib.Deserializable[Element], settings: Settings
 ) -> Tuple[PickupDetails, List[Message]]:
+    response = _response.deserialize()
     reply = XP.find(
         "PickupCreationResponse", response, PickupCreationResponse, first=True
     )
 
     pickup = (
         _extract_pickup_details(response, settings)
         if reply is not None and reply.PRN is not None
@@ -68,36 +68,32 @@
             name=rate.RateType,
             currency=rate.CurrencyCode,
             amount=NF.decimal(rate.GrandTotalOfAllCharge),
         ),
     )
 
 
-def pickup_request(
-    payload: PickupRequest, settings: Settings
-) -> Serializable[Pipeline]:
+def pickup_request(payload: PickupRequest, settings: Settings) -> Serializable:
     """
     Create a pickup request
     Steps
         1 - rate pickup
         2 - create pickup
     :param payload: PickupRequest
     :param settings: Settings
-    :return: Serializable[Pipeline]
+    :return: Serializable
     """
     request: Pipeline = Pipeline(
         rate=lambda *_: _rate_pickup(payload=payload, settings=settings),
         create=partial(_create_pickup, payload=payload, settings=settings),
     )
     return Serializable(request)
 
 
-def _create_pickup_request(
-    payload: PickupRequest, settings: Settings
-) -> Serializable[Envelope]:
+def _create_pickup_request(payload: PickupRequest, settings: Settings) -> Serializable:
     address = lib.to_address(payload.address)
     packages = Packages(payload.parcels, PackagePresets)
     has_overweight = any(package for package in packages if package.weight.KG > 32)
 
     request = create_envelope(
         header_content=settings.Security,
         body_content=PickupCreationRequest(
```

## karrio/providers/ups/pickup/rate.py

```diff
@@ -13,17 +13,15 @@
     DF,
     SF,
 )
 from karrio.core.models import PickupRequest
 from karrio.providers.ups.utils import Settings, default_request_serializer
 
 
-def pickup_rate_request(
-    payload: PickupRequest, settings: Settings
-) -> Serializable[Envelope]:
+def pickup_rate_request(payload: PickupRequest, settings: Settings) -> Serializable:
     pickup_date = DF.date(payload.pickup_date)
     same_day = pickup_date.date() == datetime.today().date()
 
     request = create_envelope(
         header_content=settings.Security,
         body_content=PickupRateRequest(
             Request=RequestType(),
```

## karrio/providers/ups/pickup/update.py

```diff
@@ -16,24 +16,24 @@
 from karrio.providers.ups.pickup.cancel import pickup_cancel_request
 
 parse_pickup_update_response = parse_pickup_response
 
 
 def pickup_update_request(
     payload: PickupUpdateRequest, settings: Settings
-) -> Serializable[Pipeline]:
+) -> Serializable:
     """
     Create a pickup request
     Steps
         1 - rate pickup
         2 - create pickup
         3 - cancel old pickup
     :param payload: PickupUpdateRequest
     :param settings: Settings
-    :return: Serializable[Pipeline]
+    :return: Serializable
     """
     request: Pipeline = Pipeline(
         rate=lambda *_: _rate_pickup(
             payload=cast(PickupRequest, payload), settings=settings
         ),
         create=partial(_create_pickup, payload=payload, settings=settings),
         cancel=partial(_cancel_pickup_request, payload=payload, settings=settings),
```

## karrio/providers/ups/shipment/cancel.py

```diff
@@ -13,22 +13,20 @@
 )
 from karrio.providers.ups.utils import Settings, default_request_serializer
 from karrio.providers.ups.error import parse_error_response
 import karrio.lib as lib
 
 
 def parse_shipment_cancel_response(
-    response: Element, settings: Settings
+    _response: lib.Deserializable[Element], settings: Settings
 ) -> Tuple[ConfirmationDetails, List[Message]]:
+    response = _response.deserialize()
     status = XP.to_object(
         CodeDescriptionType,
-        next(
-            iter(response.xpath(".//*[local-name() = $name]", name="ResponseStatus")),
-            None,
-        ),
+        lib.find_element("ResponseStatus", response, first=True),
     )
     success = status is not None and status.Code == "1"
     cancellation = (
         ConfirmationDetails(
             carrier_id=settings.carrier_id,
             carrier_name=settings.carrier_name,
             success=success,
@@ -39,16 +37,15 @@
     )
 
     return cancellation, parse_error_response(response, settings)
 
 
 def shipment_cancel_request(
     payload: ShipmentCancelRequest, settings: Settings
-) -> Serializable[Envelope]:
-
+) -> Serializable:
     request = create_envelope(
         header_content=settings.Security,
         body_content=VoidShipmentRequest(
             Request=common.RequestType(
                 TransactionReference=common.TransactionReferenceType(
                     CustomerContext=payload.shipment_identifier,
                 ),
```

## karrio/providers/ups/shipment/create.py

```diff
@@ -7,34 +7,61 @@
 import karrio.core.models as models
 import karrio.providers.ups.error as provider_error
 import karrio.providers.ups.units as provider_units
 import karrio.providers.ups.utils as provider_utils
 
 
 def parse_shipment_response(
-    response: lib.Element, settings: provider_utils.Settings
+    _response: lib.Deserializable[lib.Element],
+    settings: provider_utils.Settings,
 ) -> typing.Tuple[models.ShipmentDetails, typing.List[models.Message]]:
+    response = _response.deserialize()
     details = lib.find_element("ShipmentResults", response, first=True)
-    shipment = _extract_shipment(details, settings) if details is not None else None
+    shipment = (
+        _extract_shipment(details, settings, _response.ctx)
+        if details is not None
+        else None
+    )
 
     return shipment, provider_error.parse_error_response(response, settings)
 
 
 def _extract_shipment(
-    node: lib.Element, settings: provider_utils.Settings
+    node: lib.Element,
+    settings: provider_utils.Settings,
+    ctx: dict,
 ) -> models.ShipmentDetails:
+    label_type = "ZPL" if ctx["label"]["type"] == "ZPL" else "PDF"
+    enforce_zpl = settings.connection_config.enforce_zpl.state
     shipment = lib.to_object(ups.ShipmentResultsType, node)
     label = _process_label(shipment)
+    zpl_label = None
+
+    if enforce_zpl and label_type == "PDF":
+        _label = lib.failsafe(
+            lambda: lib.zpl_to_pdf(
+                label,
+                ctx["label"]["width"],
+                ctx["label"]["height"],
+                dpmm=8,
+            )
+        )
+        zpl_label = label  # save the original label
+
+        # if the conversion fails, use the original label and label type.
+        label = _label or label
+        label_type = "ZPL" if _label is None else label_type
 
     return models.ShipmentDetails(
         carrier_name=settings.carrier_name,
         carrier_id=settings.carrier_id,
         tracking_number=shipment.ShipmentIdentificationNumber,
         shipment_identifier=shipment.ShipmentIdentificationNumber,
-        docs=models.Documents(label=label),
+        label_type=label_type,
+        docs=models.Documents(label=label, zpl_label=zpl_label),
         meta=dict(
             carrier_tracking_link=settings.tracking_url.format(
                 shipment.ShipmentIdentificationNumber
             ),
         ),
     )
 
@@ -43,28 +70,32 @@
     label_type = (
         "ZPL"
         if "ZPL" in shipment.PackageResults[0].ShippingLabel.ImageFormat.Code
         else "PDF"
     )
     labels = [
         (
-            lib.image_to_pdf(pkg.ShippingLabel.GraphicImage, rotate=-90)
+            lib.image_to_pdf(
+                pkg.ShippingLabel.GraphicImage,
+                rotate=-90,
+                resize=dict(height=1800, width=1200),
+            )
             if label_type == "PDF"
             else pkg.ShippingLabel.GraphicImage
         )
         for pkg in shipment.PackageResults
     ]
 
     return labels[0] if len(labels) == 1 else lib.bundle_base64(labels, label_type)
 
 
 def shipment_request(
     payload: models.ShipmentRequest,
     settings: provider_utils.Settings,
-) -> lib.Serializable[ups.ShipmentRequest]:
+) -> lib.Serializable:
     shipper = lib.to_address(payload.shipper)
     recipient = lib.to_address(payload.recipient)
     packages = lib.to_packages(
         payload.parcels,
         provider_units.PackagePresets,
         package_option_type=provider_units.ShippingOption,
     )
@@ -103,16 +134,19 @@
             ("01", payment, biling_address),
             ("02", customs.duty, duty_billing_address),
         ]
     )
     mps_packaging = (
         provider_units.PackagingType.your_packaging.value if len(packages) > 1 else None
     )
+    enforce_zpl = settings.connection_config.enforce_zpl.state
     label_format, label_height, label_width = (
-        provider_units.LabelType.map(payload.label_type).value
+        provider_units.LabelType.map(
+            payload.label_type or settings.connection_config.label_type.state
+        ).value
         or provider_units.LabelType.PDF_6x4.value
     )
 
     request = lib.Envelope(
         Header=lib.Header(
             settings.Security,
         ),
@@ -352,29 +386,35 @@
                                                 or "000-000-0000"
                                             ),
                                             Option=None,
                                             Address=ups.AddressType(
                                                 AddressLine=recipient.address_lines,
                                                 City=recipient.city,
                                                 StateProvinceCode=recipient.state_code,
-                                                PostalCode=recipient.postal_code,
+                                                PostalCode=lib.text(
+                                                    (
+                                                        recipient.postal_code or ""
+                                                    ).replace("-", "")
+                                                ),
                                                 CountryCode=recipient.country_code,
                                             ),
                                             EMailAddress=recipient.email,
                                         ),
                                     )
                                     if not options.paperless_trade.state
                                     else None
                                 ),
                                 Product=[
                                     ups.ProductType(
-                                        Description=lib.join(
-                                            item.title,
-                                            item.description,
-                                        ),
+                                        Description=[
+                                            lib.text(
+                                                item.title or item.description,
+                                                max=35,
+                                            )
+                                        ],
                                         Unit=ups.UnitType(
                                             Number=str(item.quantity),
                                             UnitOfMeasurement=ups.UnitOfMeasurementType(
                                                 Code="PCS"
                                             ),
                                             Value=item.value_amount,
                                         ),
@@ -407,15 +447,16 @@
                                         PackingListInfo=None,
                                         EEIInformation=None,
                                     )
                                     for idx, item in enumerate(customs.commodities)
                                 ],
                                 InvoiceNumber=customs.invoice,
                                 InvoiceDate=lib.fdatetime(
-                                    customs.invoice_date or time.strftime("%Y-%m-%d", time.localtime()),
+                                    customs.invoice_date
+                                    or time.strftime("%Y-%m-%d", time.localtime()),
                                     current_format="%Y-%m-%d",
                                     output_format="%Y%m%d",
                                 ),
                                 PurchaseOrderNumber=None,
                                 TermsOfShipment=provider_units.Incoterm.map(
                                     customs.incoterm
                                 ).name,
@@ -544,15 +585,17 @@
                                 Weight=package.weight.value,
                             ),
                         )
                         for package in packages
                     ],
                 ),
                 LabelSpecification=ups.LabelSpecificationType(
-                    LabelImageFormat=ups.LabelImageFormatType(Code=label_format),
+                    LabelImageFormat=ups.LabelImageFormatType(
+                        Code="ZPL" if enforce_zpl else label_format
+                    ),
                     HTTPUserAgent=None,
                     LabelStockSize=ups.LabelStockSizeType(
                         Height=label_height,
                         Width=label_width,
                     ),
                     Instruction=None,
                     CharacterSet=None,
@@ -581,8 +624,15 @@
                 Request="common",
                 Envelope="soapenv",
                 UPSSecurity="upss",
                 ShipmentRequest="ship",
                 InternationalForms_children="ifs",
             ),
         ),
+        dict(
+            label=dict(
+                height=label_height,
+                width=label_width,
+                type=label_format,
+            ),
+        ),
     )
```

## Comparing `karrio.ups-2023.3.3.dist-info/METADATA` & `karrio.ups-2023.4.dist-info/METADATA`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: karrio.ups
-Version: 2023.3.3
+Version: 2023.4
 Summary: Karrio - UPS Shipping extension
 Home-page: https://github.com/karrioapi/karrio
 Author: karrio
 Author-email: hello@karrio.io
 License: Apache-2.0
 Platform: UNKNOWN
 Classifier: Intended Audience :: Developers
```

## Comparing `karrio.ups-2023.3.3.dist-info/RECORD` & `karrio.ups-2023.4.dist-info/RECORD`

 * *Files 12% similar despite different names*

```diff
@@ -1,24 +1,24 @@
-karrio/mappers/ups/__init__.py,sha256=XTLwkg377SUQXQc0gxYeOSghUZ-sDxTUEFV4eNfL0fw,527
-karrio/mappers/ups/mapper.py,sha256=Pg_xK-ECiksB8-D6o6ADOQWQPPe4avqmDNCbatQj__o,4263
-karrio/mappers/ups/proxy.py,sha256=HcH3rICueCLZMeKkUMwaYjX1840dBZuOft5J-nLGm9k,4960
-karrio/mappers/ups/settings.py,sha256=ieXg3P443F1TPfe3EAg2-xcWT_GN9TTmdrkaVYuY-3M,490
+karrio/mappers/ups/__init__.py,sha256=ZteJt7U1jX4n6ww0siNnQLgdcwyLFa2SN2l76MGUkss,574
+karrio/mappers/ups/mapper.py,sha256=RdErHLGUGNYRqFc88z5EgNcqfExXiS50sFutHNb0p4Q,3992
+karrio/mappers/ups/proxy.py,sha256=tO3xLoTJAWUDmmCVBu4D1ybxt-785fcCR62PUJ_0vFs,4701
+karrio/mappers/ups/settings.py,sha256=AMtkmHE_jOQt_7YsPmvooI0RG5SY37P7JWQZeLa74jU,512
 karrio/providers/ups/__init__.py,sha256=iEPJP_IDlokgr2Iblzpqs_p9fVN24fbzZ3zaSpYxkAM,819
-karrio/providers/ups/address.py,sha256=MSQ7-WIkApbmzDlQPG94ort6oGkttMuimtWwyHOGgos,1882
-karrio/providers/ups/document.py,sha256=4ysf9cy8WjNd8_zLErJQmYHpYF3JN4a8KstGYKYFgSI,3332
+karrio/providers/ups/address.py,sha256=p33FMkMqyRT3a5Qeh0b8MqreOqNu5A_zQS_6wSsJ_D8,1843
+karrio/providers/ups/document.py,sha256=l7tu0hr4DpcOArApAS8OS2Y-hVs75nEHqhlR_TpwHaI,3380
 karrio/providers/ups/error.py,sha256=kyZJF875o9LSvzDd2iGDZJVRfqYg-AANLfsm1_QdY4w,2554
-karrio/providers/ups/rate.py,sha256=bCxJKP6Tm8ygwD6TeQv-yeQgSQ8dVhMqm_-nwUI9jHM,15838
-karrio/providers/ups/tracking.py,sha256=XMWrkdno6gEDkWIDegY_1c_LbE3E8OYjVEmC2RWWZFc,4280
-karrio/providers/ups/units.py,sha256=1F6zOyQLGXxpnowTXvQEVfIRiRyeNg-aURTqlGRKKLI,16034
-karrio/providers/ups/utils.py,sha256=AV-CLszJI5XWLkmxZD-Y_uzMA1tu28oBVlrkq1kdBbg,2459
+karrio/providers/ups/rate.py,sha256=uvRSRwNcOVuTDk8j4_kCbcJiuuB_NG7OU46CaFk02iA,15829
+karrio/providers/ups/tracking.py,sha256=HhWHT_JNUzjEz-eQLfSWssRHasNkzlAFqVvRPy56itc,4309
+karrio/providers/ups/units.py,sha256=bgkkk7gQUiDA-rr2GdN83awCZfKJ25AeTUw4r_MZmlc,16310
+karrio/providers/ups/utils.py,sha256=wBRr2eh_wfSmvGff8j-shahetdfYbx-1fLaSSh9Y3E8,2709
 karrio/providers/ups/pickup/__init__.py,sha256=StpeV_vjUTo7Cn5RhZ_FHiEiY8xhf6LcFU0ppAaKrzY,309
-karrio/providers/ups/pickup/cancel.py,sha256=rVrCsyoxd55okI7gCgIfzUzZ-70i9zdtIa2P2WKvE8U,1701
-karrio/providers/ups/pickup/create.py,sha256=XRvi3sf-ozzN9Ys5eBw_FhQzFWz8uDxBBBGYHVj-3d8,5689
-karrio/providers/ups/pickup/rate.py,sha256=E7i1sKoTUFLG3ku6Uf1RhIGpIIhqQY05RqOVcVpNxPA,2301
-karrio/providers/ups/pickup/update.py,sha256=APpohTVn-Jj8C4qr6E2Lpp-gEaVzhHFQ0f85LYlGDlY,1938
+karrio/providers/ups/pickup/cancel.py,sha256=OuECyxmV3JBPcJt6yfvFkSMWUHTIPD8oeUUpB2XwUFM,1716
+karrio/providers/ups/pickup/create.py,sha256=pEBJGkBsZX-Kbr2p8iVT8hBKSr52w6Mm0d6PKID_Bdg,5693
+karrio/providers/ups/pickup/rate.py,sha256=YF-bm3EzzJMyfTq3i2dyAb9PuuXK-yyjdW8brqGT0Ow,2285
+karrio/providers/ups/pickup/update.py,sha256=kSYEOw5k42cqGKqC_oQPTAOJzoGJ6AajYFuz6UiVR84,1918
 karrio/providers/ups/shipment/__init__.py,sha256=JqRkKBAx-8wJ3_RSvWD76ink2bX2N3LRi132oNB76xk,222
-karrio/providers/ups/shipment/cancel.py,sha256=Esb_NsOqbX8XHhKjMn1S3nJcjZs_kxspm7eoW7p8cTk,2674
-karrio/providers/ups/shipment/create.py,sha256=JClb8hZSCFF5hvpc9Q2VaZggfdsne1wUoTlAd-G3HRw,28768
-karrio.ups-2023.3.3.dist-info/METADATA,sha256=IRFpZ4NOytZ-37ig4e6kKILv8pPR53ovjBKuCh-X8gU,951
-karrio.ups-2023.3.3.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
-karrio.ups-2023.3.3.dist-info/top_level.txt,sha256=mfkVZXzNuVRmA7NRlck_Ub-C8Zgtqxbx3gX1Rq_W-i0,7
-karrio.ups-2023.3.3.dist-info/RECORD,,
+karrio/providers/ups/shipment/cancel.py,sha256=3hmkDCHRRXvSSo13jVHKnh6fx2LBNBzsyjcUbo5qJcY,2659
+karrio/providers/ups/shipment/create.py,sha256=FCC7EuVB8FELKNQXBly-YPZWmXyd3FGERniXfNybfFs,30434
+karrio.ups-2023.4.dist-info/METADATA,sha256=wkR3i5bfZ4f_dC9BbQOHXm-_Q8EJ-dkMQ2GSsuHlIVc,949
+karrio.ups-2023.4.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
+karrio.ups-2023.4.dist-info/top_level.txt,sha256=mfkVZXzNuVRmA7NRlck_Ub-C8Zgtqxbx3gX1Rq_W-i0,7
+karrio.ups-2023.4.dist-info/RECORD,,
```

